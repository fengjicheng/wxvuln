> **原文链接**: https://mp.weixin.qq.com/s?__biz=MzI5NDg0ODkwMQ==&mid=2247486434&idx=1&sn=8040adbbbc974283715c9b1c7244e751

#  Windows应急响应“拆弹指南”：深入排查潜伏在系统启动项中的“定时炸弹”  
原创 网安布道师  格格巫和蓝精灵   2025-06-26 04:30  
  
#   
#   
> 大家好，我是你们的技术探险家！  
> 想象一下，你刚刚经历了一场惊心动魄的应急响应，成功清除了正在内存中活动的恶意软件。你松了一口气，准备重启服务器恢复业务。但，你真的“赢”了吗？  
> 重启的那一刻，可能正是攻击者预设的“胜利之时”。如果他们在此前已经悄悄地在系统的某个角落埋下了一颗“定时炸弹”——一个恶意的自启动项，那么所有的努力都可能付诸东流。  
> 今天，我们就化身“拆弹专家”，带上最精良的工具，深入 Windows 系统的每一个角落，学习如何排查并拆除那些由攻击者精心布置的、用于**持久化控制 (Persistence)**  
 的启动项后门。  
  
## 💣 第一章：经典藏匿点 - 攻击者最爱的“常规”启动项  
  
这些是攻击者最常用，也是我们最先应该检查的地方。它们就像是“藏在花盆底下”的备用钥匙，虽然老套，但非常有效。  
### 1. “启动”文件夹 (Startup Folders)  
- **是什么**  
：这是 Windows 提供的最直观的自启动方式。只要将一个程序的快捷方式或其本身放入特定的“启动”文件夹，用户登录时它就会自动运行。  
  
- **排查路径**  
:  
  
- **当前用户**  
: 
```
C:\Users\[用户名]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

  
 (或在运行中输入 
```
shell:startup
```

  
)  
  
- **所有用户**  
: 
```
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
```

  
 (或在运行中输入 
```
shell:common startup
```

  
)  
  
- **检查要点**  
: 查看这两个文件夹中是否存在不认识的、可疑的脚本(
```
.bat
```

  
, 
```
.vbs
```

  
, 
```
.ps1
```

  
)或可执行文件(
```
.exe
```

  
)。  
  
### 2. 注册表的“Run”系列键值  
- **是什么**  
: 这是最臭名昭著的持久化“大本营”。攻击者只需在特定的注册表位置创建一个键值，指向他们的恶意程序，即可实现开机或登录自启。  
  
- **排查路径 (使用 regedit.exe)**  
:  
  
- 
```
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
```

  
  
- 
```
HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

  
  
- 
```
HKLM\Software\Microsoft\Windows\CurrentVersion\Run
```

  
  
- 
```
HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

  
  
- 
```
HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run
```

  
 (策略强制运行)  
  
- **检查要点**  
: 仔细检查这些路径下的每一个键值。值的数据是否指向一个位于可疑目录（如 
```
%TEMP%
```

  
, 
```
C:\Users\Public
```

  
）的程序？值名是否伪装成了正常软件（如 
```
RealtekHD
```

  
, 
```
AdobeUpdate
```

  
）？  
  
## ⚙️ 第二章：系统的心跳 - 服务与计划任务中的持久化  
  
如果说“Run”键是开门迎客，那么服务和计划任务则是让恶意软件像“水电煤”一样，成为系统基础设施的一部分，实现更高权限、更稳定的运行。  
### 1. 恶意服务 (Malicious Services)  
- **攻击手法**  
: 攻击者将恶意程序注册为一个 Windows 服务，并将其启动类型设置为“自动”。这样，恶意软件就能在开机时、甚至在用户登录前，以高权限（通常是 
```
SYSTEM
```

  
）在后台悄悄运行。  
  
- **排查要点 (使用 services.msc 或 sc query)**  
:  
  
- **可疑的服务名称**  
: 名称是随机字符串 (
```
asdhjkasd
```

  
) 或模仿正常服务名 (
```
MicrosoftUpdateSvc
```

  
)。  
  
- **空缺的描述**  
: 正常的服务通常都有详细的描述，而恶意服务往往是空的。  
  
- **可执行文件路径**  
: 服务的“可执行文件路径”指向了非系统目录（如 
```
C:\Windows\Temp\svc.exe
```

  
）。  
  
- **恢复选项**  
: 攻击者可能会将服务的“恢复”选项设置为“重新启动服务”，确保即使被杀死也能“复活”。  
  
### 2. 内核级的幽灵：驱动程序服务 (Rootkit)  
  
这是最高阶、最危险的持久化技术之一。  
- **攻击手法**  
: 攻击者将其恶意代码编译成一个驱动程序 (
```
.sys
```

  
 文件)，并将其注册为一个在系统启动时加载的**内核模式驱动服务**  
。  
  
- **危险性**  
:  
  
- **最高权限 (Ring 0)**  
: 驱动运行在操作系统的内核空间，拥有最高权限，可以为所欲为。  
  
- **终极隐蔽**  
: 内核级的恶意软件（即 Rootkit）可以**钩取 (Hook)**  
 操作系统底层函数，从而向用户层的所有工具（包括任务管理器、文件资源管理器，甚至一些杀毒软件）隐藏其自身的文件、进程、网络连接和注册表项，做到“来无影，去无踪”。  
  
- **排查要点**  
:  
  
- **数字签名**  
: 现代 64 位 Windows 强制要求驱动程序必须拥有有效的数字签名。因此，在排查中，一个**没有签名**  
或**签名无效/不受信任**  
的驱动程序是**极度可疑**  
的。攻击者可能会使用窃取来的合法证书签名，或者利用其他已签名驱动的漏洞来加载自己的恶意驱动。  
  
- **Sysmon 监控**  
: **Sysmon Event ID 6 (Driver Loaded)**  
 会记录下系统中加载的所有驱动程序。在 SIEM 中监控这个事件，特别是寻找那些没有微软签名、或从非标准路径 (
```
C:\Windows\System32\drivers
```

  
) 加载的驱动，是发现内核级后门的关键。  
  
- **Autoruns**  
: 这是发现恶意驱动最有效的工具，我们将在第四章详述。  
  
### 3. 恶意的计划任务 (Scheduled Tasks)  
- **攻击手法**  
: 这是比服务更灵活、更受攻击者青睐的方式。他们可以创建一个计划任务，在特定时间、用户登录时、系统启动时，甚至在发生某个特定系统事件时触发恶意脚本或程序。  
  
- **排查要点 (使用 taskschd.msc 或 schtasks /query)**  
:  
  
- **可疑的任务名与位置**  
: 检查是否有不认识的任务，尤其注意那些没有分类、直接放在根目录下的任务。  
  
- **触发器 (Triggers)**  
: 任务的触发条件是什么？  
  
- **操作 (Actions)**  
: 任务执行的操作是什么？是否启动了一个 powershell.exe 并跟了一长串 
```
-enc
```

  
 的 Base64 编码命令？  
  
- **运行权限**  
: 任务是否被配置为以 
```
SYSTEM
```

  
 最高权限运行？  
  
## 👻 第三章：高手的“诡计” - 更隐蔽的启动技术  
  
经验丰富的攻击者会使用更深、更冷门的持久化技术，以绕过常规的检查。  
- **WMI 事件订阅 (WMI Event Subscription)**  
: 一种“无文件”的持久化方式。攻击者可以创建一个永久 WMI 事件订阅，当某个系统事件发生时，自动执行一段恶意的脚本。这种方式极难被常规启动项检查工具发现。  
  
- **DLL 劫持与搜索顺序劫持**  
: 攻击者将同名的恶意 DLL 放在一个被优先搜索到的位置，让一个正常的自启动程序主动加载并执行恶意代码。  
  
- **COM 劫持**  
: 通过修改注册表中 COM 组件的指向，当某个自启动的合法程序尝试加载一个正常的 COM 对象时，实际上却加载了攻击者指定的恶意 DLL。  
  
## 🚀 第四章：终极神器 Autoruns - 让所有后门无所遁形  
  
手动排查上述所有位置既耗时又容易遗漏。幸运的是，我们有 **Autoruns**  
。  
- **是什么**  
: 由微软官方 Sysinternals 套件提供的免费、权威的自启动项排查工具。  
  
- **为什么是“神器”**  
: **Autoruns 能够枚举出 Windows 系统中几乎所有已知的、可以实现自动执行的位置**  
，包括我们上面提到的所有经典和高级技术点，并将它们整合在一个清晰的界面中。  
  
### 使用 Autoruns 进行应急响应  
1. **下载并运行**  
: 从微软官网下载，建议在应急响应时使用已知干净的便携版。  
  
1. **过滤噪音**  
: 在 “Options” 菜单中，勾选 **“Hide Microsoft Entries”**  
 和 **“Hide Windows Entries”**  
。这将隐藏所有已知的、合法的系统启动项，让你能瞬间聚焦于第三方和可疑的条目。  
  
1. **验证签名**  
: 勾选 **“Verify Code Signatures”**  
。任何**没有有效数字签名**  
的启动项都应被列为最高嫌疑对象。  
  
1. **VirusTotal 集成**  
: 在 “Options” -> “Scan Options” 中，勾选 **“Check VirusTotal.com”**  
。Autoruns 会自动计算每个文件的哈希，并查询 VirusTotal 的信誉。任何报毒率高的条目，几乎可以断定是恶意软件。  
  
1. **切换标签页，专项排查**  
:  
  
1. **Logon**  
: 对应第一章的“常规”启动项，如 
```
Run
```

  
 键和启动文件夹。  
  
1. **Services**  
: 对应第二章的“恶意服务”。  
  
1. **Scheduled Tasks**  
: 对应第二章的“计划任务”。  
  
1. **Drivers**  
: **（重点！）**  
 对应第二章的“驱动程序服务”。这是排查 Rootkit 的核心区域。在这里重点检查没有微软签名的驱动。  
  
1. **WMI**  
: 对应第三章的“WMI 事件订阅”。  
  
1. **KnownDLLs**  
: 对应第三章的“DLL劫持”相关。  
  
## 结语  
  
排查启动项，是应急响应中至关重要的一环，它是在与攻击者进行一场关于“记忆”和“痕迹”的博弈。攻击者有成百上千种方式留下“买路财”，而我们的任务就是釜底抽薪，彻底切断其再次进入的大门。  
  
请记住：  
- **系统化排查**  
: 不能只看 
```
Run
```

  
 键，服务、计划任务、甚至驱动都是持久化的温床。  
  
- **警惕高级手法**  
: WMI 和 COM 劫持等技术需要专业工具才能发现。  
  
- **善用终极神器**  
: **Autoruns**  
 是你最值得信赖的伙伴，它能帮你节省90%的时间，并发现99%的启动项后门。  
  
只有对所有潜在的启动点进行一次彻底的“大扫除”，我们才能在事件结束后，安心地对老板说：“报告，威胁已完全清除，系统安全。”  
  
  
