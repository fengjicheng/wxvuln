#  DouPHP（CVE-2024-7917、代码分析xss）漏洞复现   
原创 LULU  红队蓝军   2024-08-23 18:01  
  
## 漏洞介绍   
  
**漏洞**：CVE-2024-7917  
  
**介绍**：DouPHP 1.7_Release_20220822版本中存在一个远程代码执行（RCE）漏洞。拥有管理员权限的攻击者可以通过该漏洞在服务器上执行任意命令。漏洞通过上传恶意ico文件、修改文件扩展名来执行PHP代码  
  
该漏洞影响了组件Favicon Handler中的未知功能文件/admin/system.php。通过操作参数site_favicon，攻击者可以执行**无限制上传**操作。攻击可能远程发起。该漏洞已被公开披露并可能被利用。  
  
**影响版本**：DouPHP v1.7 Release 20220822  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeORfbRPxI2up2e6NDzXM6aJYic9SBbrvcfMlC7JJJbxvoiaFtTEAORicQjg/640?wx_fmt=png&from=appmsg "")  
  
**下载地址**：https://www.douphp.com/history  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOeS38ZrIlEu2QHCIjgtiaTummwV7Nly9L3v7eslICYJaRkxibicjLZsh6A/640?wx_fmt=png&from=appmsg "")  
  
**环境搭建**  
  
使用phpstudy,搭建网站即可。  
  
推荐配置：php7以上 + MySQL5.7以上  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOhKzck81WIwWVJnaxCibt060Xy8qA1zocYGibY7Ke1MHu5H99fRgt1cDw/640?wx_fmt=png&from=appmsg "")  
## 漏洞复现   
  
1、登录后台  
  
http://域名/admin/login.php  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeO2OwygE8qrsJKwCUo2qr3rbicUG9uE7uso0B6UOLGPHzOELPsPf3q1XQ/640?wx_fmt=png&from=appmsg "")  
  
2、点击系统设置---上传shell文件  
  
查看源码，白名单限制![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOFLqYBjiamamTFHhq1Ulcdk7nSIVdEjsUicouvsIc3DtGCQNyHK8EmsrQ/640?wx_fmt=png&from=appmsg "")  
  
  
上传后缀为ico的木马文件  
```
文件内容：<?php phpinfo();?>

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOSrVs4yIyo8enLZXYTaLicHvdE6H4uj7PtdtvibZUKLUU77UIdxfibGHtQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeO4WW7DE9jXlg69ic2gic83MEW0ZAB69hHqdnqDdy8znqicXU1brjykxKRg/640?wx_fmt=png&from=appmsg "")  
  
上传成功  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOJszg3ZSg8Jw9pOsHRN9qYeGy6KtjhVC2GPiaGcgx5tpib6IHLafMxcSQ/640?wx_fmt=png&from=appmsg "")  
  
3、修改文件后缀为php  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeO47mlEMsLmianoA00846Ybj0Y6T0icresN7u41JQ14697G94RZibJJeekw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOTcz16ndAkiaZJy7JJdiaP6JxzQ56g7lkeAM2AV9PzRLeozHYcjibXfxoA/640?wx_fmt=png&from=appmsg "")  
  
burp抓包，我这里在虚拟机搭建的网站，如果要用物理机抓虚拟机的包，需要修改代理IP为物理机的IP地址，无法使用127.0.0.1。  
  
修改new_path =favicon.php  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOb337YNkMSeRGpconrRZwfnD47fVZreyMHtpvfxdznP1kEtxXXb4SBQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeO3qd9iaFoOOFfptqGHPe6ZtZf9yrkklwYHiaVImIeHFZJsIibicXdrXUIgQ/640?wx_fmt=png&from=appmsg "")  
  
访问www.douphp.com/favicon.php  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOyM0lcFAeS7PI4DfJCpzpWAPLBpyjNl9xWoOztGFLldYrbicSsLOqfgw/640?wx_fmt=png&from=appmsg "")  
## 漏洞介绍   
  
**漏洞**：xss漏洞  
  
**介绍**：文件上传导致的XSS  
  
**影响版本**：DouPHP v1.7 Release 20220822  、DouPHP v1.6 Release 20220216  
  
使用上述已经搭建好的环境  
## xss漏洞介绍   
  
**概念**：攻击者利用网站漏洞把**恶意的脚本代码**（通常包括HTML代码和客户端Javascript脚本）注入到**网页之中**，当其他用户浏览这些网页时，就会执行其中的恶意代码。  
  
**条件**：  
```
- 用户能够控制输入
- 拼接恶意的JS代码

```  
  
**xss可利用的脚本攻击**  
```
利用标签<>构造HTML/js语句      <script>alert(document.cookie)</script>   双写  大小写 等等绕过姿势
利用javascript伪协议构造       <a href="javascript:alert(1)">点我</a>   
事件驱动                    
<input type="text" onmouseover="alert(1)">  鼠标悬停
<input type="button" onclick="alert(1)">    点击事件
<img src="#" onerror="alert(1)">            报错  等等事件

```  
## 漏洞探测   
  
翻阅各个模块  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOz62loVzoia045djIqTEX7IDpGMnLdxgxAGiawMcz6UPfzRuxpichll9tQ/640?wx_fmt=png&from=appmsg "")  
  
上传的页面在前端展示  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOeKRtfmJ2B0cvHVgpEK9Mwajw8uWHdollItaSvNZEMcRHEnjGtm9HNQ/640?wx_fmt=png&from=appmsg "")  
  
**代码分析**  
  
分析admin/show.php,找到功能点  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeObZwHyg5JDxgSficwanOem1VuPJ7IEv3AVI5pw1bu3bhCmq53ibsPYmYg/640?wx_fmt=png&from=appmsg "")  
  
分析代码。判断幻灯名称show_name是否为空，若为空则报出“名称为空的”错误提示  
```
if (empty($_POST['show_name'])) $dou->dou_msg($_LANG['show_name'] . $_LANG['is_empty']);

```  
  
这里可以发现，没有对上传文件的名称做限制，只判断是否为空，会想到是否是文件上传漏洞，使用box函数对上传的文件做了限制，没法绕过。这里可以想到将上传的图片名称写为xss的payload。继续往下分析。  
  
使用Token验证，验证成功，将上传的信息 show_name 、show_link 、show_img、show_text写入数据库中,这里没有二次校验，上传的名称，使用insert注入，没有成功。他这里直接将语句插入到数据库中。![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOSyka88IOwg7KjP8LWZqicmhd4bbz1jIL8gJiaLMIMAmSttPK0fAp7JZA/640?wx_fmt=png&from=appmsg "")  
  
  
以上分析：猜测在/admin/show.php中存在存储型xss漏洞  
## 漏洞复现   
  
**第一处xss**  
  
访问：http://www.douphp.com/admin/show.php  
```
插入xss_payload :<script>alert(1)</script>

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeO3lkCHTKdwmLSO8CK4M8ibSBGQGX5xaX189CTZeaYV8FQB1UojBEJpMg/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOyibkkWyexoZdRGialnKbbYicL3gaKiblomOFRdoic3hRvz1cMy03c3uGs8Q/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/ibZ6uZjjH3v5XGCUte0oGk4g8XIHDpNeOBYSCVes6ia7vrsS9fnZUptROGelENISEjx37As6kmqoL6IQ8LHRYUoQ/640?wx_fmt=png&from=appmsg "")  
  
  
加下方wx，拉你一起进群学习  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/ibZ6uZjjH3v5KP8CaWoS7GAJnWQQxPpibNdibOdl0hc3X6uuBy7rLVOoxS0OSd4vdHWcibFpZg9T9Bx6T7Rn87RoIw/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
