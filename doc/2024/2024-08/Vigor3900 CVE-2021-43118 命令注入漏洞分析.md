#  Vigor3900 CVE-2021-43118 命令注入漏洞分析   
N1nE  看雪学苑   2024-08-15 18:00  
  
此固件是2024中国工业互联网安全大赛智能家电行业赛道选拔赛决赛的一道题目，其中就可以直接用CVE直接命令执行。本人对IoT一直在尝试学习，这次的比赛见到了很多师傅非常厉害，这也是一个非常好的让我深入IoT漏洞挖掘和利用世界的契机。所以我打算完整分析一次这个赛题/固件，希望大家都有所收获。  
##   
##   
  
```
```  
  
  
  
DrayTek Vigor 是一款arm架构路由器。该路由器存在一个远程命令注入漏洞，攻击者可以利用该漏洞，通过在mainfunction.cgi  
中注入格式错误的查询字符串，构造恶意的 HTTP 消息，从而在远程执行任意代码。  
  
  
**受影响版本：**  
  
  
◆DrayTek Vigor3900 1.5.1.3  
  
◆DrayTek Vigor2960 1.5.1.3  
  
◆DrayTek Vigor300B 1.5.1.3  
  
  
  
```
```  
  
###   
### 1. 基于qemu的Sevnup模拟启动  
  
  
直接使用命令启动系统级固件模拟，成功。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB3H1mxBJzUqhicHc3qMUnsVmtrHRFrlLibCnc8Y26gPd1V7mM1GsfurGQ/640?wx_fmt=jpeg&from=appmsg "")  
###   
### 2. 找到服务并启动  
  
  
使用命令find ./ -name *.httpd  
发现了几个httpd,其中主要是lighttpd。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBk6anE8fGdmQg3q8ia5ElDwfUnibBNApa3ZIPwocn7VQeSACY5UjPtYcw/640?wx_fmt=jpeg&from=appmsg "")  
  
  
直接启动失败，说没有配置文件：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBgvuyibMKIicj1XlQNLWOBTUAjFVuQVf6cAr0bLVspZVcmJKrMkvE0l5Q/640?wx_fmt=jpeg&from=appmsg "")  
  
  
尝试找配置文件：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBHTfaaJlvVe8TVrLHUWQD8cusH54c3oSS4Aj5TeLcSWusACEk5f70HA/640?wx_fmt=jpeg&from=appmsg "")  
  
  
发现相关http的配置文件，尝试使用lighttpd的配置文件即可启动成功，命令如图。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBWcoMLrVURySFcjj9mDWkBL8Rq7NkOnKJlf6rkXuyxSvvQvY1cw6e3g/640?wx_fmt=jpeg&from=appmsg "")  
  
  
发现http服务启动成功：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBx6rDYl0rt3qneiaLmjBxibpDLYrT2p83C6EQ5FJXiaj85B345oibmyg0XQ/640?wx_fmt=jpeg&from=appmsg "")  
##   
  
  
```
```  
  
  
  
我们首先获取网络上的POC脚本进行复现：  
  
  
```
```  
  
  
  
效果如下，说明仿真成功：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBYVOXibulKWHZscmpqaptlncPvOnZGwfbWSTsFNZp0N3xDArjRm7icUibA/640?wx_fmt=jpeg&from=appmsg "")  
##   
##   
  
```
```  
  
###   
### 1. 找到漏洞程序  
  
  
主要使用了lighttpd运行了httpd服务，然而怎么处理得看上述找到的lighttpd.conf配置文件：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBwuVkPhDuImyxGiaBSuVOiadmTAibqUXJku8UwkIQFXYQtNic2TgTky2xrQ/640?wx_fmt=jpeg&from=appmsg "")  
  
  
可以看到大概是有cgi-bin去处理相关逻辑的。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB6O4vibuKmou0Vw0qtB0icFgpVmZOXdiaauMRCF5KJgPBaqCHWApljEBSg/640?wx_fmt=jpeg&from=appmsg "")  
  
  
我们可以看到，确实存在cgi-bin。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBfU2zRtMgJYAJOdZ7icdqwuljkuRI1yliaTHicQMpFSyiclMp63O2pKXzFQ/640?wx_fmt=jpeg&from=appmsg "")  
  
  
接着我们就在这里看到了漏洞描述的文件mainfunction.cgi  
。接下来我们对其进行深入分析。  
  
### 2. 找到命令注入点  
  
  
我们可以通过搜索POC的keyPath找到对应位置（shift+f12,然后alt+t进行搜索）：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBSnquA4ewIibkpWv6P0P51ia0PbLVGqYsB3tw7rd25C312ia70F9jGgSHw/640?wx_fmt=jpeg&from=appmsg "")  
  
  
点击进入后，查看其交叉引用（ctrl+x）：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB3UV2dZfWxL0qFJ7WFgjW2xNC9Gagt4DBA2FozbNM986bt7sgNQDkkg/640?wx_fmt=jpeg&from=appmsg "")  
  
  
显然第一个是有汇编指令LDR进行调用地方，我们双击进入并且F5反编译，得到头部伪代码如下：  
  
  
```
```  
  
  
  
函数名称为 sub_2AB3C。  
  
  
我们点击进入cghiGetValue函数得到：  
  
  
```
```  
  
  
  
应该是把对应数据的值传入a1中。  
  
  
显然重点在于system(v38);  
。我们通过修复v38变量对最终作为命令传入的参数进行跟踪。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBrGCJh3br6htbk6QoyWwZqyVAyneUy05iclFsInNCe1tloriamzeBc7ibw/640?wx_fmt=jpeg&from=appmsg "")  
  
  
从下网上看，我们发现cmd的一个部分str_1来自v10与v11，我们考虑对其进行继续跟踪，改名为str11与str12。然而发现str11来自off_42400,  
  
为.data:00042400 C4 7E 03 00 off_42400 DCD aTmpRsaPrivateK也就是/tmp/rsa/private_key，而str12来自Value经过函数sub_AD58的返回值。函数暂时不深究，我们继续向上回溯分析。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB5ob8QA8Djt9X7WYn20NOeIoTmr6gFDQpvhGqHmZKmBQicJqA0ZRxaDg/640?wx_fmt=jpeg&from=appmsg "")  
  
  
然后我们发现，Value就是keypath的值。也就是说如果要传入命令必然经过keyPath。所以这就是注入点了。  
  
### 3. 求解约束路径  
  
  
在找到注入点之后，我们要分析，注入如何的数据能够走向执行system(cmd)的部分。我们标注key_path传入的数据就是web_cmd，我们可以看见，他会经过一个比较：  
  
  
```
```  
  
  
  
注意到else才是我们能执行命令的位置：  
  
```
```  
  
  
  
所以我们要想办法满足v8 || !web_cmd == false  
才能够触发命令执行。  
  
  
换句话说，!web_cmd  
我们传入之后他肯定是false了，我们只需要v8也是false即可，也就是说v8是空指针或者没有内容或者为0。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxByomKf261eHFrwmTlJ8JJA6rBlfPibIu4VmMxe0xeKddxhS9n8ibAvM9Q/640?wx_fmt=jpeg&from=appmsg "")  
  
  
他的类型是bool类型。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBpVbuE8nZ5Hk8NY48ufkic1uHoyTPgw1CZfgn6omjJk44Q6R5shPaLBQ/640?wx_fmt=jpeg&from=appmsg "")  
  
  
注释给出他是zf,也就是0标志位。我们发现对于v8有几个关键的赋值：  
  
  
```
```  
  
  
  
首先v8为Value == 0的布尔值，我们希望v8是false,也就是说Value不是0,而且如果value有了的话，我们也希望v7不是0,这样就能确保v8为0了。  
  
  
仔细观察发现web_cmd_buf其实依次从keyPath、loginUser、loginPwd取值，最后是从loginPwd取值到web_cmd,Value,v7，所以我们这三个参数都要有,才能满足v8为false。  
  
```
```  
  
###   
### 4. 构造命令注入  
  
  
得到路径之后我们继续分析如何构造命令进行注入：  
  
  
```
```  
  
  
  
我们看看伪代码。我们发现可控的只有web_cmd,他会经过sub_AD58做一个处理。存在数据链条如下：  
  
  
```
```  
  
  
  
所以 ，此处我们还需要分析一下sub_AD58函数。函数具体如下：  
  
  
```
```  
  
  
  
我修改变量名和一些数据类型得到如下，并且写一些注释方便各位分析查看：  
  
  
```
```  
  
  
  
省流分析结果，我想传入命令但是不被更改为加号的话，那么就保证不出现以下字符：  
  
  
```
```  
  
  
```
```  
  
  
  
处理之后传给str12，会与str11和_和自己组合，我们为了与他们割裂可以用回车键将自己作为另一个命令。  
  
  
```
```  
  
  
  
最后还会做这样一系列的操作。所以我们前后都用回车键将命令分隔开。  
  
  
综上我们需要构造web_cmd也就是：  
  
1.keyPath不得出现以上字符。  
  
2.keyPath、loginUser、loginPwd都要赋值。其中keyPath是命令。  
  
3.keyPath前后都要想办法分割。  
  
### 5. burp抓包构造poc  
  
  
知道需要构造的参数之后，我们还是无法知道如何调用到这个函数，目前根据配置文件知道可以使用/cgi-bin/mainfunction.cgi去调用这个cgi（甚至对此也不是特别确定），但是如何去调用到这个函数呢？有点一头雾水，而且根据网上poc可以得出是action等于login吧？但是没法通过逆向找到具体的调用方式。  
  
  
下面可以看到函数地址和一些相关字符串挨在一起待在data段。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB2hGQbAm3hhQpdkDrTdST6fKrS9xMJiazFYmDWCJPbo291WCkZ5H4aqQ/640?wx_fmt=jpeg&from=appmsg "")  
  
  
此时我想到，可以尝试一个比较快的方式，从而得知他的调用格式和发包方式：用burp抓包分析。如图，确实是使用/cgi-bin/mainfunction.cgi去调用cgi，并且使用的是POST请求。POST参数包括action和具体参数。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBicJJhnaltqjguiaePj3kTiabpJCsFqib4QUsh0UTLsxBGmp0Qxich14f6jA/640?wx_fmt=jpeg&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBBbWOMuUd6xKBicnWweCIfWV4SCY2v1u3sUygqXgF0PxliaTBrGWoZUUg/640?wx_fmt=jpeg&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBdvVUlsrbTiaCAicS80DrwHgOEMzyCjojgR8AgLU3hY27WR1nIwp0jn9w/640?wx_fmt=jpeg&from=appmsg "")  
  
  
会不会刚才data段里的内容就是字符串action及其对应的调用函数？  
  
  
我们搜一个刚才看到的action的具体值：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB0qnd58uB3mHplEteyNnEZu1oESJWhgb1cjO9AwISqter9VkvQztDtA/640?wx_fmt=jpeg&from=appmsg "")  
  
  
果然就是在刚才那一段部分！也就是说推测是正确的。也就是说我们的poc可以构造action=login。我们可以点击左边栏目查看（这个功能太强了）发现有action=login的，结果发现里面的参数和我们刚才分析的一模一样，只是多了一些别的参数。那些参数其实就在我们分析的函数下方，不过我们就不进一步分析了。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBaLuhglf2pXpbHXOXOuH58KVEQf2QRoWr4HCHYkASjmWqhrpxxlo2jQ/640?wx_fmt=jpeg&from=appmsg "")  
  
  
综上，我们分析得出：  
  
1.POST请求  
  
2./cgi-bin/mainfunction.cgi 在目的ip后面  
  
3.action=login  
  
4.keyPath不得出现以上字符（` | ; ? 空格 $(不可同时出现 ）。keyPath是命令。  
  
5.keyPath、loginUser、loginPwd都要赋值。  
  
6.keyPath前后都要想办法分割。  
  
  
我们写了个脚本，发现没法做到执行命令。为此我们打算执行动态分析也就是调试。  
  
  
```
```  
  
###   
### 6. 调试分析构造poc  
  
  
Sevnup会把qemu映射到1234端口，直接用gdb-multiarch连接即可。之前做过armpwn知道寄存器排布如下：  
> arm架构中，调用号3是read，4是write，5是open，0xb是execve。  
> r7用来存储系统调用号。  
> r0,r1,r2分别为三个参数。其中r2的控制较为麻烦，不过问题不大。  
  
  
  
执行命令，其中0xa4c8是system的地址：  
  
  
```
```  
  
  
  
看到第一个参数就是命令，起码执行了system说明我们的路径约束没问题，主要是构造命令出了问题。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB7DQGNj9ib2a5hXn68cNjuy9QKCnZVD0zzsTia2iaicmpibyZBcmBGNroPUA/640?wx_fmt=jpeg&from=appmsg "")  
  
  
我们看看我们的ls  
被改成什么了：  
  
  
```
```  
  
  
  
也就是说它实际上执行了：  
  
  
```
```  
  
  
  
这……显然没有  
达到我们想要的目的，他达成了删除三个东西。如何绕过呢？我们试试用'  
。  
  
  
  
然而这样并不能解决嵌套命令的问题。而后我又尝试了用\n  
发现还是不能，因为\n  
导致直接截断了。最后发现可以用URL编码%0A解决这个问题！所以我们最后的脚本如下：  
  
  
```
```  
  
  
  
至此完成分析。效果如下：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxB0kcEXt2gbqsYQiaYAbAibgqCsEFVIzC3BiaJg1jxvjuficlf2n03gjDVEQ/640?wx_fmt=jpeg&from=appmsg "")  
##   
##   
  
```
```  
  
  
  
此次漏洞仿真、分析漏洞、构造poc的整个过程，对我来说是非常启发性的。对于IoT命令注入的漏洞挖掘总结来分为下面几点：  
  
1.找到注入点。  
  
2.分析路径约束。  
  
3.构造特定输入。  
  
4.逆向、bp抓包分析如何发包。  
  
5.调试进一步分析，确定结果。  
  
  
其中仿真也是非常重要的部分。整体来说这次分析学到了不少。比较词穷了，但是心里非常的兴奋，也希望大家看到这里和我的心情是一样的。谢谢你能看到这里.  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8FSoGhzo0HbRdKE846iagMxBRuQjh0qpBgiawibtFZQo46vr9ibtbnVVicVgLv01b11k5G5y6o82jicicZ2w/640?wx_fmt=png&from=appmsg "")  
  
  
**看雪ID：N1nE**  
  
https://bbs.kanxue.com/user-home-995344.htm  
  
*本文为看雪论坛精华文章，由 N1nE 原创，转载请注明来自看雪社区  
  
  
[](https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458565463&idx=1&sn=e03e9773326308fa63d18676470a6824&scene=21#wechat_redirect)  
  
  
  
**# 往期推荐**  
  
1、[移植 Youpk 到 Aosp10](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458567868&idx=2&sn=3b7c2f13d8a255d680fd823e5beb396b&chksm=b18df43686fa7d204933a40a99416268cdab0d9e82e6837cafada85ac169197453ecd2add05a&scene=21#wechat_redirect)  
  
  
2、[第十七届CISCN总决赛-AWDP-PWN部分题解](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458567439&idx=2&sn=4214f2bea8f2ee1795f39bf24e260884&chksm=b18df38586fa7a9349cedce46438eef955cbae89e2e1935ede674469da0573ef654d925971ef&scene=21#wechat_redirect)  
  
  
3、[aarch64架构的某so模拟执行和加密算法分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458567422&idx=1&sn=e7f5eb398bdd106bc491e4e427ad05ed&chksm=b18df27486fa7b62336c0c87a656f3aa7fc90ee3977f55e83ead09e0fbb372c0a7838441bc73&scene=21#wechat_redirect)  
  
  
4、[Android系统启动源码分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458567423&idx=1&sn=4cc6b0e2a8e1acf244ee6567e07edae3&chksm=b18df27586fa7b63f5361222ea2c3391c63f55587196d39ae609dc00cf7acf1328266885d243&scene=21#wechat_redirect)  
  
  
5、[Linux 内核重大安全漏洞曝光！indler 漏洞威胁数亿计算机系统](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458567380&idx=1&sn=18d81c63ed1044e4ad9f30e080f0ac7b&chksm=b18df25e86fa7b48050427a1e197dab73e9921ded984be316f4468ea9170b8d90a2b35e50276&scene=21#wechat_redirect)  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg "")  
  
**球分享**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg "")  
  
**球点赞**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg "")  
  
**球在看**  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNp5aaC28Vzoibu2eYfSuD9d4nTJceKXwuR8oBEzcjMUPCLUMMgdAzQBA/640?wx_fmt=gif&from=appmsg "")  
  
点击阅读原文查看更多  
  
