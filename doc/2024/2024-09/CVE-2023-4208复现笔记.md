#  CVE-2023-4208复现笔记   
mb_btcapvow  看雪学苑   2024-09-07 17:59  
  
```
```  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIoNYLDOOjjNKEgoVQLdLMPBwounmTbpGeralJlfT6Ep3QoP67CjuFjg/640?wx_fmt=png&from=appmsg "")  
  
  
commit：2c85ebc57b3e1817b6ce1a6b703928e113a90442  
  
  
内核源码下载：  
  
  
```
```  
  
  
```
```  
  
  
```
```  
  
  
  
编辑 .config:  
  
  
```
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjI1xFuf8xSKSEHT98lJJ75CFGMDuqS7n1G5ERdtpzhIyaxXdj9Uzia1rA/640?wx_fmt=png&from=appmsg "")  
  
```
```  
  
  
  
遇到问题：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIdSXTDytMgpS5gAk54TBJM8nTVXX4mM6Uh4iad9LjLIEicrZOBlHYv6iag/640?wx_fmt=png&from=appmsg "")  
  
  
objtool: Don't fail on missing symbol table · Pull Request !141 · openEuler/kernel（https://gitee.com/openeuler/kernel/pulls/141/files）  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIoaznItiacWU5QibyHgUWXGmv3KjsO9nicfnhWbz2kmduqsCSEfic2MjPxA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIAGlFx6SfE7lzDNYTicwGYrJe5aRlUNbTVf6cTeGoTCWpng7GnpMCwuA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjISZP89OuNqThZCpbrh9ib7UZfh8XoCXGOzhNONicSLYJTHlOHEgYj3EeQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIEdr2dMB0nlTwgXQA4WKgQOOHpZ3jJ62PvNJSjT0QDyusEXXdod6erw/640?wx_fmt=png&from=appmsg "")  
#   
  
  
```
```  
  
  
  
◆Kernel configuration: CONFIG_NET_SCHED=y, CONFIG_NET_CLS_U32=y  
  
  
所以总的config就是：  
  
  
defconfig+menuconfig  
  
  
```
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIyg3KIqHuuhwu7aKlxmC5lMAdGB9J5C3NYO3l2cuepIIzsdb6E2QS6w/640?wx_fmt=png&from=appmsg "")  
  
```
```  
  
#   
#   
  
```
```  
  
  
  
在复现本CVE时，笔者已经有了CVE-2023-4207的复现经历，所以这里参照与之相同的思路进行复现，不过相关细节可能不再赘述，有不清楚的地方可以参照笔者的这一篇文章：[  
原创]CVE-2023-4207复现笔记（https://bbs.kanxue.com/thread-283073.htm）  
  
  
以下是一些触发漏洞的命令行：  
  
  
```
```  
  
#   
#   
  
```
```  
  
  
  
相关源码路径如下：  
  
  
```
```  
  
  
  
在添加filter和替换filter的时候都会调用到这个函数；  
  
  
这里的n应该就是旧的filter：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjInGXYv8AKcXolXzS5fJDXluIEVEK9RF9mGRSVLfTVzdBE1dsQv2fapQ/640?wx_fmt=png&from=appmsg "")  
  
  
这里通过u32_init_knote分配新的过滤器：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIPL0TkhkMXGUBoetysN0cBUl4YhBxj3q6XohTLfSNOxnvuGvV4XHadg/640?wx_fmt=png&from=appmsg "")  
  
  
可以看到在该函数中直接将旧的过滤器的res分配给新的过滤器：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIAP82TLThqENKaW0kDQR5FtZO5CaSKKicPwleuU9XApc6NyU6ibCczT2Q/640?wx_fmt=png&from=appmsg "")  
  
  
然后tcf_unbind_filter旧的过滤器：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIUohMrt2CEqUp1MSa1moXgRRK2vgohLD1nd98mIBNe4n8seUviaGoQYw/640?wx_fmt=png&from=appmsg "")  
  
  
具体函数如下：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjI8qw3DpJAwfMneCLiaziazdzYKEyBUcdU7LUdFhPIKONibDJEAd5W8YAyg/640?wx_fmt=png&from=appmsg "")  
  
  
继续跟进到__tcf_unbind_filter:  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjI5Shhv1bkUt6Vic9SfHibpKqIqqEfBRyj7iawk52XnKpHibax24zE6QEEIA/640?wx_fmt=png&from=appmsg "")  
  
  
这里调用了函数指针，通过调试后可以得知是这个函数（其实用的是drr，基本就是这个函数）：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIqqdiaE2DChhHjImjic7T4Jw7lFRcLCvPgxWa631AJQol2yTsic6J6Or6Q/640?wx_fmt=png&from=appmsg "")  
  
  
下面看该函数的具体定义：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIT8lEgXrWk29Mko4HtS3QxyGYPgRPibD7PxELEHzLAPWhvQeyfJHX1uw/640?wx_fmt=png&from=appmsg "")  
  
  
在这里将drr_class的filter_cnt减一；然而实际上，我们的class只是换了一个filter而已，其引用数不应该被减少；  
  
  
剩下的就和CVE-2023-4207一样了，我们删除drr_class的时候会调用drr_delete_class函数：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIWicEk62r36NF9I7z2BQWWCV8NEykHL5G1XCTRVt9unibzKB0wuT2RGLQ/640?wx_fmt=png&from=appmsg "")  
  
  
如果引用计数<=0，就可以调用到drr_destroy_class：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIK3MicAqooOXQWJlM13ibpSOBDECzBib5cxo25zsjfNTPB375P8u7JTGKw/640?wx_fmt=png&from=appmsg "")  
  
  
这样就错误地释放了对应的qdisc和drr_class；  
  
  
下面还是贴一张笔者分析的图：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIE2t2QmFwXed5wDYhX7fzVvU6lxlQC5Q0UZaGcxI5c1zJPicSuXLwnFw/640?wx_fmt=png&from=appmsg "")  
  
  
  
```
```  
  
  
  
```
```  
  
  
  
主要是在drr_destroy_class下断点，然后查看cl，在后续喷射完pg_vec（当然也可以使用其他结构体）之后，可依据需使用该命令查看是否覆盖成功：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIAiaibclwGMT3VmcnrdS53giafvBpFCwMt2mItCfrES3Jdb3KoxpibygY5A/640?wx_fmt=png&from=appmsg "")  
  
  
  
```
```  
  
  
  
后边的攻击思路和CVE-2023-4207就一样了，提前喷射eBPF，是的在内核加载模块地址内部署好我们的代码片段，然后构造uaf，之后使用pg_vec喷射出来已经释放但是仍然被使用的drr_class，此时它的偏移0x60处的qdisc成员被填入了pg_vec申请的虚拟地址，虽然我们不知道这个地址，然后通过mmap可以映射这个地址，我们就有了写这个地址的权限，写其前8个字节为我们的目标地址，也就是我们喷射的eBPF地址，即可劫持控制流；然后实现地址泄露+覆盖core_pattern，最后在另一个进程触发crash，使得root1得到执行，提权成功！  
  
  
  
```
```  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8HVKwxs8YuPCj9dz23osicjIW1PluwYgAJZCOfAOSRsYjNN2HSdLdr2nGyBLMqTdzZqX79paSUqVhw/640?wx_fmt=png&from=appmsg "")  
#   
  
  
```
```  
  
  
  
poc.c:  
  
  
```
```  
  
  
  
pg_vec.h:  
  
  
```
```  
  
#   
  
# 参考  
  
  
https://github.com/google/security-research/blob/499284a767851f383681ea68e485a0620ccabce2/pocs/linux/kernelctf/CVE-2023-4208_lts_cos_mitigation/docs/exploit.md  
  
  
objtool: Don't fail on missing symbol table · Pull Request !141 · openEuler/kernel  
  
（https://gitee.com/openeuler/kernel/pulls/141/files）  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8FxlZ26xESNna7hH3DfMSk6X6yk9yFuZwgoEoTzvktXAsjOlMDxvywNJUGosmNyx8pFeTiaSd8bWicg/640?wx_fmt=png&from=appmsg "")  
  
  
**看雪ID：mb_btcapvow**  
  
https://bbs.kanxue.com/user-home-975602.htm  
  
*本文为看雪论坛精华文章，由 mb_btcapvow 原创，转载请注明来自看雪社区  
  
  
[](https://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458565463&idx=1&sn=e03e9773326308fa63d18676470a6824&scene=21#wechat_redirect)  
  
  
  
**# 往期推荐**  
  
1、[Alt-Tab Terminator注册算法逆向](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458563181&idx=1&sn=1dd42dbb95362d9678431b94473ab1f4&chksm=b18d82e786fa0bf1681d92f0d13b064eeae9530e5b2e86f78fd7f4d2662bfaffe5e99993d08f&scene=21#wechat_redirect)  
  
  
2、[恶意木马历险记](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562562&idx=2&sn=1d66bb3141b820c717f86d349660e9ec&chksm=b18d808886fa099efc353521af0839c9bf5fbd4cae2985cf3a9a6ea28fa617f8300c0ab115a7&scene=21#wechat_redirect)  
  
  
3、[VMP源码分析：反调试与绕过方法](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562488&idx=2&sn=fe5bd1498948137775db5f454bd5a6a2&chksm=b18d9f3286fa162491072b9cd141784c1a60b2b00fd8203f865c51ef753e3f45573a78810949&scene=21#wechat_redirect)  
  
  
4、[Chrome V8 issue 1486342浅析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562487&idx=2&sn=b2d6ad2776d37f416933e1439f244430&chksm=b18d9f3d86fa162b5edfd1c8e616c9ea5460cf21afc5d41cfd8122fbc73830c61f125c8a4960&scene=21#wechat_redirect)  
  
  
5、[Cython逆向-语言特性分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458562186&idx=1&sn=bd95ad7951c93578ed5f0cbb1971332c&chksm=b18d9e0086fa1716382e78c54135a0a296fa215688b9a741576d41897729625284287e598faf&scene=21#wechat_redirect)  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg "")  
  
**球分享**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg "")  
  
**球点赞**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNT86hyuq6QGl2Zh7b0IwRicAPgb3r1abUEe46MhrwYD1GqcX76t31fKA/640?wx_fmt=gif&from=appmsg "")  
  
**球在看**  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GDgjicLBjGjBq63Hnp7DmRNp5aaC28Vzoibu2eYfSuD9d4nTJceKXwuR8oBEzcjMUPCLUMMgdAzQBA/640?wx_fmt=gif&from=appmsg "")  
  
点击阅读原文查看更多  
  
