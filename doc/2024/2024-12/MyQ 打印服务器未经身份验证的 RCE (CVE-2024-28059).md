#  MyQ 打印服务器未经身份验证的 RCE (CVE-2024-28059)   
 Ots安全   2024-12-13 06:51  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/bL2iaicTYdZn7gtxSFZlfuCW6AdQib8Q1onbR0U2h9icP1eRO6wH0AcyJmqZ7USD0uOYncCYIH7ZEE8IicAOPxyb9IA/640?wx_fmt=gif "")  
  
MyQ打印服务器，作为一款广泛应用于企业环境中的解决方案，旨在优化打印资源的使用，提高工作效率。  
  
然而，近期  
Positive Hack Days (PHDays)  
 在越南举行的  
Positive Hack Talks in Vietnam  
 会议，技术员：**Arseniy Sharoglazov**  
的技术分享中其中有一项是  
对MyQ进行的渗透测试，发现了一个未经身份验证的远程代码执行（RCE）漏洞，漏洞编号为CVE-2024-28059。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tadqwlRusHaceN77ibUnMhYVoJrmavQ4rH9FhEb4O0G6zN1zVasCqLLozw5X3BOpTL7qLPp2BPQibaSA/640?wx_fmt=jpeg&from=appmsg "")  
  
在技术会后公开的会议技术文档第  
Case 1.MyQ PrintServer Project: Large Enterprise章节中就说明了该漏洞的过程。  
  
第 1 步：利用基于时间的用户枚举  
  
第 2 步：通过“dodgypass.txt”暴力破解帐户  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVo9Ve89aI1ib49SvSpStK2aUUo7WibVHtq7k8Mn3X4hFvxkUoW5YicAXU6g/640?wx_fmt=png&from=appmsg "")  
  
第3步：通过DNT Lookup获取AD信息，使用我们之前开发的“exchanger.py”脚本  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVooib6nzq78Zy9kMbTqDblj4l6SB4ico7XtJMFkaB0xvaPrrRJxVToUC9g/640?wx_fmt=png&from=appmsg "")  
  
步骤 4：通过 PEAS 验证主机的可用性  
  
通过 PEAS 利用的 ActiveSync Search/ItemOperations SSRF 的缺点是它只允许连接到 NetBIOS 名称。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVoCMS0Ric8uiakyywCfePEfcIoicwFn9LWdTtxevC5BCynz6mNlxIkic86Zg/640?wx_fmt=png&from=appmsg "")  
  
第5步：MyQ软件已下载并设置。  
  
代码在哪里？  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVogktBxQicVXIeQpGlQXzR30VhsO6gnvbb2yCwBbuZRgibe2tLDWD5vGjw/640?wx_fmt=png&from=appmsg "")  
  
第6步：5秒内消除混淆！  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVoeqhLfybcvYiaUaQKvk7OxdSb8GXEjgnwuLDEIwLy38XQUIO5XH9AZBQ/640?wx_fmt=png&from=appmsg "")  
  
  
步骤 7.1：发现变量函数执行  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVoicHZok6bwFNG3xqTUuxZunJWDsk6lNd2uYYtBvj7xt8FicFvEo32hDicg/640?wx_fmt=png&from=appmsg "")  
  
步骤 7.2：发现变量函数执行  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVop6zicT8VMRLzGI9bFd3UXI21sl6ziarkfm6vqfHrIFZDRa6E88Iymnjw/640?wx_fmt=png&from=appmsg "")  
  
步骤 7.3：发现变量函数执行  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVoibxSriagzqCw0wfIBwrogeOfYxpJUfmSbrRaAmtZgdICSW0hWGjfYulg/640?wx_fmt=png&from=appmsg "")  
  
步骤 7.4：发现变量函数执行  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVo7TwD32Wxn3zPEV9E9TNYrmxrrnsQETcqRiaFflYMcGB7h8tekpQhdEg/640?wx_fmt=png&from=appmsg "")  
  
步骤8.1：RCE获取  
  
通过8090/tcp端口首次尝试成功实现RCE  
  
HTTPS 默认为 8090，但 POC 出人意料地有效。我考虑过尝试 49500/http，但没有必要。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVoghTPiciaTdIHWpNSPlTVk81NULPPzs2bhTkicSA0iapiaDPmRnZkH0qm3Fw/640?wx_fmt=png&from=appmsg "")  
  
步骤8.2：RCE获取  
  
通过 print$ 共享可以方便地检索命令的输出  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVollLJNqicSs2ybFmQJicGzOJiaqEkaHRKAdxrNaNf2rUBpORE3wmVnjTaA/640?wx_fmt=png&from=appmsg "")  
  
步骤 9.1 最终分析  
- 用户枚举，暴力攻击 6天  
  
- 发现和利用远程代码执行 1天  
  
- 使用的外部服务 1×MS Exch  
  
访问级别：打印服务器上的 NT AUTHORITY\SYSTEM  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVocbWKWUpv6TmDz1N9lb2ZFvAz9AogyA91csD7ZiaQGr2VhVtibRiawST4g/640?wx_fmt=png&from=appmsg "")  
  
步骤 9.2：最终分析  
  
MyQ 于 2024 年 1 月修补了该问题并分配了 CVE-2024-28059  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadqwlRusHaceN77ibUnMhYVozn8mJ6GS0u3UvYXuibjiaGx2fc3xyLia0U1WVLywqhlDXJXcIm3yK4iaJw/640?wx_fmt=png&from=appmsg "")  
  
**幻灯片：**  
  
https://static.ptsecurity.com/events/exch-vietnam.pdf  
  
  
  
感谢您抽出  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycNnFvFYVgXoExRy0gqCkqvrAghf8KPXnwQaYq77HMsjcVka7kPcBDQw/640?wx_fmt=gif "")  
  
.  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycd5KMTutPwNWA97H5MPISWXLTXp0ibK5LXCBAXX388gY0ibXhWOxoEKBA/640?wx_fmt=gif "")  
  
.  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycU99fZEhvngeeAhFOvhTibttSplYbBpeeLZGgZt41El4icmrBibojkvLNw/640?wx_fmt=gif "")  
  
来阅读本文  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWge7Mibiad1tV0iaF8zSD5gzicbxDmfZCEL7vuOevN97CwUoUM5MLeKWibWlibSMwbpJ28lVg1yj1rQflyQ/640?wx_fmt=gif "")  
  
**点它，分享点赞在看都在这里**  
  
