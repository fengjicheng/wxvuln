#  Apache OFBiz 命令执行漏洞分析（CVE-2024-32113、CVE-2024-36104）   
原创 元亨-blckder02  中孚安全技术研究   2024-06-21 17:33  
  
1.前言  
  
**官方公告：**  
  
https://issues.apache.org/jira/browse/OFBIZ-13006  
https://lists.apache.org/thread/w6s60okgkxp2th1sr8vx0ndmgk68fqrd  
  
https://issues.apache.org/jira/browse/OFBIZ-13092  
   
https://lists.apache.org/thread/sv0xr8b1j7mmh5p37yldy9vmnzbodz2o  
  
**漏洞描述：**  
  
通过目录遍历可以绕过授权验证实现命令执行。  
  
**影响版本：**  
  
CVE-2024-32113:  

         Apache OfBiz < 18.12.13 CVE-2024-36104:   

         Apache OfBiz < 18.12.14  
  
2. 环境搭建  
  
下载地址：  
https://archive.apache.org/dist/ofbiz/  
  
解压后用 IDEA 打开，点击右侧栏 Gradle 中的 build 之后会生成一个 biuld   
目录，该目录下面会生成一个  
ofbiz.jar，Run/Debug Configurations  
 中会自动生成一个 Gradle 配置项；新增JAR Application  
，添加指定  
ofbiz.jar  
路径。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvAMLPDyUlyKaWPe6lnH0Xxu1Z1LmeLO1PGtNkWkSFEEzh3M9TbZQUxw/640?wx_fmt=png "")  
   
  
启动这个jar。  
  
  
   
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6Iv1k1XJTJfWGL7elZeH3pACY6iapMOdrjWJT2dhiaRGxX5Oibic0hyibgzppw/640?wx_fmt=png "")  
  
  
能成功访问https://localhost:8443/webtools  
就说明环境搭好了。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6Ive2ttuKyc4aTIfo8g6CDGj9IEgK3uC9AldT9icUqZTribfbEicuwmJUibew/640?wx_fmt=png "")  
  
3. 漏洞复现  
  
在调试分析的过程中发现，导致命令执行的关键原理跟目录遍历并没有绝对关系，与其说这是目录遍历导致的代码执行，不如说是授权检查绕过。  
  
基于 CVE-2024-51467 修复授权检查绕过的方法是修改 LoginWorker.checkLogin() 登录校验方法的返回逻辑，所以不能再通过传参来绕过授权检查。  
  
但是仍然可以从  
securityAuth  
入手，以不需要身份验证的 uri 为跳板来调用  
/ProgramExport  
对应的视图。  
  
（详情可回顾：[Apache OFBiz 命令执行漏洞分析](https://mp.weixin.qq.com/s?__biz=Mzg4Nzc3MTk3Mg==&mid=2247488429&idx=1&sn=7feb3d221730a965bd93b0f2afdf97af&chksm=cf841586f8f39c906bcc435bf4d689cd284afce976d87d261a7c91420a640829af70f5e89305&token=1148006179&lang=zh_CN&scene=21#wechat_redirect)  
  
）  
  
直接构造 18.12.14 及之前版本通杀的路径 payload，不需要进行目录遍历。  
   
```
/webtools/control/ListTimezones/ProgramExport?groovyProgram='calc.exe'.execute()       
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvFDPXIaFLEctbiaoAq5REPFCBK5BALF1g8Ky22cQI5OicDzv0lkdo4RZA/640?wx_fmt=png "")  
  
其中  
/ListTimezones  
部分是可替换的，在 common-comtroller.xml 中，只要满足  
auth="false"  
、以及  
success  
响应结果对应  
type="view"  
的 uri 都可以进行利用。比如这些：forgotPassword、ListSetCompanies、showHelpPublic、getUiLabels、ListTimezones、ListLocales。  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvvZSGibHJQOVbefNQgLMC21cqTlzovgdO0SgZIUbOgxDUKv7blQ7wVVQ/640?wx_fmt=png "")  
  
18.12.13 版本中，在 security.properties 中的黑名单里新增了  
execute  
等关键字；  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvricHU0UbUvffVBY57icyu8iayxibOb52c5PwWpGrqzyKHRYfic7vdkwWjyg/640?wx_fmt=png "")  
  
所以 18.12.13 和 18.12.14 版本的 payload 需要对   
groovyProgram  
 参数内容进行编码传入来绕过黑名单校验。  
```
/webtools/control/ListSetCompanies/ProgramExport            

groovyProgram=\u0027\u0063\u0061\u006c\u0063\u002e\u0065\u0078\u0065\u0027\u002e\u0065\u0078\u0065\u0063\u0075\u0074\u0065\u0028\u0029
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvmDrTosGBeBuCMBXFPfqBN1GCSuudNNgoXWhvddGRv0SruVH63FkEbw/640?wx_fmt=png "")  
  
uri   
ListTimezones  
的  
 auth  
 改为了 true，不能进行利用了，不过其他的 uri 仍然可以利用。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvUtu4ibeeC3JCJscjfHHwOlVJU7bZGMxrVbAR8ekWUibatMCZSNmLevNA/640?wx_fmt=png "")  
  
4. 漏洞分析  
  
接下来以 18.12.12 版本为例分析看看，如果请求的路径为  
/webtools/control/ListTimezones/./ProgramExport  
，在 ControlFilter.doFilter() 中，getRequestURI() 首先获取到的是  
/control/ListTimezones/./ProgramExport  
，经过规范化后去除了其中的  
.  
，变成了  
/control/ListTimezones/ProgramExport  
。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IveickNcYDZXyAJ23pibp9mviaGKh0KIkRibYYplWcPa1AWht749gYW3zBHw/640?wx_fmt=png "")  
   
  
所以特殊符号在这一步都会被过滤掉，18.12.13 以及 18.12.14 版本的补丁都在围绕这一块代码进行修改补充，不过这并不是关键所在。  
  
  
  
接着断点 ControlServlet.doGet()，这时 request 中的路径就为  
/webtools/control/ListSetCompanies/ProgramExport  
。     
         
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6Iv8EDjHSFZMicU68wefkXIthMuZ5QOELpInA1NLbud4B9DNSibjcqPvAYQ/640?wx_fmt=png "")  
  
跟进 RequestHandler.doRequest()，看获取到的几个路径参数，path 为  
/ListSetCompanies/ProgramExport  
，requestUri 取的是 path 的第一部分  
ListSetCompanies  
，overrideViewUri 取的是路径的第二部分  
ProgramExport  
，如果没有就为 null；  
  
rmaps 为  
ListSetCompanies  
对应的 requestMap，其中   
securityAuth  
 属性为 false。   
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvhZXXWSRPm7akqQMQy4c5EJ8T2Xhz93hw72AsoXXeibcoguPba9ibcm7A/640?wx_fmt=png "")  
   
  
继续向下看，到判断   
securityAuth  
 的值，为 false 则不进入 if 分支，也就不会调用 LoginWorker.checkLogin() 进行登录验证。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvKkImn3BbFmdsZoE8yuq9mJkiclicib3we2MN5JuGlR2TX9kel4tkV4ibQA/640?wx_fmt=png "")  
  
获取 requestMap 中   
success  
 的响应数据，然后赋给 nextRequestResponse，其中   
type  
 为view  
，下面进入 view 的分支；此时 eventReturn 的值是 null，740 行的逻辑表达式为 true，视图名称得到 overrideViewUri 的值  
ProgramExport  
，关键就在这里，将路径的第二部分作为视图名称赋值，后面就是进行视图渲染。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvicRe76lfdrTBc8aRZZEGvKebUA6hoVOxZewiah2rDFsKoXv4NibmfKYLQ/640?wx_fmt=png "")  
  
获取传入的   
groovyProgram  
 参数值，从 \framework\webtools\webapp\webtools\WEB-INF\controller.xml 中找到 ProgramExport 的视图信息定义在   
component://webtools/widget/EntityScreens.xml#ProgramExport  
 文件中。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6Iv9hYiaQHJ7bSToMMpOl4OG4NHQRJSAg7BLDhxgakjCqBBUibILxZc7aAA/640?wx_fmt=png "")  
  
获取到 screen 类型的视图处理器。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvjyibXzxZQic6vqU4whc8gibgcLicfcia1lO4xWSLQV1BzicjmwndoptvWtMg/640?wx_fmt=png "")  
      
  
一直跟进，从 EntityScreens.xml 中获取到了ProgramExport对应的脚本文件位置   
component://webtools/groovyScripts/entity/ProgramExport.groovy  
 ，当遍历到此文件时跟进。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvTDb6sd2Emobo4tBYtKLFXzPaV9tqbkXGbddp7T2qxLo5Z64B3dKzibw/640?wx_fmt=png "")  
  
检测到  
.groovy  
后缀，进入 ProgramExport.groovy 文件，执行   
groovyProgram  
 参数的命令。  
   
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvARQsDOaiclYfWg7pIWOpW1yHmtrmPRay883AdsAibib3iaGORrvricaoyTQ/640?wx_fmt=png "")  
  
5. 补丁分析  
  
**18.12.13版本：**  
    
主要体现在将  
ListTimezones  
的   
auth  
 改为 true，黑名单里增加  
execute  
关键字，ControlFilter.doFilter() 中校验了规范化前后的 url 是否一致，以此来判断 url 是否含有特殊字符。  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6IvicexbU1l3HPa7zQ2BTctpVKCsXJSzCOlubmv7nXpENqw5GpS4H0Hj9g/640?wx_fmt=png "")  
   
  
**18.12.14版本：**  
  
网上使用的 payload 是将  
.  
换为  
%2e  
或  
;  
来绕过 18.12.13 版本的修复代码，于是官方在 18.12.14 版本的 ControlFilter.doFilter() 中添加过滤了  
%2e  
和  
;  
，不过仍然没有修复到问题关键。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57N7FbtCB2G660pzdLdhz6Iv674CBTqk7DHNISlvDpoVibhDxiccy9lAT9aum0SyloWKsbO2apLjO60w/640?wx_fmt=png "")  
      
  
