#  CVE-2018-17066复现（D-Link命令注入漏洞）   
Loserme  看雪学苑   2024-06-08 17:59  
  
CVE-2018-17066漏洞概述：  
在该路由的前端页面中存在时间设置页面，但是我们手动输入的时间并没有被过滤，就会直接将数据传输到后端处理，经过一段函数调用后会将参数传入system作为参数从而实现命令注入！  
（任意命令执行）  
  
  
环境准备：kali2023因为自带bp不用安装了！  
  
  
利用链：前端发送post请求将时间数据发送给后端-》websOpenListen监听请求-》收到请求后使用sub_4572A4函数进行时间设置-》由于未进行任何过滤导致doSystem("date -s \"%s\"", Var);  
会直接将传入的参数作为system的参数-》从而实现命令注入！  
  
  
  
```
```  
  
  
  
固件下载地址：  
D-Link Technical Support (dlink.com.cn)  
  
（http://www.dlink.com.cn/techsupport/ProductInfo.aspx?m=DIR-816）  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5J92Fm1a3fLg8KGbhc01LzIXjcVIwfhh8ZIhCV2lhfQ1z2gianexq0dw/640?wx_fmt=png&from=appmsg "")  
  
  
下载后就可以检查一下文件的属性了：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5vED5eSJDgS0Bu8fqowEMQbDdibtQsZL72UfKLkdKPazib6oOAEbwgK9g/640?wx_fmt=png&from=appmsg "")  
  
  
文件属性:U-Boot: OS Kernel Image("Linux Kernel Image")[Linux,MIPS,lzma]  
  
  
直接到Ubuntu里面提取一下固件文件：  
  
  
```
```  
  
  
·binwalk 是一种常用于数字取证和二进制分析的工具。你提供的命令 binwalk -Me DIR-816.img 是用来执行 binwalk 的特定操作的。下面解释一下命令中每个部分的含义：  
  
  
◆binwalk：这是命令本身，表示你想要使用 binwalk 工具。  
  
◆-Me：这些是修改 binwalk 行为的选项或标志。具体来说，-M 告诉 binwalk 在发现文件时自动提取它们，-e 告诉它递归地从其他文件中提取文件。  
  
◆DIR-816.img ：这是你想要 binwalk 分析并从中提取文件的文件或目录的名称。  
  
  
提取出来的文件：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5F6HUK7CYheBFDJPocPlpkF47hlwvK18dRrM1WE2BwvEh4ZiaiabrgH3w/640?wx_fmt=png&from=appmsg "")  
  
  
SquashFS 是一套基于Linux内核使用的压缩只读文件系统。该文件系统能够压缩系统内的文档,inode以及目录，文件最大支持2^64字节，简介：  
squashfs介绍和安装_unsquashfs-CSDN博客（https://blog.csdn.net/mayue_web/article/details/105682004）  
  
squashfs-root就是我们需要找到的根目录！  
  
  
  
```
```  
  
  
  
我们主要分析的是goahead：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5pZDR0cJRnK2CkkpPuTFgCibCa3NoZthH3FzjJBmITxF4dJU37Def1AA/640?wx_fmt=png&from=appmsg "")  
  
  
查看一下goahead的属性和链接：  
  
  
```
```  
  
  
  
两种启动方法：  
  
  
```
```  
  
##   
## goahead.pid未找到报错  
  
  
运行后发现报错！  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5d75d7N1b7FvVlUJ4LkMoRp8Rn09ciaM6zuxCJ7L0cudMVKIIvbLx67g/640?wx_fmt=png&from=appmsg "")  
  
  
在ida找到该字符串：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5Zq3lAsuF2TeAxQSDj1b5OVKHBEH7RDzIibLPCWOdnaMKd30iaeax63pQ/640?wx_fmt=png&from=appmsg "")  
  
  
分析该文件的报错原因是因为没有"/var/run/goahead.pid"  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5ia9TYichsgZySO6B3jHdOwLx32xJB3o2gUneQck8qrpqgG2XN3rP3j3A/640?wx_fmt=png&from=appmsg "")  
  
  
解决方案手动创建一个：  
  
  
```
```  
  
##   
## var/run/nvramd.pid未找到报错  
  
  
完成第一个报错修复后重新仿真程序，程序继续执行时出现错误："waiting for nvram_daemon"，如下图所示。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq56Shs4okaPKz4xfw2YLicvUxrWd01eFzKxf4y5yNoxP0pyLtvSKic3BIQ/640?wx_fmt=png&from=appmsg "")  
  
  
根据ida继续找到字符串，发现不可以使用交叉引用，大概率是因为进行了混淆！  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5vxfLUEMb43AHoUplicrFibD0qVgrNQutKRicoAslAwAkdyDwU8k9yIwKQ/640?wx_fmt=png&from=appmsg "")  
  
  
根据下面的字符串"goahead.c"的交叉引用找到了目标位置！还可以通过动态调试来定位！  
  
分析发现原因,这两个字符串是通过偏移来定位的，还发现个问题这里的fopen的第二个参数是再调用fopen后才传入的不理解：  
  
  
```
```  
  
  
  
这里就算IDA的伪代码了！  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5NA7ibAnHJRibXOGDWdxBX7Yqv79DVuGH2SpJfuJ7vux0KYECz84BGt3Q/640?wx_fmt=png&from=appmsg "")  
  
  
解决方案继续手动创建文件。  
  
```
```  
  
##   
## 缺少二进制ip数据报错  
  
  
继续运行发现有很多东西不存在继续创建，再看下最主要的报错是：  
  
initWebs: failed to convert to binary ip data，缺少二进制ip数据。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq52Y9QBDllMjkglOhnOhMSdtE7GAjj8ZLU77FbDYPkxKcD1BMN3ibjP0A/640?wx_fmt=png&from=appmsg "")  
  
  
根据字符串锁定位置：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5fsbAvMSMWsibEN0ZMxS9z6VHVPPRUCuv4E7MMLk20lkyiaWHCnX96fxw/640?wx_fmt=png&from=appmsg "")  
  
  
报错原因：nvram_bufget函数无法读取lan_ipaddr，而nvram_bufget是从/dev/nvram中读取数据。  
  
  
```
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5yiciahdv3ZGQ53a49YDy9yZF3a5VQmxaKiaPwYEWlGjIv5IWhY2EzTtjg/640?wx_fmt=png&from=appmsg "")  
  
  
这里的解决方案：  
  
  
1.  
RT-AX55环境搭建 | ioo0s's blog  
  
（https://ioo0s.art/2023/02/20/RT-AX55%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/）  
  
  
2.  
pr0v3rbs/FirmAE：面向物联网固件的大规模仿真，用于动态分析 --- pr0v3rbs/FirmAE: Towards Large-Scale Emulation of IoT Firmware for Dynamic Analysis (github.com)  
  
（https://github.com/pr0v3rbs/FirmAE）  
  
  
还有其他解决方案：  
  
1.**解劫持动态链接库**  
  
2.**patch**原程序来实现  
  
### a. 使用LD_PRELOAD方式劫持动态链接库实现nvram设备的模拟（实现失败原因未知）  
  
  
由于报错函数是nvram_bufget所以我们只需要劫持这个函数所在的so文件我们就可以实现正常的ip地址获取了！  
  
FirmAE提供的libnvram库源码：  
FirmAE/sources/libnvram/config.h at master · pr0v3rbs/FirmAE (https://github.com/pr0v3rbs/FirmAE/blob/master/sources/libnvram/config.h)  
  
为了适配环境做一些相应的修改：  
  
  
1.修改config.h的挂载路径  
  
  
```
```  
  
  
  
2.修改config.h中启动web页面的ip地址  
  
  
```
```  
  
  
  
接下来成功编译：  
  
  
```
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5wktoibicALSsr2eeaCaEPrhYXTzFEiaMuDefdy2mEmSag8u2qIZQLvkgA/640?wx_fmt=png&from=appmsg "")  
  
  
经过上面的步骤发现网卡不对，在ubnutu上网卡为ens33，还是切换到kali进行实现步骤如上：  
  
  
```
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5jrzJ8yW5GBVTRopsAOmHzXxvVGiaO8V6BPkxoKdsicAw0MRiaG07d8nnQ/640?wx_fmt=png&from=appmsg "")  
###   
### b.patch 原程序来实现  
  
  
先ida动态调试一下手动修改值：  
  
  
```
```  
  
  
  
IDA动态调试附加上这个端口！  
  
修改地址：0x45CDD4 （将v0的赋值修改为0，就不会报错了）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5xoNdTPXsCqF1sN1ndriakT3bdpKfFXY6lpicNfY6T1bttic5ibduSEVHqg/640?wx_fmt=png&from=appmsg "")  
  
  
成功运行之后就会出现登录页面，在浏览器访问ip地址后：  
  
  
```
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5s6tbkrITd3S7bYWq2KHt84EzOZEWY5OjPY9paOakfOW1puta1k6auA/640?wx_fmt=png&from=appmsg "")  
  
  
成功！  
  
  
  
```
```  
  
  
  
在这里需要绕过路由的账号和密码！  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5KwA1xicNNDyhQInLvIHQpueI0wwo7U1DNsB9ibLFHfMw5DckDmco07mA/640?wx_fmt=png&from=appmsg "")  
  
  
有两种方式可以绕过：  
  
## 1.修改前端的asp页面的js代码  
  
```
```  
  
  
  
找到这个页面并且修改里面的前端检验逻辑，将非空检查这些代码去除：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5rkVOUicVd5uGWYb4sia9ur2FNmZQBVnrjKXLKGwIYHP9sRSgRWH3KVEA/640?wx_fmt=png&from=appmsg "")  
  
```
```  
  
  
  
这样就可以成功绕过！将账号密码都置空，从而绕过strcmp的对比！  
  
## 2.动态调试修改strcmp的比对结果  
  
  
成功锁定函数：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5JnNVAHuxsZofTboFSBjcy4Hqlicxcx8CDrcuQWuKOVa3UWiatGKicWkUQ/640?wx_fmt=png&from=appmsg "")  
  
  
在该位置下断点并且修改v0为0。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5GZm8euNWMicNStZhJRIIcd3KLiawZ6c5UVjosc6xaTRdczicm827AtecA/640?wx_fmt=png&from=appmsg "")  
##   
## 3.登录界面前后端通信原理  
  
  
（1）前端js代码通过submit提交post请求将参数传给后端来处理。  
  
  
（2）后端通过websOpenListen函数持续监听前端发送过来的post请求并进行处理。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5RtGQrxltIxcAD3lRZy8IBxEDebhDIcHI1icZoy2Y4icoJVK2VUrNdL0w/640?wx_fmt=png&from=appmsg "")  
  
  
（3）成功处理后，后端会发送新的页面信息给前端，实现前端页面跳转！  
  
  
  
```
```  
  
  
  
成功登入之后就可以访问访问：  
  
  
```
```  
  
  
  
由于kali2023自带bp，所以可以直接使用bp拦截实现命令注入：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5klJr07yHwDf0cRR3icVJcKnhjNOTz0yHV1RdMcVibu24HlJiaicacBMY9A/640?wx_fmt=png&from=appmsg "")  
  
  
将ls  
写入date数据段，实现命令注入成功！  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5NZUsodYibLdLAGXfOcBaqm3ysLWYpbboj59tWU7mQx9WFSiaKhKicm3icA/640?wx_fmt=png&from=appmsg "")  
#   
  
  
```
```  
  
  
  
通过拼接字符串将ls嵌入命令中实现任意命令执行！  
  
linux知识点：  
  
```
```  
  
  
  
反引号用于命令替换，即在反引号内的命令会先执行，其输出结果会替换反引号的内容。现代脚本中，推荐使用$()  
形式，因为它更易读且支持嵌套。  
  
  
```
```  
  
  
  
利用链：  
前端发送post请求将时间数据发送给后端-》websOpenListen监听请求-》收到请求后使用sub_4572A4函数进行时间设置-》由于未进行任何过滤导致doSystem("date -s \"%s\"", Var);  
会直接将传入的参数作为system的参数-》从而实现命令注入！  
  
  
  
  
**借鉴复现笔记：**  
  
  
1.cve-2018-17066复现 | 1uckyc's blog  
  
（https://1uckyc.github.io/2023/11/24/cve-2018-17066%E5%A4%8D%E7%8E%B0/）  
  
  
2.DIR-816 模拟执行与命令注入漏洞分析 - IOTsec-Zone  
  
（https://www.iotsec-zone.com/article/213）  
  
  
3.VulInfo/D-Link/DIR-816/cmd_injection_0/README.md at master · PAGalaxyLab/VulInfo (github.com)  
  
（https://github.com/PAGalaxyLab/VulInfo/blob/master/D-Link/DIR-816/cmd_injection_0/README.md）  
  
  
4.物联网终端安全入门与实践之玩转物联网固件（中） - SecPulse.COM | 安全脉搏  
  
（https://www.secpulse.com/archives/188250.html）  
  
  
5.Debugging D-Link: Emulating firmware and hacking hardware (greynoise.io)  
  
（https://www.greynoise.io/blog/debugging-d-link-emulating-firmware-and-hacking-hardware）  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GBZd5xTCLXGkoCY0UbpMq5Zs8RMC0VyQC6gk3H9Q93GBLKV3RdlcCA8IHs1MSrWUXzpPlSWkpVgA/640?wx_fmt=png&from=appmsg "")  
  
  
**看雪ID：Loserme**  
  
https://bbs.kanxue.com/user-home-970470.htm  
  
*本文为看雪论坛优秀文章，由 Loserme 原创，转载请注明来自看雪社区  
  
  
[](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458553456&idx=3&sn=11b55ee464d5aecd37fb4c5bc4dab5da&chksm=b18dbcfa86fa35ecef07864a534f85924153d8b32a403a57e2f3f2d5c266ce199c02bbcb9434&scene=21#wechat_redirect)  
  
  
  
**# 往期推荐**  
  
1、[Windows主机入侵检测与防御内核技术深入解析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458555047&idx=1&sn=b7632036b11bc28f1e89204e8856079d&chksm=b18da22d86fa2b3bdd31bb0aaea1817551ba8b9cc1f10dd36dead922533bcf6d6552b6e09788&scene=21#wechat_redirect)  
  
  
2、[BFS Ekoparty 2022 Linux Kernel Exploitation Challenge](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554994&idx=1&sn=816559a8984c0ab9a1ab518c41660dcb&chksm=b18da2f886fa2bee97e29087abdc65fe2d4b725c29752b7bbf93f3555222d973c10075127d4b&scene=21#wechat_redirect)  
  
  
3、[银狐样本分析](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554906&idx=1&sn=271d52cc31bff5aadaba023dd2db8fe3&chksm=b18da29086fa2b861941c8eac1e53923a283cf1994b2814f0b8af5475d7e705df3c9d44c860b&scene=21#wechat_redirect)  
  
  
4、[使用pysqlcipher3操作Windows微信数据库](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554736&idx=1&sn=5a5cb13286a428dde51b17cfffd83312&chksm=b18da1fa86fa28ec7b7b4637e502485e2d6ed36b15e4a175313a5ee5614cda46a142b12419bd&scene=21#wechat_redirect)  
  
  
5、[XYCTF两道Unity IL2CPP题的出题思路与题解](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458554671&idx=2&sn=5ef35adeb8c4c890e2763e1630c7d20c&chksm=b18da1a586fa28b38f6a6fa1aa064d0c4dbc9d884039aef8510f6c9c53627a4554f155f3c6f9&scene=21#wechat_redirect)  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78321RiaLpp3FAylJv0nbibloCFmXdVe4wvW4ibgnCc6srNI8sGBkX14MpQ/640?wx_fmt=gif&from=appmsg "")  
  
**球分享**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78321RiaLpp3FAylJv0nbibloCFmXdVe4wvW4ibgnCc6srNI8sGBkX14MpQ/640?wx_fmt=gif&from=appmsg "")  
  
**球点赞**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78321RiaLpp3FAylJv0nbibloCFmXdVe4wvW4ibgnCc6srNI8sGBkX14MpQ/640?wx_fmt=gif&from=appmsg "")  
  
**球在看**  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8GJubmq65v9uBFmEJuoJD78txPhfvI9WpuGSCawCN8NJCgzD16Y0IwdUkaI33Qr3DpwRRuvibgRQOg/640?wx_fmt=gif&from=appmsg "")  
  
点击阅读原文查看更多  
  
