#  【二次通告】PHP CGI Windows平台远程代码执行漏洞(CVE-2024-4577)   
深瞳漏洞实验室  深信服千里目安全技术中心   2024-06-13 16:48  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g5myL1vQcutsaz8aDibHD6deb87xdIwd1YdCgDbWM7uO1sfgTtJ4vY2eA/640?wx_fmt=gif&from=appmsg "")  
  
**漏洞名称：**  
  
PHP CGI Windows平台远程代码执行漏洞(CVE-2024-4577)  
  
**组件名称：**  
  
PHP语言  
  
**影响范围：**  
  
PHP8.3 < 8.3.8  
  
PHP8.2 < 8.2.20  
  
PHP < 8.1.29  
  
由于 PHP 8.0、PHP 7 和 PHP 5 的分支已终止使用，并且不再维护，服务器管理员可以参考“缓解方案”中的临时补丁建议。  
  
**漏洞类型：**  
  
代码注入  
  
**利用条件：**  
  
1、用户认证：无需用户认证  
  
2、前置条件：默认配置  
  
3、触发方式：远程  
  
**综合评价：**  
  
<综合评定利用难度>：容易，能造成远程代码执行。  
  
<综合评定威胁等级>：严重，能造成远程代码执行。  
  
**官方解决方案：**  
  
已发布  
  
  
  
  
**漏洞分析**  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g58UWyW3tMzoX6atuZnsdg53GlicLNL5seCxT8hgbBOtsakziajT5y9P4g/640?wx_fmt=gif&from=appmsg "")  
  
**组件介绍**  
  
PHP是一种流行的通用脚本语言，特别适合 Web 开发。PHP 快速、灵活且实用，为从您的博客到世界上最流行的网站的一切提供支持。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g58UWyW3tMzoX6atuZnsdg53GlicLNL5seCxT8hgbBOtsakziajT5y9P4g/640?wx_fmt=gif&from=appmsg "")  
  
**漏洞简介**  
  
  
2024年6月7日，深瞳漏洞实验室监测到一则PHP语言组件存在代码注入漏洞的信息，漏洞编号：CVE-2024-4577，漏洞威胁等级：严重。  
  
PHP语言在设计时忽略了Windows对字符编码转换的 Best-Fit 特性，导致**未授权的攻击者可以通过特定字符串绕过 CVE-2012-1823 补丁，执行任意PHP代码，导致服务器失陷。**  
  
  
  
**在野攻击事件猎捕**  
  
  
该漏洞在网上公开披露后，深信服深盾实验室第一时间进行在野攻击事件猎捕，发现自6月7号该漏洞细节披露后，出现了多起以该漏洞为攻击向量的在野攻击事件，事件详情如下。  
  
  
**1. LemonDuck挖矿攻击事件**  
  
LemonDuck团伙通过该漏洞执行webshell命令，下载初始PS脚本，最终释放xmrig挖矿模块和后门模块。  
  
   
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g5icVN1DsOknDrUACF3ycAcPVBK5hs620iaOCqLBpDXic8gTkSzN6JhcGZQ/640?wx_fmt=png&from=appmsg "")  
  
  
**2. Lucifer DDoS挖矿攻击事件**  
  
攻击者通过该漏洞执行了一个存放在失陷服务器上的恶意BAT脚本。  
  
   
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g53WXIzjRdUjKHZ8RB1lwbpCia50gG53562MbOwsKWjIKdGZBicZD5Zsng/640?wx_fmt=png&from=appmsg "")  
  
  
脚本最终下载了xmrig挖矿程序。通过查看该攻击者使用的钱包发现，近期有大量受害者的机器被植入了该矿机进程。  
  
   
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g59WKt4zAO7myrb5k3Q4KkFNpOX3cLZibg7s7QbA2VPI7hiboKBVHicYSFA/640?wx_fmt=png&from=appmsg "")  
  
  
**3. Tellyouthepass勒索攻击事件**  
  
攻击者通过该漏洞执行远程恶意hta脚本，最终释放Tellyouthepass勒索病毒。  
  
   
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g5XjVfuC3qmgYzTIicWtaibOPQRicw1wZW3AJWUTTN2PicsmSKvjGic2OJeBg/640?wx_fmt=png&from=appmsg "")  
  
  
**4. 未知攻击事件**  
  
**（1）使用开源矿机安装脚本进行挖矿攻击**  
  
未知挖矿团伙通过该漏洞直接执行xmrig矿机安装脚本。安装xmrig矿机进行挖矿操作。  
  
   
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g5ic8KleicYqNrSHG4tDiaLAvYZWzgb0jVBo4AZJLicTCq5CgpmcgA9EuAaQ/640?wx_fmt=png&from=appmsg "")  
  
  
**（2）通过certutil.exe植入后门模块**  
  
未知灰产团伙通过Windows系统自带的凭据管理工具certutil下载并执行远控木马。  
  
   
   
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g5aFMvlLpB4eSrO3jrWJpulpviaUKNBcwRhT6O5Zic8q2icjyVTJCgibuJUg/640?wx_fmt=png&from=appmsg "")  
  
  
**（3）新建任意文件上传的后门PHP模块**  
  
未知灰产团伙通过该漏洞在目标服务器上上传任意文件上传的PHP后门模块，开展后续的攻击行为。  
  
   
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g56PfyicLhYvf6NmZN4iaiaKHJRZZJafQzz5r8ZhibUdVsGMUZMjU2xOuTLQ/640?wx_fmt=png&from=appmsg "")  
  
  
  
**IOC列表**  
  
**LemonDuck**  
  
http://d[.]0000o[.]xyz:88/k  
  
http://t[.]0000o[.]xyz:88/javaw[.]exe  
  
http://t[.]0000o[.]xyz:88/we64[.]exe  
  
http://t[.]0000o[.]xyz:88/we32[.]exe  
  
94cea9d774bd6b4480faeebf53864861  
  
6715d1e8d68b1c657e93009d1c627f2e  
  
bc33ed02b3bfe04aa186819c46a6b1b3  
  
8bd4e1e4d1cec04d05edf83b4c06769f  
  
  
**Lucifer DDoS**  
  
http://img6[.]tuwan[.]com/9e9cdf6b-8471-4d2c-b422-8de1221d37f6[.]txt/test[.]bat'  
  
http://img6[.]tuwan[.]com/9e9cdf6b-8471-4d2c-b422-8de1221d37f6[.]txt/xmrig[.]exe  
  
http://img6[.]tuwan[.]com/9e9cdf6b-8471-4d2c-b422-8de1221d37f6[.]txt/configjashgddfh[.]json  
  
http://img6[.]tuwan[.]com/9e9cdf6b-8471-4d2c-b422-8de1221d37f6[.]txt/Wi[.]png  
  
  
**Tellyouthepass**  
  
http://88[.]218[.]76[.]13/dd3[.]hta  
  
http://88[.]218[.]76[.]13/d3[.]hta  
  
  
**未知攻击事件**  
  
http://20[.]2[.]85[.]7/up[.]txt  
  
http://118[.]178[.]128[.]69/alone/1[.]txt  
  
http://185[.]72[.]9[.]5:80/  
  
http://154[.]201[.]91[.]59:44557/system64[.]exe  
  
http://tsdwater[.]cn/runtime/cache/uad[.]txt  
  
http://118[.]178[.]128[.]69/alone/1[.]txt  
  
http://154[.]201[.]91[.]59:44557/phpab[.]exe  
  
http://218[.]57[.]129[.]51/b3[.]exe  
  
http://147[.]50[.]253[.]109:44119/phps[.]exe  
  
http://61[.]160[.]213[.]14:48596/nbsf[.]exe  
  
http://124[.]156[.]132[.]142:6658/apache[.]exe  
  
http://118[.]191[.]128[.]75/wa[.]exe  
  
  
**影响范围**  
  
目前受影响的PHP语言版本：  
  
PHP8.3 < 8.3.8  
  
PHP8.2 < 8.2.20  
  
PHP < 8.1.29  
  
由于 PHP 8.0、PHP 7 和 PHP 5 的分支已终止使用，并且不再维护，服务器管理员可以参考“缓解方案”中的临时补丁建议。  
  
  
**解决方案**  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g58UWyW3tMzoX6atuZnsdg53GlicLNL5seCxT8hgbBOtsakziajT5y9P4g/640?wx_fmt=gif&from=appmsg "")  
  
**如何检测组件系统版本**  
  
  
通过php -v查看当前php版本  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g5RkxhmtACpIodBeVbD90kLHJOIjgN4Z1GchfFYiau8utLBqGy0tpJOyg/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g58UWyW3tMzoX6atuZnsdg53GlicLNL5seCxT8hgbBOtsakziajT5y9P4g/640?wx_fmt=gif&from=appmsg "")  
  
**官方修复建议**  
  
  
将PHP升级到官方最新版本 8.3.8、8.2.20和8.1.29。下载链接：https://www.php.net/downloads.php  
  
  
**缓解方案：**  
  
1.不方便更新版本的Windows用户，建议暂时关闭php-cgi的使用。  
  
  
2.以下重写规则可用于阻止攻击。需要注意的是，这些规则仅对繁体中文、简体中文和日语语言环境起到临时缓解作用。在实际操作中，仍然建议更新到补丁版本或迁移架构。  
  
RewriteEngine On  
  
RewriteCond %{QUERY_STRING} ^%ad [NC]  
  
RewriteRule .? - [F,L]  
  
  
3. 对于使用 XAMPP for Windows 的用户：  
  
如果确认不需要 PHP CGI 功能，可以通过修改以下 Apache HTTP Server 配置来避免受到该漏洞的影响：  
  
C:/xampp/apache/conf/extra/httpd-xampp.conf  
  
找到相应的行：  
  
ScriptAlias /php-cgi/ "C:/xampp/php/"  
  
并将其注释掉：  
  
# ScriptAlias /php-cgi/ "C:/xampp/php/"  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g58UWyW3tMzoX6atuZnsdg53GlicLNL5seCxT8hgbBOtsakziajT5y9P4g/640?wx_fmt=gif&from=appmsg "")  
  
**深信服解决方案**  
  
  
**1.风险资产发现**  
  
支持对PHP语言的主动检测，可批量检出业务场景中该事件的**受影响资产**情况，相关产品如下：  
  
**【深信服主机安全检测响应平台CWPP】**已发布资产检测方案。  
  
**【深信服云镜YJ】** 已发布资产检测方案。  
  
  
**2.漏洞主动检测**  
  
支持对PHP CGI Windows平台远程代码执行漏洞(CVE-2024-4577)的主动检测，可批量快速检出业务场景中是否存在**漏洞风险**，相关产品如下：  
  
**【深信服云镜YJ】**预计2024年06月13日发布检测方案。  
  
**【深信服漏洞评估工具TSS】**预计2024年06月13日发布检测方案。  
  
**【深信服安全托管服务MSS】**预计2024年06月13日发布检测方案（需要具备TSS或CWPP组件能力）。  
  
**【深信服安全检测与响应平台XDR】**预计2024年06月13日发布检测方案（需要具备云镜或CWPP组件能力）。  
  
  
**3.漏洞安全监测**  
  
支持对PHP CGI Windows平台远程代码执行漏洞(CVE-2024-4577)的监测，可依据流量收集实时监控业务场景中的**受影响资产情况，快速检查受影响范围**，相关产品及服务如下：  
  
**【深信服安全感知管理平台SIP】**已发布监测方案。  
  
**【深信服安全托管服务MSS】**已发布监测方案（需要具备SIP组件能力）。  
  
**【深信服安全检测与响应平台XDR】**已发布监测方案。  
  
  
**4.漏洞安全防护**  
  
支持对PHP CGI Windows平台远程代码执行漏洞(CVE-2024-4577)的防御，**可阻断攻击者针对该事件的入侵行为**，相关产品及服务如下：  
  
**【深信服下一代防火墙AF】**已发布防护方案（需开启WAF配置）。  
  
**【深信服Web应用防火墙WAF】**已发布防护方案。  
  
**【深信服安全托管服务MSS】**已发布防护方案（需要具备AF组件能力）。  
  
**【深信服安全检测与响应平台XDR】**已发布防护方案（需要具备AF组件能力）。  
  
  
  
**参考链接**  
  
  
https://devco.re/blog/2024/06/06/security-alert-cve-2024-4577-php-cgi-argument-injection-vulnerability/  
  
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-4577  
  
https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-ucoderef/d1980631-6401-428e-a49d-d71394be7da8  
  
  
**时间轴**  
  
  
  
**2024/6/7**  
  
深瞳漏洞实验室监测到PHP CGI Windows平台远程代码执行漏洞信息。  
  
  
**2024/6/7**  
  
深瞳漏洞实验室发布漏洞通告。  
  
  
**2024/6/13**  
  
深瞳漏洞实验室发布在野攻击事件猎捕结果。  
  
  
点击**阅读原文**，及时关注并登录深信服**智安全平台**，可轻松查询漏洞相关解决方案。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/w8NHw6tcQ5xQwCHyLQzmau3ewWu278g51iaXCVO3bib7o84e6cKCm80cbr37vwwnqvcLaaTbtB8dMz8B7aMSribIw/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/w8NHw6tcQ5zvcIHbwGGYKbqDVYsVKzNNia1jYtHf49C7133AlDXAgex2W4lFvpia56tjQQDkiauNBrl08YbxqG01A/640?wx_fmt=jpeg&from=appmsg "")  
  
  
