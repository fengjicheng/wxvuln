#  TeamCity身份验证绕过漏洞分析（CVE-2024-23917、CVE-2024-27198、CVE-2024-27199）   
原创 元亨-blckder02  中孚安全技术研究   2024-03-27 18:16  
  
1. 前言  
  
**1-1. 简介**  
  
TeamCity是一款由JetBrains开发的持续集成和持续交付（CI/CD）服务器。它提供了一个强大的平台，用于自动化构建、测试和部署软件项目。TeamCity支持多种编程语言和开发环境，并提供了丰富的功能和工具，帮助开发团队构建和交付高质量的软件。  
  
本文简单分析了三个身份验证绕过的漏洞CVE-2024-23917、CVE-2024-27198、CVE-2024-27199。  
  
  
**1-2. 环境搭建**  
  
下载地址：  
https://blog.jetbrains.com/teamcity/2024/02/critical-security-issue-affecting-teamcity-on-premises-cve-2024-23917/  
  
下载对应版本的 TeamCity，按引导进行安装。  
  
创建管理员账号。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpoSewaGVhCsvoPicRLz73kU5GDdM0Y2YBphrzaAfRxg5I0CXGF8lrdZw/640?wx_fmt=png "")  
  
  
  
  
2. CVE-2024-23917  
  
**官方公告**  
  
https://blog.jetbrains.com/teamcity/2024/02/critical-security-issue-affecting-teamcity-on-premises-cve-2024-23917/  
  
**漏洞描述**  
  
该漏洞会使未经身份验  
证的攻击者能够通过 HTTP(S) 访问 TeamCity 服务器来绕过身份验证检查并获得对该 TeamCity 服务器的管理控制。  
  
**影响版本**  
  
2023.11.2 及之前版本      
  
**2-1. 漏洞复现**  
  
未登录状态下访问  
/app/rest/server  
会跳转到登录页面，需要进行身份验证。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpezuPjT4SMQsqqt3ssLM4dQfrS8ickwQqKIicmMtKGVicnTaI3CDibfTl1Q/640?wx_fmt=png "")  
  
  
构造 URL 为  
/app/rest/server;.jsp?jsp_precompile=1  
，能绕过身份验证，成功获取到目标内容。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpwA928qwNbtrdENia4N2xd0c3Wtjmjdg8ofichAgBS9xFZHvSC9sCIrSg/640?wx_fmt=png "")  
  
  
  
**2-2. 漏洞分析**  
  
在 buildServerSpringWeb.xml 中列出了不需要身份认证就能访问的路径；    
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpLZtsaD7JpDBIV7xcmE1SV844KWggJtEXZgGaBYw5md0ibYJTdmHGZ6g/640?wx_fmt=png "")  
  
  
jetbrains.buildServer.server.rest.APIController 中声明了  
/app/rest/  
路径下的"/builds/  
/statusIcon  
", "/builds/aggregated/  
/statusIcon  
", "/server/version", "/version", "/apiVersion", "/swagger**", "/server/nodes"这些不需要身份认证。  
  
声明了 MVC 用到的拦截器，其中 AuthorizationInterceptorImpl 是进行身份校验的拦截器。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpSmQmY6qEkfH4M67W5k06fibTDtkfl8Afy9SIiaR1sVeX9ntFfGqibbKIA/640?wx_fmt=png "")  
  
  
进入 RequestInterceptors 拦截器，会进行一个 if 判断，若判断为 false 则会进入 else 遍历它下面的其他拦截器，进而调用到 AuthorizationInterceptorImpl。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpJwq89QmovEMTenWC1iaZ5oVvh4mhsia7Da0gdkpziaPcS91Pyg4Bg1piag/640?wx_fmt=png "")  
  
  
若要 if 判断为真，则  
this.requestPreHandlingAllowed(request)  
需返回 false。****  
  
看一下 requestPreHandlingAllowed() 方法，if 中调用了 WebUtil.isJspPrecompilationRequest() ，返回结果是由 URI 决定的。从请求中获取 URI ，若是以  
.jsp  
或  
.jsp  
f  
结尾的，并且传入的  
jsp_precompile  
参数不为 null，就返回 true，进而 requestPreHandlingAllowed() 返回 false。  
  
或者进入 else 分支，满足请求路径与  
this.myPreHandlingDisabled  
中的相匹配，也会返回 false，不过这里访问路径有限制，不如 if 条件的选择自由。  
  
 requestPreHandlingAllowed() 返回 false，不用遍历子拦截器，也就避免了进行身份验证。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSp4wcPdnpBEV9ruPXAicffibMHEsh73V8fRPekPFTLyc0VQD0RCIzjtnLA/640?wx_fmt=png "")  
  
  
TeamCity 提供 REST API，用于集成外部应用程序并创建与 TeamCity 服务器的脚本交互。它允许通过 URL 路径访问资源（  
实体  
）。  
  
访问  
/app/rest/swagger.json  
可以获取到端点列表与格式，以及功能描述。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpdP1Q629ichPwF1fFTQvr5J1urC05EKgLAqEOkPV678NlEpibH8Cic2goQ/640?wx_fmt=png "")  
  
  
TeamCity REST API  
中有较为详细的介绍，  
/app/rest/users  
用来进行用户相关的操作，这是需要进行身份验证才能访问的API，创建一个用户实体，需要的参数如下：      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSp9oRhVDo1Pj1yKgtrK89FbCOO1Wtnvwboxl5JhI3KicCictto5UEfed9A/640?wx_fmt=png "")  
  
  
构造请求包，满足 URI 以  
.jsp  
或  
.jsp  
f  
结尾，并且传入  
jsp_precompile  
参数不为 null 两个条件，创建一个用户名为  
user1  
，密码为  
user1user1  
，角色权限为  
SYSTEM_ADMIN  
的用户。  
```
{              
    "username":"user1",              
    "password":"user1user1",              
    "email": "123456789@qq.com",              
    "roles": {"role": [{"roleId": "SYSTEM_ADMIN", "scope": "g"}]}              
}
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSp3ibyeX1kluqZERPRycO3ibcBZ5272C72ibS18CVBbaib32rso1EoQekicww/640?wx_fmt=png "")  
  
  
开启调试，在 RequestInterceptors.preHandle() 断点开始，      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpz4NoCADrM5LJ4TricdPRWnYscFNANyyq19v1c15ibV2uNRojAglIGpYg/640?wx_fmt=png "")  
  
  
跟进 requestPreHandlingAllowed() -> WebUtil.isJspPrecompilationRequest()，此时获取到的 URI 是  
/app/rest/user;.jsp  
，  
jsp_precompile  
参数为1，满足条件，返回 true。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpyOBgJwH95rAOGNyN6oA1cEvDJzMYPaRMU5p3qboJ83rCbv9YxqtIbw/640?wx_fmt=png "")  
  
  
于是，结束 RequestInterceptors 拦截器的检查，其他拦截器不会进行拦截。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpajv7LSNxsQBP9B7bibW984r6YonVXiblz8q29mmNwMJxysaYq0mrzxRw/640?wx_fmt=png "")  
  
  
后续在路由处理中，由于 Tomcat的特性，会忽略掉  
;.jsp  
，解析到  
/app/rest/users  
对应的功能代码进行创建用户。  
  
简单看一下 AuthorizationInterceptorImpl 的认证过程吧，进入该拦截器后，会判断当前是否有用户登录或者是否有 RememberMe 记录；  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpUGibRqvX8sRVSnwP2bmQrTOw2ab79U78D1emrOCeorXSK8MUCpMlORw/640?wx_fmt=png "")  
  
  
没有登录则调用  
isAuthenticationRequired()  
判断当前访问路径是否是  
this.myAuthorizationPaths  
中不需要身份验证的路径，不是就返回 false，后面进行拦截处理。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpNITxSk1kEyUfDcRkibpOmZHpmmSfrnJI5dJBvFmqvAw0vJ2joqjAQvQ/640?wx_fmt=png "")  
  
  
补丁下载：  
https://download-cdn.jetbrains.com/teamcity/plugins/internal/fix_CVE_2024_23917.zip  
  
在 2023.11.3 版本中，  
this.interceptorList  
中增加了一个 Proxy 拦截器，会对当前请求进行拦截，导致请求失败。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSp22vgic6Rsc4YpYw4rIzNw5LJvOO3jSS4EeR8UWRVq3pichicFLs3ibPTWQ/640?wx_fmt=png "")  
  
  
  
  
3. CVE-2024-27198  
  
**官方公告**  
  
https://blog.jetbrains.com/teamcity/2024/03/additional-critical-security-issues-affecting-teamcity-on-premises-cve-2024-27198-and-cve-2024-27199-update-to-2023-11-4-now/  
  
**漏洞描述**  
      
  
默认情况下，TeamCity 通过 HTTP 端口 8111 公开 Web 服务器（并且可以选择配置为通过 HTTPS 运行）。攻击者可以精心设计一个 URL，以避免所有身份验证检查，从而允许未经身份验证的攻击者直接访问需要身份验证的端点。未经身份验证的远程攻击者可以利用此漏洞完全控制易受攻击的 TeamCity 服务器。  
  
**影响版本**  
  
2023.11.3及之前版本  
  
**3-1. 漏洞复现**  
  
直接访问  
/app/rest/server  
会跳转到登录页面；  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSp0QZzNuwoQD7GvZPLFFguAs8J4ib5xdW4GKpgVHdX6dMDMYyFJJAzjiaA/640?wx_fmt=png "")  
  
  
构造 URL 为  
/hax?jsp=/app/rest/server;.jsp  
，即可绕过身份验证访问到目标内容。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpBldicEZsVUKRR75hqwGNKldjj1oAdPwqwY8clsh5xNFLNduVDIjPcEA/640?wx_fmt=png "")  
  
      
  
  
**3-2. 漏洞分析**  
  
跟踪调试看一下，会先解析  
/hax  
路由，由于这是一个不存在的路径，所以由 PageNotFoundController 处理，在获取视图时会返回  
404.jsp  
，servlet 路径为  
/404.html  
；  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpovsP2J8zYxSver7el7rIzNKfibRoWKv9ZsqTKYXz3Hlia49fsmFON0Mg/640?wx_fmt=png "")  
  
  
PageNotFoundController 是继承 BaseController 的，返回到 BaseController.handleRequestInternal()，调用 updateViewIfRequestHasJspParameter() 方法；  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpOBCnW3w5ibRWAV0s7fpO2vSeL5OqdwGUZrRnBqIfPoPLs4f5jBvLB7g/640?wx_fmt=png "")  
  
跟进，根据是否存在视图名称以及 servlet 路径是否以  
.jsp  
结尾生成了一个布尔值，然后调用 getJspFromRequest() 方法，从请求中获取  
jsp  
参数值，当参数值为 null 或 以  
.jsp  
结尾，以及值中不包含  
admin/  
字符串，该方法就返回 true；  
  
满足了 if 中的三个条件，就会重新将视图设置为 jsp 参数的值。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpK9QGDR5YQ4bA6lKHEr5FkMcMUIn3ORj0qQzvUh2FsEkKX3CUzaVTnA/640?wx_fmt=png "")  
  
  
整理一下走到这一步需要的条件：  
  
•  
  
初始返回的视图不为 View 类型，且处理的 Controller 是 BaseController的子类  
  
•  
  
视图名称不为null，且当前响应路径不以  
 .jsp  
 结尾  
  
•  
  
请求时传入 jsp 参数，参数值以   
.jsp  
 结尾，且不含  
admin/  
字符串  
  
此时视图名称变为了  
/app/rest/server;.jsp  
，jsp 参数是可控的，可以通过这种方法来访问任意需要身份验证的路径。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpge9Zic2tL9RnV4VOYjPYOWo3hzXcib1DMvqV3xbZfScEM7DlhnTmgVmA/640?wx_fmt=png "")  
  
  
处理器执行完后再次进入拦截器校验，但是 AuthorizationInterceptorImpl 并没有重写 postHandle() 方法，所以不会进行拦截。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpKYhw2g3DgXorHsRwqH8ibTK1LIGEQToqLn5PHYKmtCu1Kj4FSRZQyPg/640?wx_fmt=png "")  
  
  
后续会像 CVE-2024-23197 一样的过程解析  
/app/rest/server;.jsp  
，在 RequestInterceptors 中，这里没有传入  
jsp_precompile  
参数，所以  
if (!this.requestPreHandlingAllowed(var1))  
为 false，进入后面的代码；  
  
或者同样在 URL 后面拼接传入  
&?jsp_precompile=1  
，这里就能直接返回 true 了。  
  
继续看下面，此时  
__tc_requestStack  
值为2，所以不会再遍历  
this.myInterceptors  
，略过了 AuthorizationInterceptorImpl 的校验，RequestInterceptors.preHandle() 方法返回 true。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpnrSwQ2jpMGZ313Aer6wlgM1byb8LYpjy7F9T7pLnCaKqyvudLA3TWQ/640?wx_fmt=png "")  
  
  
关于新增的 Proxy 拦截器，不知道其具体内容，这里也不会拦截。于是通过所有拦截器校验，返回 true。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSp9oKEGicRhicibIU2fQFp6bYBR4BsVNfG0UNDm2qGKpBe3Bo5fjvniaaBzw/640?wx_fmt=png "")  
  
  
后续 Tomcat 会自动忽略掉  
;.jsp  
，就会解析返回  
/app/rest/server  
对应的内容。  
  
  
  
4. CVE-2024  
-27199   
  
**漏洞描述**  
  
 TeamCity Web 服务器中某些旁路允许在没有身份验证的情况下访问有限数量的经过身份验证的端点。未经身份验证的攻击者可以利用此漏洞修改服务器上有限数量的系统设置，并泄露服务器上有限数量的敏感信息。  
  
**影响版本**  
  
2023.11.3及之前版本  
  
**4-1. 漏洞复现**  
  
/admin/diagnostic.jsp  
是一个需要身份验证才能访问的路径，直接请求会跳转到登录页面；  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpZhZGfLXM3ZcEsZpXOEVmYBxt9IAxxh2NPEhaK6mDQib5V45WA9a8giaQ/640?wx_fmt=png "")  
  
  
构造 URL 为  
/update/../admin/diagnostic.jsp  
，即可成功访问。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSppTx9t1dRBLFibibeRwKe4ib6r5ibHhzCHjsjYW5Po0SwR1WLPvpglf0lBg/640?wx_fmt=png "")  
  
  
能利用的不需要身份验证的路径有：  
  
•  
  
/res/  
  
•  
  
/update/  
  
•  
  
/update/tools/content/  
  
•  
  
/.well-known/acme-challenge/  
  
能通过拼接绕过身份验证进行访问的路口有：  
  
•  
  
/app/availableRunners  
  
•  
  
/app/https/settings/setPort  
  
•  
  
/app/https/settings/certificateInfo  
  
•  
  
/app/https/settings/defaultHttpsPort  
  
•  
  
/app/https/settings/fetchFromAcme  
  
•  
  
/app/https/settings/removeCertificate  
  
•  
  
/app/https/settings/uploadCertificate  
  
•  
  
/app/https/settings/termsOfService  
  
•  
  
/app/https/settings/triggerAcmeChallenge  
  
•  
  
/app/https/settings/cancelAcmeChallenge  
  
•  
  
/app/https/settings/getAcmeOrder  
  
•  
  
/app/https/settings/setRedirectStrategy  
  
•  
  
/app/pipeline  
  
•  
  
/app/oauth/space/createBuild.html  
      
  
  
**4-2. 漏洞分析**  
  
在 RequestInterceptors 拦截器中，和之前的逻辑一样，判断请求路径是否与  
this.myPreHandlingDisabled  
中的路径相匹配；  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpaqb9OXB21YJcchgKT4JmxC8icd7AMficqcc5JrIK7ocRicu5V7AQGVK8Q/640?wx_fmt=png "")  
  
  
在遍历  
this.myMatchingPaths  
时，判断请求路径是否与已定义的路径相符，匹配到了其中的  
/update/**  
，返回 true，这些路径都是不需要身份验证的路径。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpv1AlDrG5uI8UicQB2uXS18XaUbUaDpvXNHDEYLdpXQCwThhNHwxickIQ/640?wx_fmt=png "")  
  
  
于是 requestPreHandlingAllowed() 返回 false，不遍历 RequestInterceptors 的子拦截器，即不用进行身份验证。  
  
在后续处理中，根据路径穿越符号，  
/update/../admin/diagnostic.jsp  
会处理为  
/admin/diagnostic.jsp  
，解析到视图  
  
/admin/diagnostic.html  
，输出对应内容。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSpKCo0elibU9ngpaTb6OuYdGhOaxICo1m2K1jPdiczL4eVt2N2xvickMWjA/640?wx_fmt=png "")  
  
  
同理，  
this.myMatchingPaths  
中的其他含有通配符的路径也可以用于绕过身份验证。  
  
•  
  
/update/plugins/../../admin/diagnostic.jsp  
  
•  
  
/update/tools/content/../../../admin/diagnostic.jsp  
  
/app/agents/**  
不可用是因为获取到的处理器不是 NodeDiagnosticsController，视图返回的就不是  
/admin/diagnostic.jsp  
。  
  
还有一处不需要身份验证的路径列表，就是  
this.myPathsNotRequiringAuthentication  
，当进入 AuthorizationInterceptorImpl 时会进行遍历匹配；  
  
当请求  
/res/../admin/diagnostic.jsp  
时，会匹配到  
/res/**  
，从而顺利通过拦截器校验。      
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/kAeFn7TN57PDrf2RubgOkjibJTOMrzMSp0hETwCEKzn3o4EqONHsOU7pSLk4UmZZIKv3Y1OnJqJlSNUCIicnqSMg/640?wx_fmt=png "")  
  
  
同样，  
this.myPathsNotRequiringAuthentication  
其他含有通配符，且处理器为 NodeDiagnosticsController 的路径也能进行利用。  
  
•  
  
/.well-known/acme-challenge/../../admin/diagnostic.jsp  
  
**补丁下载：**  
  
•  
  
TeamCity 2018.2 及更高版本  
  
****  
•  
  
TeamCity 2018.1 及更早版本  
  
                 
  
更多利用方式可参考以下链接：  
  
https://www.rapid7.com/blog/post/2024/03/04/etr-cve-2024-27198-and-cve-2024-27199-jetbrains-teamcity-multiple-authentication-bypass-vulnerabilities-fixed/  
  
https://forum.butian.net/share/2801  
      
  
