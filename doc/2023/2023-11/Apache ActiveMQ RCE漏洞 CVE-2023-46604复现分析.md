#  Apache ActiveMQ RCE漏洞 CVE-2023-46604复现分析   
原创 th1e  山石网科安全技术研究院   2023-11-07 10:41  
  
一早起来看见群里炸锅了，全都是Apache ActiveMQ的在野利用，搜了一下资料发现有一篇已经被撤回的分析文章。  
  
先找小伙伴要了一下源码，然后找了一下资产，不想自己搭建环境了，搞个灰盒分析吧。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhk0ULmccejKKGibwav4aPnNls8eBN1ngAhp7ibKlpRxyKVxWqYYIAQLIBA/640?wx_fmt=png "")  
  
一切准备就绪开始漏洞分析。  
  
**漏洞分析**  
  
  
  
先看下补丁做了些什么：  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkCatUyPh6muicb7icghJ5M5tG6CvMydmlgzPZdrlcichOZfr354ibiakSKQA/640?wx_fmt=png "")  
  
  
可以看到这里BaseDataStreamMarshaller中加入了新的validateIsThrowable 方法  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkfiaENhlpnCHb5Sn9hP7s7kH8Rnr7Kfco2kgInGiaCRPJBekc2elBfRIA/640?wx_fmt=png "")  
  
那么我们可以在这里构建请求  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhk4YBQT0Ix5hTdC3Dw8DDlibDQRbaZicpXQChBTQqQ7vykm6sfpDWTQdmw/640?wx_fmt=png "")  
  
通过覆写ClassPathXmlApplicationContext继承Throwable  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkpzvmK7rI6ZtqR065BAdXoYSPGmC9XWqldOxpvSsucUTXYGq3BAx4DA/640?wx_fmt=png "")  
  
接着，在这里重写oneway，回写ExceptionResponse  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkrjdnUHicZ5FiakovCKH1wOPQZg52ndQgxECL6Uf0oHlrCxXYzt2IQyRA/640?wx_fmt=png "")  
  
到这里我们整个利用链就梳理完成了，接着启动activeMQ  
```
mq启动命令：create --name=activemq -it -p 61616:61616 -p 8161:8161 webcenter/activemq:latest
```  
  
然后这里我们拿一个github上的poc  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkgzn0QBMczzehTpM71ibrCcyLOjqJkUBoVoZh0JmiaJEHqfTcHFgz1bGQ/640?wx_fmt=png "")  
  
将poc.xml放到网站上等待  
ActiveMQ获取  
  
“   
  
tips: docker容器访问宿主机地址 host.docker.internal  
  
   
”  
  
最后执行成功得到shell  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkKEFxSaO3MUk1Vj5QHHaqbdABcnuoaWrt0LvrfYRxZ8fsicGkQeUYjrg/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkymChibENs3NvG43OhUHzJTQ3AslicNABRnsiaNBbdtxSwmjnYXI64dGFA/640?wx_fmt=png "")  
  
核心代码目录如下  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkxqorJib8g22V40E3G1PaP31d2cmiafukiaHyCPnryObicjcLic4SjpW6WTw/640?wx_fmt=png "")  
  
上面已经实现了RCE，但是在搜索资料的时候发现了一个有趣的msf插件，已经有研究员写好了这个漏洞的exp：  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkKXicAM6yTzBoZrlHx5WYEzeUmfnLUWZoQpDoM4aGKImu0vYicPwjftEg/640?wx_fmt=png "")  
  
  
可以直接通过msf去执行，  
这里通过echo生成worked.txt  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkb6HE86TeNxVrfSJ4iaKKtPLLAEM8IqgkWKp03VqBWGwWtMDejhG1CWQ/640?wx_fmt=png "")  
  
最后看一下这个攻击过程的数据包流量  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRxNNWiaMIztUCAcIxVKAKhkpe8ROvu3LWYVg47BfXhZKrkdiaR0XmmYAiabUctSaAWbg7GUzOzehZyA/640?wx_fmt=png "")  
  
至此  
  
  
  
  
  
  
  
