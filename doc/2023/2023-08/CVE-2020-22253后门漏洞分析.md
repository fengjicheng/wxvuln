#  CVE-2020-22253后门漏洞分析   
愿风载尘  看雪学苑   2023-08-23 18:03  
  
```
```  
  
  
多款 Xiongmai 产品存在安全漏洞，该漏洞源于开放9530端口。未经身份验证的攻击者可与受害设备进行任意 Telnet 连接。以下产品和版本受到影响：AHB7008T-MH-V2、AHB7804R-ELS、AHB7804R-MH-V2、AHB7808R-MS-V2、AHB7808R-MS、AHB7808T-MS-V2、AHB7804R-LMS、HI3518E_50H10L_S39。  
  
  
```
```  
  
  
整个身份验证过程可能类似于某种 HMAC 质询-响应身份验证，只不过它使用对称密码而不是哈希。对于长度超过 8 字节的密钥，这种特殊的对称密码类似于 3DES-EDE2 的某些变体，对于较短的密钥则类似于简单 DES。  
  
  
1.客户端打开与设备的 TCP 端口 9530 的连接，并发送OpenTelnet:OpenOnce  
前缀有指示总消息长度的字节的字符串。对于以前版本的后门，此步骤是最后一步。如果执行此步骤后没有响应，则可能 telnetd 已经启动。  
  
  
2.服务器（设备）用字符串应答randNum:XXXXXXXX  
，其中XXXXXXXX  
是 8 位随机十进制数。  
  
  
3.客户端使用其预共享密钥并将加密密钥构造为接收到的随机数和 PSK 的串联。  
  
  
4.客户端使用加密密钥加密随机数并在 string 之后发送randNum:  
。整个消息前面带有指示消息总长度的字节。  
  
  
5.服务器从文件加载相同的预共享密钥，或者如果文件丢失则/mnt/custom/TelnetOEMPasswd  
使用默认密钥。2wj9fsa2  
  
  
6.服务器对随机数进行加密并验证结果与客户端的字符串是否相同。成功后，服务器发送字符串verify:OK  
或verify:ERROR  
其他内容。  
  
  
7.客户端加密 stringTelnet:OpenOnce  
，在其前面添加总长度字节、CMD:  
字符串并发送到服务器。  
  
  
8.服务器提取并解密收到的命令。如果解密结果等于字符串，Telnet:OpenOnce  
则响应Open:OK  
，启用调试端口 9527 并启动 telnet 守护进程。  
  
  
```
```  
  
  
设备：XMJP IPC 摄像头 型号：XM510  
  
  
使用binwalk进行解压  
  
  
```
```  
  
  
  
进行字符串搜索  
  
  
```
```  
  
  
  
找到关键文件![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7Nssicmpgur2UHprbtZiaje27AqoicibcdbBiabdpanTKFy3g6R92uzowEoI9A/640?wx_fmt=png "")  
  
  
  
在 usr/bin 目录下找到 dvrvox这个可执行程序，查看文件信息：  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7Ns44KedUVWfCDfrONhEApmN1p5uDg5aaWiaP0Cx0TDJaOaF6P0u0ic8X8w/640?wx_fmt=png "")  
  
  
IDA分析  
  
  
Shift+F12搜索字符串OpenTelnet：OpenOnce，定位到关键代码。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NsmcjFS4TnIWGx9mv8BDUANBV9P42Um6ky4RYTHcspyuMykGVM5EQ8uw/640?wx_fmt=png "")  
  
  
程序执行流程中，在经过判断后可以执行system("telnetd")命令，从而开启漏洞信息中所说的9530端口，所以利用漏洞需经过程序判断流程执行这个命令。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NsDZfehibINIwqiawf9QZ5gQZLOJAzP2tkhtaY53rE4c7bxv4nLOh4j90A/640?wx_fmt=png "")  
  
  
首先程序使用socket套接字的recv函数接受数据。  
  
接着进行第一个判断strncmp(&s[1], "OpenTelnet:OpenOnce", 0x13u)判断开头是否为 OpenTelnet:OpenOnce。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NsEfEOUcAb0Hp7ibmWqmvXge7kdN8BdVdoMmgBrQC3nbicbAtevbBE991g/640?wx_fmt=png "")  
  
  
通过第一个判断，程序首先执行get_random_bytime((char *)ranNum)，根据时间戳生成八位随机数字字符串。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7Ns6ibKMM46Falic7wicYC7dcr3oywLf1DAw4t8dDlpu7HJ3ss50LtRIIjRQ/640?wx_fmt=png "")  
  
  
get_random_bytime函数  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NshVzep01eBT859NTWibFOpJKfrQjBesQPiaEaTL759iaEBETeUahe5q1icA/640?wx_fmt=png "")  
  
  
第二个判断recv_buffer中的内容是否为randNum开头的字符串。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7Nscc1D0V0ECeFxVrGicjEtfFTPCxms8w8hWiaqqYJ6bKo2SuXHSZ9h4ibTg/640?wx_fmt=png "")  
  
  
get_key 函数的作用是返回一个 key 字符串，判断 /mnt/custom/TelnetOEMPasswd 文件是否存在，存在的话返回文件的内容（也就是密钥），不存在就返回 2wj9fsa2 字符串。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7Nsicyiad3fNCfibqc1dUyrrf6MBGYt283ibFInRgmxEuOic6ica2S4cZyGBhLQ/640?wx_fmt=png "")  
  
  
接下来是主要的encrypt加密函数，传入的参数分别为之前生成的8位随机数字以及他的长度，还有通过sprintf将key和ranNum拼接后的concatenateStr字符串及其长度。concatenateStr也就是需要加密的字符串，而key相当于程序中的 PSK 预共享密钥，也就是后门密钥。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NsBpeyEOGrj7fgKbfIJvIHQC0krtWtswxl3F9cPzE3HUUEFkAWtKoVRQ/640?wx_fmt=png "")  
  
  
跟进到encrypt函数中，逻辑较为复杂，可参考  
https://github.com/tothi/pyDes/blob/7a26fe09dc5b57b175c6439fbbf496414598a7a2/pyDes.py#L108  
  
  
对于长度超过 8 字节的密钥，这种特殊的对称密码类似于 3DES-EDE2 的某些变体，对于较短的密钥则类似于简单 DES。  
  
  
3DES部分代码：  
  
  
```
```  
  
  
  
1.triple_des类继承自_baseDes，其中_baseDes是 DES 加密算法的基类，triple_des通过调用_baseDes的方法来实现加密/解密过程。  
  
  
2.构造函数init初始化triple_des类的对象。构造函数接收以下参数：  
  
key: 加密密钥，可以是 16 或 24 字节长的字节数组。如果是 16 字节长，将使用 DES-EDE2 模式，如果是 24 字节长，将使用 DES-EDE3 模式。  
  
mode: 加密模式，可以是ECB（电子密码本模式）或CBC（密码块链接模式），默认为ECB。  
  
IV: 初始化向量（只在 CBC 模式下需要），必须是 8 字节长的字节数组。  
  
pad: 填充字符（可选参数），用于加密数据时对不足 8 字节的数据进行填充。  
  
padmode: 填充模式（可选参数），可以是PAD_NORMAL或PAD_PKCS5，默认为PAD_NORMAL。  
  
hs: 是否进行硬件加速（可选参数），默认为False，表示不使用硬件加速。  
  
  
3.setKey方法用于设置加密密钥。根据传入的key的长度，判断使用 DES-EDE2 还是 DES-EDE3 模式。然后创建三个des类的实例，分别用于处理三个部分的加密解密。  
  
  
4.setMode、setPadding、setPadMode和setIV方法用于设置加密模式、填充字符、填充模式和初始化向量，并将设置传递给三个des实例。  
  
  
5.encrypt方法用于对输入的数据进行加密。它接收以下参数：  
  
data: 要加密的数据，必须是长度为 8 的倍数的字节数组。  
  
pad: 可选参数，用于加密数据时对不足 8 字节的数据进行填充，必须是长度为 1 的字节数组。  
  
padmode: 可选参数，用于指定填充模式，可以是PAD_NORMAL或PAD_PKCS5。方法首先将数据进行填充，然后根据加密模式进行加密，最后返回加密后的数据。  
  
  
6.decrypt方法用于对输入的数据进行解密。它接收以下参数：  
  
data: 要解密的数据，必须是长度为 8 的倍数的字节数组。  
  
pad: 可选参数，用于解密数据时对最后 8 字节的填充字符进行移除，必须是长度为 1 的字节数组。  
  
padmode: 可选参数，用于指定填充模式，可以是PAD_NORMAL或PAD_PKCS5。方法首先根据加密模式进行解密，然后根据填充模式对解密数据进行处理，最后返回解密后的数据。  
  
  
7.注意：这里的des类指的是之前提到的单独的 DES 加密算法类，而不是 Triple DES 的类。Triple DES 类在内部使用了三个单独的 DES 加密实例来完成加密和  
解密过程。  
  
  
参考此代码写出具体的加密算法，将加密结果拼接在randNum：字符串后面  
  
  
```
```  
  
  
  
之后经判断输出verify：OK  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NsqAfNrcPZe7X6ZqNxPO9iccPN8VeqBEulXeRGAOxA6V9f4iaFibubHCU4g/640?wx_fmt=png "")  
  
  
最后再次判断接收到的字符串开头是否为CMD，这里的 dencrypt对应上面的加密算法，判断解密后的字符串是否为“Telnet:OpenOnce” ，也就是只需将这个字符串经过相同的加密算法即可，从而执行 system("telnetd") 函数，开启后门。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NsUnk7lm9Y89vzGZlib8tzibDDoTlVy64xJiaZ5QPRTmVGkOFqXCZbciaO2A/640?wx_fmt=png "")  
  
  
一旦 telnet 守护进程激活，可以用以下登录名/密码对之一：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NsLZjZnsjvXSz3WbspgAoNvnDwtlBKTsD4FvyV0xPln0ct6dkYeOHb0Q/640?wx_fmt=png "")  
  
  
这些密码可以从固件中恢复，也可以通过/etc/passwd  
文件中的哈希值进行暴力破解。  
  
  
```
```  
  
  
最常见的 PSK 是默认值之一：2wj9fsa2  
会话示例：  
  
  
```
```  
  
  
```
```  
  
  
  
  
**参考文章**  
  
  
https://github.com/tothi/pwn-hisilicon-dvr#summary  
  
https://www.4hou.com/posts/mGYE  
  
https://github.com/tothi/pyDes/blob/master/pyDes.py  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8GMmOXKsybjJdZePe3AF7NslZBw3JktQs8urdiaMWNCHeo506rATVnDomICG2JJPaBT5reWtasIDicg/640?wx_fmt=png "")  
  
  
**看雪ID：愿风载尘**  
  
https://bbs.kanxue.com/user-home-937578.htm  
  
*本文为看雪论坛优秀文章，由 愿风载尘 原创，转载请注明来自看雪社区  
  
  
[](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458499288&idx=1&sn=b2b9cd6ff7388a8658d254e13c72f9ad&chksm=b18e885286f9014436a590f2531fda167be67e1e227ea395812968e828932bd44eade34b0dbf&scene=21#wechat_redirect)  
  
  
**#****往期推荐**  
  
1、[在 Windows下搭建LLVM 使用环境](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500602&idx=1&sn=4bcc2af3c62e79403737ce6eb197effc&chksm=b18e8d7086f9046631a74245c89d5029c542976f21a98982b34dd59c0bda4624d49d1d0d246b&scene=21#wechat_redirect)  
  
  
2、[深入学习smali语法](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500599&idx=1&sn=8afbdf12634cbf147b7ca67986002161&chksm=b18e8d7d86f9046b55ff3f6868bd6e1133092b7b4ec7a0d5e115e1ad0a4bd0cb5004a6bb06d1&scene=21#wechat_redirect)  
  
  
3、[安卓加固脱壳分享](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500598&idx=1&sn=d783cb03dc6a3c1a9f9465c5053bbbee&chksm=b18e8d7c86f9046a67659f598242acb74c822aaf04529433c5ec2ccff14adeafa4f45abc2b33&scene=21#wechat_redirect)  
  
  
4、[Flutter 逆向初探](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500574&idx=1&sn=06344a7d18a72530077fbc8f93a40d8f&chksm=b18e8d5486f904424874d7308e840523ebfb2db20811d99e4b0249d42fa8e38c4e80c3f622c6&scene=21#wechat_redirect)  
  
  
5、[一个简单实践理解栈空间转移](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500315&idx=1&sn=19b12ab150dd49325f93ae9d73aef0c4&chksm=b18e8c5186f90547f3b615b160d803a320c103d9d892c7253253db41124ac6993d83d13c5789&scene=21#wechat_redirect)  
  
  
6、[记一次某盾手游加固的脱壳与修复](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500165&idx=1&sn=b16710232d3c2799c4177710f0ea6d41&chksm=b18e8ccf86f905d9a0b6c2c40997e9b859241a4d7f798c4aeab21352b0a72b6135afce349262&scene=21#wechat_redirect)  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球分享**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球点赞**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球在看**  
  
