#  CLFS信息泄露漏洞CVE-2023-28266分析   
王cb  看雪学苑   2023-08-10 17:59  
  
这篇文章的目的是介绍今年4月发布的CLFS信息泄露漏洞CVE-2023-28266分析。  
  
  
文章结合了逆向代码和调试结果分析了CVE-2023-28266漏洞利用过程和漏洞成因。  
  
  
```
```  
  
  
CVE-2023-28266是笔者今年1月提交的一个关于CLFS文件系统驱动程序的信息泄露漏洞，漏洞公告发布于今年4月。信息泄露类型的漏洞属于间接利用类型并不能直接导致权限提升的结果，以普通用户触发漏洞可以实现内核态内存的越界读取，最终将泄露的数据写入CLFS容器文件（BLF格式）中，并在控制台输出中提供展示泄露的数据内容。  
  
关于CLFS模块的基础知识读者可以查看相关引用节中的文章获取里面有详细介绍，请读者自行研究，本文只讨论CVE-2023-28266的相关利用细节。  
  
CVE-2023-28266与其他CLFS漏洞中的符号表相关的关联数据关系不大，只存在于一个截断日志相关的过程调用中，下面我们来具体分析一下。  
  
漏洞存在于一个名为的CClfsLogFcbPhysical::TruncateLogModifyStreams函数中，触发该函数需要增加一个Truncate Record的元数据块(Metadata Block),大小0x2800在最后一个元数据块后。从字面量分析来看这个元数据块的作用应该是用来截断clfs文件指定扇区数据到容器文件的作用.从逆向分析来看我们得到了一个结构体_CLFS_SECTOR_CHANGE用于表示需要截断的扇区的数据结构，截断数据存在于rgbSector字段大小为一个默认扇区大小也就是0x200。  
  
  
具体逆向结果如下:  
  
  
```
```  
  
  
  
触发截断日志扇区功能函数需首先要设置控制元数据块(Control Record)PCLFS_CONTROL_RECORD->cxTruncate.eTruncateState = ClfsTruncateStateModifyingStream，在进入这个函数前存在一个_CLFS_TRUNCATE_CLIENT_CHANGE结构体用于表示需要截断扇区个数chg->cLength，CLFS会根据这个指定的个数分配非分页缓冲区大小chg->cLength<<9也就是chg->cLength*0x200用于存放将要截断的扇区数据，从当前元数据块加上coffClientChange偏移量得到拷贝的基址写入缓冲区中，这里并没有对实际的Truncate Record的元数块据中指定扇区数据数量进行校验，导致可以越界读取到最后一个扇区的下一个扇区数据到缓冲区中，也就是说泄露下个内核池中的0x200大小的数据。  
  
  
一般情况下非分页池相邻的数据块都是有数据的，所以越界读取并不会导致BSOD。所有缓冲区的数据最后都会在CClfsLogFcbPhysical::WriteOneRawSectorSync写入CLFS容器文件，所以读取泄露数据对于调用者来说是可行的。  
  
  
```
```  
  
  
  
漏洞触发的整个调用过程首先根据Client符号表的cidClient获取TruncateContext上下文，所在元数据块大小0x2800，其实在这个函数之后确实存在对当前元数据块的CClfsLogFcbPhysical::IsTruncatedRecordOffsetValid进行第一步校验，判断CLFS_TRUNCATE_CONTEXT->eTruncateState是不是ClfsTruncateStateModifyingStream，然后进入CClfsLogFcbPhysical::TruncateLogModifyStreams对TruncateContext进行第二步校验，在CClfsLogFcbPhysical::ValidateTruncateRecord函数中。  
  
  
这里笔者总结出了一个绕过方式方法如下：  
  
  
逆向代码显示IsTruncatedRecordOffsetValid的参数offset来自与元数据块的SignaturesOffset+RecordOffsets[0]=27d0值，可以理解为这个值接近于整个元数据库块的结尾，因为一般情况下Signature会从最后一个扇区直到写入位于每个扇区的结尾，第一步校验经过排除法计算得出chk1 = offOwnerPage < offClientChange;  
  
和 chk2 = offOwnerPage == offClientChange这2个都不能让它成立，  
  
参数offset位于整个元数据块长度减去0x30字节处，为了让offset - offOwnerPage < 0x1000且offset - offClientChange < 0x230不成立，只能让offOwnerPage - offClientChange >= 0x230成立，得出结论offset减去offOwnerPage和offClientChange都只能大于0x1000，而且它们的差值需要大于0x230，那么offClientChange就必须小于offset-1000-230值，采用0x1750- 0x238=1518可以是个合适的值.在第二步校验中0x208 * chg_cLength > offOwnerPage所以offOwnerPage必须大于0x2089=1248采用0x1750也符合要求;为什么采用TruncateContext元数据块大小0x2800原因是offClientChange=1518,0x2800-1518-70=1278，转换成扇区个数1278/208=9正好是9个，通过加减8个字节的微调让这些符号的边界都和扇区对齐，让最后一个PCLFS_SECTOR_CHANGE扇区的边界(90x208=1248)正好落在整个TruncateContext元数据块的结尾，1248+70+1518+sizeof(CLFS_TRUNCATE_CLIENT_CHANGE)=27f8(约等于2800)。而越界读取没有对PCLFS_TRUNCATE_CLIENT_CHANGE->cLength进行校验导致读取数据越过了元数据块的边界，这里SignaturesOffset需要被clfs写入签名值，所以必须让他落在拷贝扇区数据的内存区域要不然会污染符号表的数据，在ClfsDecodeBlockPrivate中对这个值和CLFS_LOG_BLOCK_HEADER->TotalSectorCount组合也有校验需要绕过，笔者用的合适的SignaturesOffset值是元数据块大小TruncateContextlength-0x30。完整的绕过方法构造合适的值如下：  
  
  
```
```  
  
##   
##   
```
```  
  
  
下面我们来看调试过程。  
  
  
```
```  
  
  
  
设置第一个断点bp CLFS!CClfsLogFcbPhysical::TruncateLogModifyStreams+0x127 ".if(rax==9){.echo found}.else{gc}";当迭代到拷贝第9个扇区数据时候，可以看到rsi指向当前TruncateContext指向元数据块内存区域，大小2800也就是拷贝的起始地址，再次下第二个断点bp CLFS!CClfsLogFcbPhysical::TruncateLogModifyStreams+0x14e发现rax=ffffde86f13e4800减去TruncateContext基址正好是0x2800，说明这次拷贝的起始地址已经到了当前pool的末尾，也就是说会越界拷贝一个扇区0x200大小的数据内容。  
  
下第三个断点bp CLFS!CClfsLogFcbPhysical::TruncateLogModifyStreams+0x3d3,调用CLFS!CClfsLogFcbPhysical::WriteOneRawSectorSync函数r9指向要写入容器文件的全部缓冲区地址正好是9*0x200=0x1200;查看db ffff8b03d81ab000+1200数据内容得出的结论是与上一步越界读取rax指向的泄露信息内容是相同的。  
  
接下来调用者就可以通过读取容器通过CLFS_TRUNCATE_CLIENT_CHANGE->lsn获取容器的符号表中对应容器默认第0个是CLFSCON01文件,在偏移量1200数据内容展示泄露信息，读取方法与读取普通文件相同，这里不再赘述。至此完成整个漏洞的利用过程。  
  
##   
```
```  
  
  
出于安全原因笔者不能提供完整的poc代码,下图是笔者在打了1月补丁的Windows1021h2虚拟机上成功复现了CVE-2023-28266  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8FyzJLNPqguHaJMI7BK2ZSiaIqyIAgALFTg2IU0wwicRWzJMlkDicTUU0gfSyUVODC10ibwXw0nmmTHAQ/640?wx_fmt=png "")  
  
  
## 相关引用  
  
  
clfs逆向工程文档  
  
[CVE-2023-28252红雨滴分析](https://mp.weixin.qq.com/s?__biz=MzI2MDc2MDA4OA==&mid=2247506484&idx=1&sn=ce0525563b459be8e785fe4b7d5215f0&scene=21#wechat_redirect)  
  
  
CVE-2023-28252安全客分析  
  
CVE-2023-28252谷歌P0分析  
  
CVE-2023-28252分析  
  
CVE-2023-28252看雪分析2  
  
CVE-2023-28252看雪分析2  
  
CVE-2023-28252的poc  
  
[CVE-2022-24521分析第一篇](https://mp.weixin.qq.com/s?__biz=MzkyMTI0NjA3OA==&mid=2247488567&idx=1&sn=764b71452aaa0695da3626393f362208&ref=www.ctfiot.com&scene=21#wechat_redirect)  
  
  
CVE-2022-24521分析第二篇  
  
CVE-2022-24521分析第三篇  
  
CVE-2022-24521分析第三篇原文  
  
CVE-2022-3022分析  
  
CVE-2022-24521分析谷p0  
  
CVE-2022-37969分析第一部分  
  
CVE-2022-37969分析第二部分  
  
[CVE-2022-37969分析中文第一篇](https://mp.weixin.qq.com/s?__biz=MzI1NTQ0MjEyNQ==&mid=2247483892&idx=1&sn=7b4190690b20e565fc9844a26d7ec9db&scene=21#wechat_redirect)  
  
  
CVE-2023-28266漏洞致谢  
  
（以上文章链接请点击阅读原文查看）  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8FyzJLNPqguHaJMI7BK2ZSiaibZZGI5fstY3Miaia2uYSQuu2oNxWt12ovn9gRPo5Yu4bEETaEWSZlWYw/640?wx_fmt=png "")  
  
  
**看雪ID：王cb**  
  
https://bbs.kanxue.com/user-home-609565.htm  
  
*本文为看雪论坛优秀文章，由 王cb 原创，转载请注明来自看雪社区  
  
  
[](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458499288&idx=1&sn=b2b9cd6ff7388a8658d254e13c72f9ad&chksm=b18e885286f9014436a590f2531fda167be67e1e227ea395812968e828932bd44eade34b0dbf&scene=21#wechat_redirect)  
  
  
**#****往期推荐**  
  
1、[在 Windows下搭建LLVM 使用环境](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500602&idx=1&sn=4bcc2af3c62e79403737ce6eb197effc&chksm=b18e8d7086f9046631a74245c89d5029c542976f21a98982b34dd59c0bda4624d49d1d0d246b&scene=21#wechat_redirect)  
  
  
2、[深入学习smali语法](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500599&idx=1&sn=8afbdf12634cbf147b7ca67986002161&chksm=b18e8d7d86f9046b55ff3f6868bd6e1133092b7b4ec7a0d5e115e1ad0a4bd0cb5004a6bb06d1&scene=21#wechat_redirect)  
  
  
3、[安卓加固脱壳分享](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500598&idx=1&sn=d783cb03dc6a3c1a9f9465c5053bbbee&chksm=b18e8d7c86f9046a67659f598242acb74c822aaf04529433c5ec2ccff14adeafa4f45abc2b33&scene=21#wechat_redirect)  
  
  
4、[Flutter 逆向初探](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500574&idx=1&sn=06344a7d18a72530077fbc8f93a40d8f&chksm=b18e8d5486f904424874d7308e840523ebfb2db20811d99e4b0249d42fa8e38c4e80c3f622c6&scene=21#wechat_redirect)  
  
  
5、[一个简单实践理解栈空间转移](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500315&idx=1&sn=19b12ab150dd49325f93ae9d73aef0c4&chksm=b18e8c5186f90547f3b615b160d803a320c103d9d892c7253253db41124ac6993d83d13c5789&scene=21#wechat_redirect)  
  
  
6、[记一次某盾手游加固的脱壳与修复](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500165&idx=1&sn=b16710232d3c2799c4177710f0ea6d41&chksm=b18e8ccf86f905d9a0b6c2c40997e9b859241a4d7f798c4aeab21352b0a72b6135afce349262&scene=21#wechat_redirect)  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球分享**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球点赞**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球在看**  
  
