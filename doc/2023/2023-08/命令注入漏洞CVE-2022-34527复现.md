#  命令注入漏洞CVE-2022-34527复现   
伯爵的信仰  看雪学苑   2023-07-31 17:59  
  
```
```  
  
  
◆CVE编号：  
CVE-2022-34527（https://www.cvedetails.com/cve/CVE-2022-34527/）  
  
◆漏洞描述：D-Link DSL-3782 v1.03 and below was discovered to contain a command injection vulnerability via the function byte_4C0160.  
  
◆设备型号：D-Link DSL-3782  
  
◆固件版本：DSL-3782_A1_EU_1.01  
  
◆厂商官网：  
http://www.dlink.com.cn/  
  
◆固件地址：  
https://media.dlink.eu/support/products/dsl/dsl-3782/driver_software/dsl-3782_a1_eu_1.01_07282016.zip  
  
> 漏洞披露的信息很模糊，只是说D-Link DSL-3782 v1.03及以下版本中存在一个命令注入漏洞，相关的函数为byte_4C0160。  
> 若是在IDA中，byte_4C0160应该是一个字符串，IDA中的未知函数是sub_xx格式。  
> 本文中复现的版本是D-Link DSL-3782 v1.0。  
  
###   
###   
```
```  
####   
#### 2.1 固件提取  
  
  
使用binwalk对固件解包，获取文件系统。  
  
  
```
```  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqnXiacutDjQQu37PhZcBxq37egzBzQtSicibPccjwgB1FbfI2uJNc6taiaw/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqJeKO0WOU22obfoCeHDE2LAzibQVYQiaYCpOndM9kog1VQcK0qPveGG7g/640?wx_fmt=png "")  
> 在文件系统中看到了boaroot文件夹，猜测该路由器使用的是Boa服务器。Boa服务器是一个小巧高效的web服务器，是一个运行于unix或linux下的，支持CGI的、适合于嵌入式系统的单任务的http服务器，源代码开放、性能高。作为一种单任务Web服务器，Boa只能依次完成用户的请求，而不会fork出新的进程来处理并发连接请求。但Boa支持CGI，能够为CGI程序fork出一个进程来执行。  
  
  
  
查看系统启动文件：/usr/etc/init.d/rcS  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqDPyqerWTtCIqTGc1ibb6icF9q4S4KOLJdRTRZ6riaroJDVfrtHzO0xU7w/640?wx_fmt=png "")  
> 根据启动信息，路由器的Web服务器为Boa，Web根目录为/boaroot。  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2Kqp7ZDJVCNQib9Ibn38ibCaJmtaw419rfpmrhJNS7fAGicauyhMq0CEyp6Q/640?wx_fmt=png "")  
> 在文件系统中发现了utelnetd命令，可用于验证命令注入漏洞。  
  
####   
#### 2.2 固件模拟  
  
  
查看完文件系统后模拟运行固件，定位到相关文件后再详细分析。根据漏洞信息说是一个命令注入，那么直接模拟固件去后台看看有没有可疑的注入点。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqCz1KfxuJmwgMvwKI7Tt8nJPnqgdRCYLheHRibIMOwcGczfiayheM0osA/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqiasFboCuEa5nHGw8MibibmfMseo3Nt7pPGmQYlzJ9V3qHwzqibe7bOws3g/640?wx_fmt=png "")  
> 默认密码为admin。  
  
###   
###   
```
```  
  
  
在后台中查找到如下页面：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqEPlHUaYzzpkQxyCt8iaUmpA1kGDKT0IicjuZCpiaejddRZ0T58ko9kQrA/640?wx_fmt=png "")  
  
  
根据之前的复现经验，命令执行漏洞很有可能出现在ping测试这种页面中。使用burpsuit抓包查看一下：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2Kqlm2gGTVkSRAIRduOedMuvz6ooFfPibibfRml5Xqxvcm7cWia98QSG2KjA/640?wx_fmt=png "")  
  
  
发现ping test 相关文件为：/cgi-bin/New_GUI/Set/Diagnostics.asp，查看一下该文件的内容。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqWVX069e2DrWRlauC6IhnrQSYYdk8dbHib1zia62mfFoJ1g9T1h6MBuicA/640?wx_fmt=png "")  
  
  
根据文件内容判断这是在通过WebApi处理前端提交过来的数据，由前面的Burpsuit抓包的内容可知前端会将Type和Addr的数据传到服务器。查找一下关键字：Diagnostics_Entry看看传入的数据是由哪个文件处理的。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqNnQx5ib9ibvZDcfDBczPwiaMHx3P6mcf3b5ww9Zqic5q3jobA3BCpUzLyA/640?wx_fmt=png "")  
  
  
通过查找内容获得文件userfs/bin/cfg_manager，将该文件拿到IDA中分析。通过关键词查找，成功定位到函数：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2Kqc3PT3vC3ibLAsLksICehQkUTdLdoOwRzgnVicXnbFUCJ0SzNfMhF5OGg/640?wx_fmt=png "")  
  
  
分析整理一下：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqXw3bMusHhIbnsrjVcFG5TVUpE4aEHBxYicaQZUs9Zr6KGIRAz6VWGCw/640?wx_fmt=png "")  
  
  
通过分析可知上述代码的含义为判断前端传来的Type参数是为p还是t，对应的是Ping test和Trace route。命令执行的关键点在于byte_4C0480是否能被前端输入所控制，通过引用查看一下byte_4C0480的来源。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqIF6kTOvibnOvY3hhv3tBapjIRIyr4Kc1w9VLUh2RRB7Ww7EicE016CibA/640?wx_fmt=png "")  
  
  
找到byte_4C0480的来源但是发现不能直接通过F5反汇编为伪代码，需要修正函数。在函数的开始地址处按下P修正后再F5即可得到反汇编的伪代码。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqiaRvSBE9bo6OIFCzCe1ibD7J4GicyIsnZzROPL764xYTV7XpGPEjYHCwA/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqeyUlKUkrq72RkpmKHOf93g8qvoyOpiaUN7pVZlzk1FibpUgzRQJibVxYw/640?wx_fmt=png "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2Kqpbpe5njWMPoGnunkYcdXicHdBe7r5V254L8bw6wka7prkbIwePdaWQQ/640?wx_fmt=png "")  
  
  
通过分析上述代码可知获取到前端输入的Addr后通过sub_46258C进行字符检查，但是检查不充分，可通过如%0a(\n)绕过。检查后使用sprintf函数拼接命令字符串并通过pthread_create传入到线程回调函数中由system函数执行。这是一个由于对前端输入数据检查不充分导致的命令执行漏洞。  
  
  
```
```  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2Kqlm2gGTVkSRAIRduOedMuvz6ooFfPibibfRml5Xqxvcm7cWia98QSG2KjA/640?wx_fmt=png "")  
  
  
通过抓包查看发现POST数据的时候带着session，不能通过Repeater改包发送了，但是可以通过Intercept来更改。在Addr处使用的注入命令为：utelnetd -p 7080 -l /bin/sh  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqjccuGLHuopAEv9kxjFTnczNEotlia8PIPdIJ1WN6mh51TEfvGSrlJAg/640?wx_fmt=png "")  
  
  
使用nc连接成功，取得shell。  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2KqeKxFngmqHiaDD2N7jkicjicvK3Sz0Et33picvWDdtZP53k0Vyib3G534mtg/640?wx_fmt=png "")  
###   
###   
```
```  
  
  
```
```  
  
  
  
EXP执行后成功取得shell：  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2Kqvbiah18WgnQU27GfjFic4k552yt30iagOWtCYicL3NenZ8vOVZnTjWyyLw/640?wx_fmt=png "")  
  
  
```
```  
  
  
和前一篇命令执行漏洞一样，此漏洞是因为字符过滤不完全导致的命令执行漏洞。当遇到CVE漏洞信息描述的比较模糊时，模拟固件去后台看看有没有可疑漏洞点很有必要，这样可以快速定位到漏洞页面或者相关文件。  
  
  
```
```  
  
  
◆  
D-Link DSL-3782 代码注入漏洞CVE-2022-34527分析- IOTsec-Zone物联网安全社区（https://www.iotsec-zone.com/article?id=240）  
  
  
◆  
https://github.com/1160300418/Vuls/blob/main/D-Link/DSL-3782/CMDi_in_D-Link%20DSL-3782.md  
  
  
◆  
https://github.com/FzBacon/CVE-2022-34527_D-Link_DSL-3782_Router_command_injection/blob/master/CVE-2022-34527_D-Link_DSL-3782_Router_command_injection.md  
  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Fabib5KK8ZS6UW8NDa8m2Kqxnicguf256p99kF6XMPJdIBIpRL9gChhiaiaFqicibX1k7XwI6ibaWZ4WoGw/640?wx_fmt=png "")  
  
  
**看雪ID：伯爵的信仰**  
  
https://bbs.kanxue.com/user-home-882513.htm  
  
*本文为看雪论坛优秀文章，由 伯爵的信仰 原创，转载请注明来自看雪社区  
  
  
[](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458499288&idx=1&sn=b2b9cd6ff7388a8658d254e13c72f9ad&chksm=b18e885286f9014436a590f2531fda167be67e1e227ea395812968e828932bd44eade34b0dbf&scene=21#wechat_redirect)  
  
  
**#****往期推荐**  
  
1、[在 Windows下搭建LLVM 使用环境](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500602&idx=1&sn=4bcc2af3c62e79403737ce6eb197effc&chksm=b18e8d7086f9046631a74245c89d5029c542976f21a98982b34dd59c0bda4624d49d1d0d246b&scene=21#wechat_redirect)  
  
  
2、[深入学习smali语法](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500599&idx=1&sn=8afbdf12634cbf147b7ca67986002161&chksm=b18e8d7d86f9046b55ff3f6868bd6e1133092b7b4ec7a0d5e115e1ad0a4bd0cb5004a6bb06d1&scene=21#wechat_redirect)  
  
  
3、[安卓加固脱壳分享](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500598&idx=1&sn=d783cb03dc6a3c1a9f9465c5053bbbee&chksm=b18e8d7c86f9046a67659f598242acb74c822aaf04529433c5ec2ccff14adeafa4f45abc2b33&scene=21#wechat_redirect)  
  
  
4、[Flutter 逆向初探](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500574&idx=1&sn=06344a7d18a72530077fbc8f93a40d8f&chksm=b18e8d5486f904424874d7308e840523ebfb2db20811d99e4b0249d42fa8e38c4e80c3f622c6&scene=21#wechat_redirect)  
  
  
5、[一个简单实践理解栈空间转移](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500315&idx=1&sn=19b12ab150dd49325f93ae9d73aef0c4&chksm=b18e8c5186f90547f3b615b160d803a320c103d9d892c7253253db41124ac6993d83d13c5789&scene=21#wechat_redirect)  
  
  
6、[记一次某盾手游加固的脱壳与修复](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458500165&idx=1&sn=b16710232d3c2799c4177710f0ea6d41&chksm=b18e8ccf86f905d9a0b6c2c40997e9b859241a4d7f798c4aeab21352b0a72b6135afce349262&scene=21#wechat_redirect)  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球分享**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球点赞**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8FHJ5XNqGmzLUOYeEJc9zylullBt3UKTEQsoxy2icCZlrib0kGSnnibUmPhrtv1ic2HR4SZvjH2PiaQASw/640?wx_fmt=gif "")  
  
**球在看**  
  
