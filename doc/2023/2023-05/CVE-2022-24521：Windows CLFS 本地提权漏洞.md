#  CVE-2022-24521：Windows CLFS 本地提权漏洞   
 网络安全应急技术国家工程中心   2023-05-26 14:54  
  
CLFS是Microsoft在Windows Vista和Windows Server 2003 R2中为实现高性能而引入的日志框架，它为应用程序提供API函数来创建、存储和读取日志数据。利用此漏洞可以在计算机上执行任意代码，绕过安全限制并获得系统管理员权限。  
  
**Part1、漏洞状态**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGoguRHkgcwqS0RiaPBflZmGtEQ8PiaRanetwmyStibYjGmSdicmnVDJDLywic5vbut2Vx7xd3x1DHSqrXw8Q/640?wx_fmt=png "")  
****  
**Part2、漏洞描述**  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/iaz5iaQYxGoguRHkgcwqS0RiaPBflZmGtEQjeuwI3QxghibqVGsxy3zA4Wic6lKDnPxPA0rFEKMOU5E2wibI17I9DPKA/640?wx_fmt=png "")  
****  
**Part3、漏洞复现**  
  
**1. 复现环境**  
  
系统版本：  
Windows 10 版本 1903  
  
**2. 复现步骤**  
  
  
运行漏洞利用程序后，当前用户变更为system  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2ic5sjQ92eBEko7jiaXytkpvdumEiazTSOeib75xvEj7BibCGhkkQjcPXmew/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
Part4、  
漏洞分析  
  
CClfsBaseFilePersisted::LoadContainerQ函数的第215行判断_CLFS_CONTAINER_CONTEXT结构的cidQueue字段值是否为-1，为-1时则调用CClfsBaseFilePersisted::RemoveContainer函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM21aAIdo2Xldt6iaH6icThGuQicWlMYkVfXkE6HibYWeoeDCCJpBq37V3Jbw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
CClfsBaseFilePersisted::RemoveContainer函数的第56行调用CClfsBaseFilePersisted::FlushImage函数处理文件数据，当结果大于等于0时，取_CLFS_CONTAINER_CONTEXT的pCaontainer字段值，并调用相关函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2MK090libee983IDTicJzHgRtHD3WGdYz6QkaPCQsqSoL6DzPHMrgqJdw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
CClfsBaseFilePersisted::FlushImage函数第8行调用了CClfsBaseFilePersisted::WriteMetadataBlock函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2XVSiaOicNSGfWdEM8I0KNSlytvDIwOWpVDRltXLfktXSKgTV0mmWwrwQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
CClfsBaseFilePersisted::WriteMetadataBlock函数调用ClfsEncodeBlock和ClfsDecodeBlockjams函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2RZVvn1YSp2atWL0RvGbEIliaQEsPbgybkpSuYHyoAHF09HaulIFyd5Q/640?wx_fmt=png "")  
  
  
ClfsEncodeBlock调用ClfsEncodeBlockPrivate函数处理数据。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2ljia1SiaU8r8ria5A58XJmFiaic4bXHlyg8kFGuFibuaYjtNMvwhCEWR24cw/640?wx_fmt=png "")  
  
ClfsEncodeBlockPrivate函数将扇区最后2字节数据写入到签名缓冲区，然后使用生成的签名替换原有的2字节数据。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2BCh5eGmicNajVAEVVPSfPwB48jNqD4bKTpaRla0oQUrXd5s5RgT8wjg/640?wx_fmt=png "")  
  
ClfsDecodeBlockjams调用ClfsDecodeBlockPrivate函数处理数据。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2HeYk4zgZiaITPjFXswmCoJlseybQuIzq0brj7nQMdvicQAibwk9ibu7QKw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
ClfsDecodeBlockPrivate函数将签名缓冲区数据写回扇区最后2字节，但缓冲区内的数据并未进行处理。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmadVOIKm7RczibvJ3YjpnDM2NvibeyrYJwtticvNMBRUnCMB6SlK4UhlvcNInYZ7HObO1bS6VwMw1rPA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
漏洞利用过程：  
  
1、构造日志文件，使_CLFS_CONTAINER_CONTEXT结构的cidQueue字段值为-1，pCaontainer字段值为代码地址，签名缓冲区偏移指向pCaontainer所在地址。  
  
2、调用CreateLogFile API打开已有的日志文件，此时会调用ClfsDecodeBlockPrivate函数，将签名缓冲区数据写回到扇区最后2字节。  
  
3、当_CLFS_CONTAINER_CONTEXT结构的cidQueue字段值为-1时，会调用CClfsBaseFilePersisted::RemoveContainer函数。  
  
4、RemoveContainer函数调用CClfsBaseFilePersisted::FlushImage函数将扇区最后2字节写入到pCaontainer字段。  
  
5、当RemoveContainer函数调用完FlushImage函数后，pCaontainer值被替换为指定的代码地址，随后会将该地址作为虚表指针并调用相关函数。  
因为pCaontainer是可控的，因此可以执行任意构造的代码，从而实现权限提升。  
  
**Part5、修复建议**  
  
https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-24521  
  
根据系统安装链接内相应补丁。  
  
  
  
原文来源：安帝Andisec  
  
“投稿联系方式：孙中豪 010-82992251   sunzhonghao@cert.org.cn”  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/GoUrACT176n1NvL0JsVSB8lNDX2FCGZjW0HGfDVnFao65ic4fx6Rv4qylYEAbia4AU3V2Zz801UlicBcLeZ6gS6tg/640?wx_fmt=jpeg "")  
  
  
