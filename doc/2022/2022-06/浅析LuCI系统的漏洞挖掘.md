#  浅析LuCI系统的漏洞挖掘   
原创 信创实验室  山石网科安全技术研究院   2022-06-10 16:39  
  
**0****1**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
**摘要**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
  
  
Luci  
系统  
是基于lua  
语言编写的一套开源系统，主要是介绍对其审计的一些技巧，先从准备阶段谈谈工具的使用，再讲一下从代码审计中的一些思路，希望能读完这篇文章的读  
者能有所收获。  
  
  
**02**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
**准备阶段**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
  
  
除非黑盒测试，代码审计是漏洞挖掘必不可少的过程，这个代码不仅限于我们下面要讲到的  
lua  
语言，还有  
php  
、  
java  
甚至是  
python  
，以及平时  
CTF  
中经常令二进制手头疼的伪  
C  
代码，通过代码审计我们可以了解整个程序开发的逻辑和接口调用的流程等等，然后从中找到程序的缺陷，轻则造成拒绝服务，重则直接  
RCE  
。  
  
****  
**2.1****工具使用**  
  
****  
磨刀不误砍柴工，有个好的审计工具对于代码审计是很重要的，工具用的好，往往可以使我们得心应手。我这里推荐的工具  
vscode  
，相信这个工具对于在读的各位并不陌生，  
Visual Studio Code  
（简称  
VS Code  
）是一个由微软开发，同时支持  
Windows   
、  
Linux   
和  
 macOS   
等操作系统的免费代码编辑器，其强大之处主要在于该工具众多强大的插件。这里主要介绍两个，分别是  
vscode-lua-format  
和  
lua  
。  
  
### 2.1.1   vscode-lua-format  
  
我们发现，有些固件从中提取出来的文件系统中，  
lua  
文件里面的  
lua  
代码全都是乱码很难看，这无疑会给我们代码审计工作带来巨大的困难。这个插件可以美化代码，使得代码看起来更清晰，更高大上了！  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiasMQhXibTATOjV8icWUtddCCAlDc5cCnFmYCiaGS5Zlib0mXYMF5iad0VsYA/640?wx_fmt=png "")  
  
  
  
### 2.1.2    lua  
  
如果称代码格式化的插件为基石，那么这款插件就可以称为辅助。该插件可以让你查看各个函数之间的调用关系，更快地理清程序的基本逻辑。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiacvWWM3DyJSe7cqsbFiaNWjevL3y0xdN2UJLfpDkfZYCIUrKJbqgyiaMQ/640?wx_fmt=png "")  
  
  
  
  
**2.2   提取文件系统**  
  
首先就是想办法拿到固件，有些官网上可以下载，或者可以买个设备回来提取  
flash  
。拿到固件以后可以直接  
binwalk  
提取文件系统，如果是遇到  
ubi  
文件系统的，用  
ubireader_extract_images  
工具即可提取。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaZbu4ib4JaicyXMENWAbUsRFVOumSlfEhcfdR89DQMIGkFHelibDbYfTyw/640?wx_fmt=png "")  
  
  
  
  
  
**03**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
**代码审计**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
  
#   
  
**3.1   寻找攻击面**  
  
一般主要有两种思路，一种是从正向的角度来寻找脆弱点，就是先找网站各个功能的的接口，然后再根据接口的名称找到对应的逻辑代码对其进行审计。这种方法好处就是覆盖得比较全面，但是缺点也很明显，就是一个网站的接口可能会很庞大，这样审计起来就会很麻烦，还有就是无法找到隐藏的接口。  
  
  
还有一种是从反向的角度来寻找脆弱点，就是首先找到代码中的危险函数，然后再全局查找是哪个接口来调用了它，以此来找到对应的代码来对其进行审计。这种方法唯一的缺点就是覆盖不够全面，有时候可能会遗漏某些有逻辑漏洞的接口，不过最大的优点就是对症下药，直接找到脆弱点，所以我们这里主要就是介绍这种方法。  
  
  
**3.2  了解接口调用的逻辑**  
  
如果要找到对应接口的代码漏洞，首先要了解接口调用的代码逻辑，然后去审计对应的代码，在我们理清逻辑之后，就可以找出其隐藏的一些接口，就是后台是有这个接口的代码的，但是开发人员由于某些原因在前端删掉了对应的接口代码，就存在这样的隐藏接口。这就是代码审计的强大之处，是黑盒测试无法媲美的。  
  
  
下面就以某厂商的一款路由器为例：  
<table><tbody><tr><td width="464" valign="top" style="border-width: 1pt;border-style: solid;border-color: windowtext;padding: 0cm 5.4pt;"><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="font-size: 15px;line-height: 3px;font-family: 宋体;letter-spacing: 1px;">//post包</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">POST /stok=89eb18a6314226c045d82175589ff4a1/ds HTTP/1.1</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">Host: 192.168.0.1</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">Content-Length: 132</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">Origin: http://192.168.0.1</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">Connection: close</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">Referer: http://192.168.0.1/</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">{&#34;method&#34;:&#34;add&#34;,&#34;ipgroup&#34;:{&#34;table&#34;:&#34;rule_ipgroup&#34;,&#34;para&#34;:{&#34;flag&#34;:&#34;user&#34;,&#34;name&#34;:&#34;aa&#34;,&#34;rule_scope&#34;:[&#34;---&#34;],&#34;comment&#34;:&#34;aa&#34;,&#34;ref&#34;:&#34;0&#34;}}}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="font-size: 15px;line-height: 3px;font-family: 宋体;letter-spacing: 1px;">//对应代码</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function index()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    register_module(&#34;ipgroup&#34;, &#34;ipgroup&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local e = require(&#34;luci.model.uci&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local e = e.cursor()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    register_keyword_set_data(&#34;ipgroup&#34;, &#34;rule_ipgroup&#34;, &#34;rule_ipgroup_set_data&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    register_keyword_add_data(&#34;ipgroup&#34;, &#34;rule_ipgroup&#34;, &#34;rule_ipgroup_add_data&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    register_keyword_del_data(&#34;ipgroup&#34;, &#34;rule_ipgroup&#34;, &#34;rule_ipgroup_del_data&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function rule_ipgroup_add_data(t, l, l, l)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local l = p.cursor()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local r = e.ipgroup_table_count_get_by_key_value(&#34;flag&#34;, &#34;user&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local l = l:get_profile(&#34;ipgroup&#34;, &#34;group_max&#34;) or s</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if t.flag == &#34;user&#34; and r &gt;= l then return n.ETABLEFULL end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local l = e.ipgroup_table_entry_get_is_exist(&#34;name&#34;, t.name)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if l ~= false then return n.EENTRYEXIST end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    t.secname = t.name</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    t.flag = t.flag or &#34;user&#34;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    t.comment = t.comment or &#34;&#34;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if t.comment ~= nil then t.comment = string.gsub(t.comment, &#34;&#39;&#34;, &#34;&#39;&#39;&#34;) end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if t.rule_scope == nil then t.rule_scope = {} end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if t.rule_ipgroup == nil then t.rule_ipgroup = {} end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    e.ipgroup_table_entry_insert(t)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local _ = e.ipgroup_table_entry_get_is_exist(&#34;name&#34;, t.name, &#34;id&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local r = e.ipscope_table_entry_get_id_table_by_name(t.rule_scope)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local l = {}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    for e = 1, #r do l[e] = r[e].id end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if #l &gt; 0 then e.relation_table_entry_multi_insert(_[1].id, l) end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local r = e.ipgroup_table_entry_get_id_table_by_name(t.rule_ipgroup)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local l = {}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    for e = 1, #r do l[e] = r[e].id end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if #l &gt; 0 then e.group_relation_table_entry_multi_insert(_[1].id, l) end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    ipgroup_after_proc(&#34;add&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    return n.ENONE, {[&#34;ipgroup&#34;] = {[&#34;name&#34;] = t.name}}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">end</span></section></td></tr></tbody></table>  
  
由上面可以知道，  
post  
包中  
json  
数据的  
method  
参数的值可以是  
add  
、  
set  
、  
del  
，分别对应代码中的三个函数，接着  
ipgroup  
对应  
register_keyword_set_data  
函数的第一个参数，  
table  
的值对应第二个参数，第三个参数就是对应注册要执行的函数，函数传进的第一个参数就是对应后面一串  
json  
数据。  
  
  
**3.3  寻找危险函数**  
  
我们理清完接口的调用逻辑之后，现在就可以反向寻找脆弱点。先来找他的危险函数，跟审计伪  
C  
代码不一样的是，他不用考虑栈方面的漏洞。  
  
### 3.3.1    寻找命令执行函数  
  
这是我们寻找命令注入漏洞最常用的方法，就是找命令执行的函数，在lua  
语言中，命令执行的函数有os.execute  
、io.popen  
等等。execute  
函数相当于C  
语言中的system()  
，函数有一个缺省的参数command  
，这个函数就是解析command  
再来通过的系统来调用解析的结果。popen  
在额外的进程中启动程序  
prog  
，并返回用于  
prog  
的文件句柄。通俗的来说就是使用这个函数可以调用一个命令（程序），并且返回一个和这个程序相关的文件描述符，一般是这个被调用函数的输出结果。  
  
  
在luci  
框架中，除了这些库函数，在sys.lua  
文件还有其他对其进行包装的函数如call()  
、fork_cal()l  
、exec()  
等  
  
<table><tbody><tr><td width="464" valign="top" style="border-width: 1pt;border-style: solid;border-color: windowtext;padding: 0cm 5.4pt;"><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function call(...) return u.execute(...) / 256 end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function fork_exec(...)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local e = n.fork()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if e == 0 then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        n.chdir(&#34;/&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        n.chdir(&#34;/&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        local e = n.open(&#34;/dev/null&#34;, &#34;w+&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if e then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n.dup(e, n.stderr)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n.dup(e, n.stdout)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n.dup(e, n.stdin)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            if e:fileno() &gt; 2 then e:close() end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return n.exec(&#34;/bin/sh&#34;, &#34;-c&#34;, ...)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    else</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function fork_call(...)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local t = n.fork()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if t == 0 then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        local e = n.open(&#34;/dev/null&#34;, &#34;w+&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if e then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n.dup(e, n.stderr)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n.dup(e, n.stdout)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n.dup(e, n.stdin)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            if e:fileno() &gt; 2 then e:close() end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return n.exec(&#34;/bin/sh&#34;, &#34;-c&#34;, ...)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    elseif t &gt; 0 then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        local t, e, n = n.waitpid(t)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if e == &#34;exited&#34; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            return n</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        else</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            return nil</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function exec(e)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local e = r.popen(e)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local n = e:read(&#34;*a&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    e:close()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    return n</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">end</span></section></td></tr></tbody></table>  
### 3.3.2      全局搜索  
  
利用全局搜索，我们可以找到这些危险函数在哪里调用的，进而来具体审计代码。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBias00iaAt7LEDY2KCCaWjOibCRDwly44nxq3I8nstoFwqibEoNkRmUJKwcg/640?wx_fmt=png "")  
  
  
  
  
**3.4 寻找文件上传接口**  
  
openwrt  
下有个 luci.http.setfilehandler  
作为文件上传函数，来看其中一个例子。  
  
<table><tbody><tr><td width="464" valign="top" style="border-width: 1pt;border-style: solid;border-color: windowtext;padding: 0cm 5.4pt;"><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function upload_pic()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local t = {}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local l, i, _</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local c = 0</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local d = 200 * 1024</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local r = 0</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local a = &#34;/www/web-static/resources/authserver/tmpfile&#34;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local h = PORTAL_TEMPLATE_DIR</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="font-size: 15px;line-height: 3px;font-family: 宋体;letter-spacing: 1px;">    luci.http.setfilehandler(function(i, t, e) 参数i是个结构体，里面有文件名，文件大小等参数</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if not l then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            l = io.open(a, &#34;w&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            c = 0</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if t then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            c = c + #t</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            if c &lt;= d then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                l:write(t)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            else</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                if 0 == r then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    l:close()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    o.fork_call(&#34;rm -f &#34; .. a)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    l = io.open(a, &#34;w&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    r = 1</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if e then l:close() end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    luci.http.formvalue(&#34;filename&#34;)</span></section></td></tr></tbody></table>  
  
setfilehandler函数是调用一个回调函数，如果没有调用formvalue函数，setfilehandler函数将不会执行,而且至少有一个formvalue函数在setfilehandler函数的外面，利用这个可能会找到命令注入、任意文件上传等漏洞。  
  
  
  
  
**3.5 寻找二进制程序的漏洞**  
  
我们在审计代码的时候，除了他代码本身的漏洞，有时候还能找出其中调用的二进制程序中的漏洞，例如：  
  
<table><tbody><tr><td width="464" valign="top" style="border-width: 1pt;border-style: solid;border-color: windowtext;padding: 0cm 5.4pt;"><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">function upload_db()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local _ = 131072</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local t = 0</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local i</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local t = nil</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local o = nil</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local l = 0</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local n = e.ENONE</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    luci.http.setfilehandler(function(r, a, s)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if not i then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            if r then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                if r.name == &#34;isp_database&#34; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    t = p</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    o =</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                        &#34;. /lib/isp_route/isp_route.sh &amp;&amp; isp_route_restore_database&#34;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                elseif r.name == &#34;user_database&#34; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    t = d</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                    o =</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                        &#34;. /lib/isp_route/isp_route.sh &amp;&amp; isp_restore_user_database&#34;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            if t == nil then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                n = e.EISPDBNULLFILENAME</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                return</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            i = io.open(t, &#34;w&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            l = 0</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if a then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            l = l + #a</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            if l &lt;= _ then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                i:write(a)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            else</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                n = e.EISPDBTOOLARGE</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">                return</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if s then i:close() end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    luci.http.formvalue(&#34;trigger-parser&#34;)</span></section></td></tr></tbody></table>  
  
这个代码中调用了isp_route.sh  
，而且他的参数isp_route_restore_database  
是我们可以控制的，再来看下这个sh  
脚本的内容。  
  
<table><tbody><tr><td width="464" valign="top" style="border-width: 1pt;border-style: solid;border-color: windowtext;padding: 0cm 5.4pt;"><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">isp_route_restore_database()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">{</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if [ ! -f $ISP_DATABASE_TMP ];then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return 1;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    fi</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    /usr/sbin/isp_route_db system -c</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if [ $? != &#34;0&#34; ]; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        logger -t isp -p warn &#34;The isp system database&#39;s format is invalid.&#34;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        rm $ISP_DATABASE_TMP -f</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return 1;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    fi</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    #move the tmp isp database to /etc/nouci_config/dbs</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    mv $ISP_DATABASE_TMP $ISP_DATABASE_DIR -f</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    state=`uci get isp_route.global.state 2&gt;/dev/null`</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    [ &#34;$state&#34; == &#34;on&#34; ] &amp;&amp; /etc/init.d/isp_route stop</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    /usr/sbin/isp_route_db system -b</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if [ &#34;$state&#34; == &#34;on&#34; ]; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        /etc/init.d/isp_route start</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    else</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        for i in $isp_tables; do</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">             ipset destroy $i 2&gt;/dev/null</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        done</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    fi</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">isp_restore_user_database()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">{</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if [ ! -f $ISP_USER_DB_TMP ];then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return 1;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    fi</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    #check the valid of user&#39;s database</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    /usr/sbin/isp_route_db user -c</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if [ $? != &#34;0&#34; ]; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        logger -t isp -p warn &#34;The isp user database&#39;s format is invalid.&#34;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        rm $ISP_USER_DB_TMP -f</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return 1;</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    fi</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    #move the tmp isp database to /etc/nouci_config/dbs</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    mv $ISP_USER_DB_TMP $ISP_USER_DB_DIR -f</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    state=`uci get isp_route.global.state 2&gt;/dev/null`</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    [ &#34;$state&#34; == &#34;on&#34; ] &amp;&amp; /etc/init.d/isp_route stop</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    /usr/sbin/isp_route_db user -b</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if [ &#34;$state&#34; == &#34;on&#34; ]; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        /etc/init.d/isp_route start</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    else</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        ipset destroy ISP_USER_DEFINE 2&gt;/dev/null</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    fi</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">}</span></section></td></tr></tbody></table>  
  
这个脚本调用了一个叫isp_route_db的二进制程序，我们这时候就可以继续用ida来对这个程序进行分析  
  
  
这时候我们就可以跟平时一样审计改程序有没有命令注入和栈溢出等二进制的漏洞。  
  
  
**3.6 寻找前台漏洞**  
  
后台的接口众多，所以相对比较好挖，不过后台漏洞的情况下大部分意义不大，如果我们想要扩大漏洞的危害，自然是要去寻找不用去登录认证的漏洞，这时候就要去审计前台中的漏洞，奈何一般路由器类的前端只有一个登录的接口，我们可以去找到并审计一下这个接口：  
  
<table><tbody><tr><td width="464" valign="top" style="border-width: 1pt;border-style: solid;border-color: windowtext;padding: 0cm 5.4pt;"><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="font-size: 15px;line-height: 3px;font-family: 宋体;letter-spacing: 1px;">//post包</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">{&#34;method&#34;:&#34;do&#34;,&#34;login&#34;:{&#34;username&#34;:&#34;xxxxx&#34;,&#34;password&#34;:&#34;xxxxx&#34;}}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="font-size: 15px;line-height: 3px;font-family: 宋体;letter-spacing: 1px;">//对应代码</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">if n[&#34;query_auth_log&#34;] then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if n.method ~= &#34;do&#34; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            r[e.NAME] = e.EINVARG</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            write_json(r)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            return false</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return action_get_unauth_log(n[&#34;query_auth_log&#34;])</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if n[&#34;get_domain_array&#34;] then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if n.method ~= &#34;do&#34; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            r[e.NAME] = e.EINVARG</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            write_json(r)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            return false</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return action_get_domain_array(n[&#34;get_domain_array&#34;])</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    local a, c = l.is_locked()</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if a then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        r[e.NAME] = e.EUNAUTH</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        r.data = get_unauth_data(c)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        write_json(r)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return false</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if &#34;&#34; ~= i then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        luci.http.redirect(&#34;/&#34;)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return false</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if n.login then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if n.method ~= &#34;do&#34; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            r[e.NAME] = e.EINVARG</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            write_json(r)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            return false</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return action_login(n.login)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    if (n[&#34;administration&#34;] and n[&#34;administration&#34;][&#34;set_pwd_before_login&#34;]) or</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        n[&#34;set_password&#34;] then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if n.method ~= &#34;do&#34; then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            r[e.NAME] = e.EINVARG</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            write_json(r)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            return false</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        if n[&#34;set_password&#34;] then</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            local e = n[&#34;set_password&#34;][&#34;username&#34;]</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            local t = n[&#34;set_password&#34;][&#34;password&#34;]</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n[&#34;set_password&#34;] = nil</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n[&#34;administration&#34;] = {}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n[&#34;administration&#34;][&#34;set_pwd_before_login&#34;] = {}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n[&#34;administration&#34;][&#34;set_pwd_before_login&#34;][&#34;username&#34;] = e</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">            n[&#34;administration&#34;][&#34;set_pwd_before_login&#34;][&#34;password&#34;] = t</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        end</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">        return t.ds(n)</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">    end</span></section></td></tr></tbody></table>  
  
我们发现在寻找登录接口的过程中，还发现了其他的前端接口。  
  
<table><tbody><tr><td width="464" valign="top" style="border-width: 1pt;border-style: solid;border-color: windowtext;padding: 0cm 5.4pt;"><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="font-size: 15px;line-height: 3px;font-family: 宋体;letter-spacing: 1px;">//post包</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">{&#34;method&#34;:&#34;do&#34;,&#34;query_auth_log&#34;:{&#34;xxx&#34;:&#34;xxxxx&#34;,&#34;xxx&#34;:&#34;xxxxx&#34;}}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;">{&#34;method&#34;:&#34;do&#34;,&#34;get_domain_array&#34;:{&#34;xxx&#34;:&#34;xxxxx&#34;,&#34;xxx&#34;:&#34;xxxxx&#34;}}</span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section><section style="text-align: left;margin: 0cm 8px;font-size: 10.5pt;font-family: Arial, sans-serif;line-height: 1.75em;"><span style="line-height: 3px;font-family: 宋体;font-size: 15px;letter-spacing: 1px;"><o:p> </o:p></span></section></td></tr></tbody></table>  
  
**04**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
**总结**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnQt6mic2S5e0jD8O0sq6QlBiaW7icgp57KNnua7OvEohm3bIqkPVjZ9VdLoGDib2VKjibx5qUkz9m2PRGA/640?wx_fmt=png "")  
  
  
  
综上，我们以某厂商的路由器为例介绍了luci  
系统的漏洞挖掘技巧，从代码审计角度讲了如何去挖接口的一些漏洞，如有讲得不对的地方请多多指正。  
  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Gw8FuwXLJnRQjThianTiaQ3B58SQ9XgXWGDiangTAk9rkURTnh8lqCrjgaCCtKwcwm5h9DMRmxibQw58TyhTXz0Ucg/640?wx_fmt=png "")  
