#  【技术干货】CVE-2022-26134 Confluence OGNL RCE 漏洞分析   
 星阑科技   2022-06-16 12:06  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOeiaFHTFtiatmEIxZQcXOHfyr6GOBM88IeMm28ybjSAHEJKicuQxPxN5L5NFZ5mza2NOnuokf9ant2fUQ/640?wx_fmt=gif "")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLKWSxBUmsxRCOqbNibhhXFuhtfXiak5ibYGMcEGD9yzzIy4qVq1Q5a63IQ/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLgZE9TXJrsxHuabVS0UbocSyplzJJ0pxtQQZpAzIBdZwlByjZ3qUUAQ/640?wx_fmt=png "好看的图.png")  
  
**xxhzz**  
  
**@PortalLab实验室**  
  
  
**漏洞描述**  
  
最近 Confluence 官方通报了一个严重漏洞 CVE-2022-26134，远程攻击者在未经身份验证的情况下，可构造OGNL表达式进行注入，实现在Confluence Server或Data Center上执行任意代码。  
  
**利用范围**  
  
Confluence Server and Data Center >= 1.3.0  
  
Confluence Server and Data Center < 7.4.17  
  
Confluence Server and Data Center < 7.13.7  
  
Confluence Server and Data Center < 7.14.3  
  
Confluence Server and Data Center < 7.15.2  
  
Confluence Server and Data Center < 7.16.4  
  
Confluence Server and Data Center < 7.17.4  
  
Confluence Server and Data Center < 7.18.1  
  
**环境搭建**  
  
使用docker-compose文件进行漏洞环境搭建。  
```
version: '2'
services:
  web:
    image: vulhub/confluence:7.13.6
    ports:
      - "8090:8090"
      - "5050:5050"
    depends_on:
      - db
  db:
    image: postgres:12.8-alpine
    environment: 
    - POSTGRES_PASSWORD=postgres
    - POSTGRES_DB=confluence
```  
  
使用命令docker-compose up -d成功启动环境后，查看容器id等相关信息（5050为远程调试端口）。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZvdQRyC3mx7r6UoeV0MbEA1uPLviccjLBHOgJ6jOfv7brtt1wDu0v2Vw/640?wx_fmt=png "")  
  
进入容器后将/opt/atlassian目录下的confluence源码使用docker cp命令复制到本地。![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZgVsY3sLcRQ78SLLWeMFy7dCqQib0jCUhMTG0KZcGzdVsnCgIAalqXGQ/640?wx_fmt=png "")  
  
  
使用IDEA将/confluence/WEB-INF下的atlassian-bundled-plugins、atlassian-bundled-plugins-setup、lib文件拉取为依赖文件。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZMkvib5Kibrwu1LRJHef0cVsZvX8XCQCC7ic74Oqk5icOmLnynTocFP5g2w/640?wx_fmt=png "")  
  
IDEA中配置远程调试。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZlewvOnJ7LGDPh6HP5chIW36sicY5T9M1BHOJySQvWUhBiacOwGWpCibGQ/640?wx_fmt=png "")  
  
在容器中/opt/atlassian/confluence/bin目录下修改setenv.sh文件，加入远程调试配置。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZYsrIPOeBLdABiaecXDfxQL23cBzphJxIuZJS3dGdkLKlibCnBJpxicFSQ/640?wx_fmt=png "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZgpaOxvbu74C90icibrmtkBEmld1rbxyICWk0XGPgb96zH696kb3Qj9iag/640?wx_fmt=png "")  
  
访问http://IP:8090，进行相关配置（需要登录confluence官网进行证书申请）。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZvoqNOmvzibnp8ZV2IYKB2xAXR7RcBjAZmuppYzhRVaqfEEcdBRZYO6Q/640?wx_fmt=png "")  
  
漏洞分析环境成功搭建。  
  
**漏洞复现**  
  
成功命令执行  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZ6jfgPeO8lia4hLwK8232GtxgqnJ7sb3YicS210CJicwdKn7v1AgcrsGtw/640?wx_fmt=png "")  
  
**漏洞分析**  
  
以登录请求为例，对confluence请求处理流程进行调试分析。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZyDaANZXibOicCENj6VzhbGXEYtYTkUJpktgdxib0XfP6n7hK9lvtkAzcA/640?wx_fmt=png "")  
  
首先访问/login.action，经过一系列Filter处理后，将进入Servlet 的分发器 ServletDispatcher。  
  
com.opensymphony.webwork.dispatcher.ServletDispatcher  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZv4VDA4IBfBGr6R8lrveV7I11vAqxqjc0aYqKqvy4K3fWxRKibHEJiacA/640?wx_fmt=png "")  
  
在ServletDispatcher中，通过getNameSpace 、getActionName 、 getRequestMap 、 getSessionMap 、 getApplicationMap函数 ，分别去获取对应的值。（使用payload=/${4*4}/）。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZaFgR0pJRZzJxf0fwKC2C2DpMRiaZydmfRic0xGia7vWGAVYcDycxRjicqA/640?wx_fmt=png "")  
  
重点分析getNamespace函数，其对应的值为namespace。  
  
在com.opensymphony.webwork.dispatcher.ServletDispatcher#getNamespace中。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZEVB0MHfr2I80UlRWoy06bGqyM4iaxuutyOicQrwQU4Ablc1VTInRsOqA/640?wx_fmt=png "")  
  
通过调用com.atlassian.plugin.servlet.PluginHttpRequertWrapper#getServletPath函数，获取了请求servletPath的值。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZqLibMicbGHVjKBBmCTibuU5ibgbW1gUbTzqNTNmMpUFYKiawY2QTABQwkRA/640?wx_fmt=png "")  
  
随后进入回到com.opensymphony.webwork.dispatcher.ServletDispatcher中进入getNamespaceFromServletPath函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZZKV9X0GwyCxz8GMVWwibzVQfmg7xpTFicsYt5JG9nrDDXQuUp79icVybQ/640?wx_fmt=png "")  
  
通过对字符串的截取 ，使得namespace 的取值为请求 servletPath 最后一个 / 之前的部分。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZl0lWHAJdN0a1n9icSplo4Bszs5tFWiaJ88ibibfc1S2JA46WNRFBYWrBIg/640?wx_fmt=png "")  
  
根据com.opensymphony.webwork.dispatcher.ServletDispatcher#serviceAction函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZkeGhwRUvEJvGn4icfrZffU9snahGRbOBCCibKGxbNS4gC6TAfInMwAVw/640?wx_fmt=png "")  
  
到com.opensymphony.xwork.DefaultActionProxy#execute，实例化 DefaultActionProxy 对象，调用其execute函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZqjibQT2xVdEXibZVtjKMquxFjrkAYyk5icWIlhvsHiatrXg17eCI5U1pzw/640?wx_fmt=png "")  
  
随后进入com.opensymphony.xwork.DefaultActionlnvocation#invoke函数，通过Next获取拦截器对象。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZBBNauicpPoYbJAVGkJujkp8q4EOhUw65OPnHZRHCrXKHqa8OtRWqxpg/640?wx_fmt=png "")  
  
继续跟进来到com.opensymphony.xwork.interceptor.Aroundlnterceptor#intercept，发现invoke函数通过调用intercept方法，形成迭代循环。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZHHEZdXp4lHMvRo73icS6VdKdowNSkCAqeLxLme2VdfoYLMmIVlm9Ayw/640?wx_fmt=png "")  
  
通过不断调试，发现在满足一定条件之后，将不会继续调用invoke函数，而是将返回 notpermitted  并赋值给 resultCode，跳出循环。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZbWron1eicApDsaQDNKkXLJuLbqjLkRqExqibLq5buDUl5HbJHjiauaWtg/640?wx_fmt=png "")  
  
随后进入com.opensymphony.xwork.ActionChainResult#execute函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZFjLDp6XXoytA7wjfUWiamH0ClXsE60MsARWFEMnGpEfNTB2ian9n42Ww/640?wx_fmt=png "")  
  
这里通过getNamespace获取namespace的值，前面我们已经分析出来：namespace的取值为请求servletPath最后一个/之前的部分。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZ9Kg0BHNpdmggDLwqxoiaTpQo2lS5vfp3lPIjNma6VTficONADMlk32NA/640?wx_fmt=png "")  
  
继续跟进，在com.opensymphony.xwork.ActionChainResult中，会调用translateVariables函数对OGNL表达式进行解析，表达式的值为namespace的取值。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZjgDrePialfS6VW9oKicSbdsc994Xg4RCUtMLMqOQnw5yzFOS9OG69Pwg/640?wx_fmt=png "")  
  
在com.opensymphony.xwork.util.TextParseUtil#translateVariables中。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZWZicR8VDXaVywIE7hJsPH3ia0e2Ak54QRyt4UiaCFL2mQPhP8q7p3m7lg/640?wx_fmt=png "")  
  
调用了com.opensymphony.xwork.util.OgnlValueStack#findValue函数对表达式进行解析。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZqicK3ibJjGo7C8cqXoC5mqdqe2aU09c4Myg3IDDXhWvO5teym0HVLBWw/640?wx_fmt=png "")  
  
一系列操作之后，findValue返回的字符串为16。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZibp9KXJjfMPDKN8SBeY4UPKYjwQlS9sddY75SxfLBWTVz8p8dHH2jLg/640?wx_fmt=png "")  
  
成功触发 OGNL 表达式注入。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NQhUPnjTPRQibWowFO2VHuZuicvwAX7JVhJSQaI9upVh3Rg4VpF8sv7If6P3zpDkCiaiaibKoaII1TBzA/640?wx_fmt=png "")  
  
**修复建议**  
  
建议升级到Atlassian Confluence Server and Data Center至安全版本。  
  
下载链接：  
  
https://www.atlassian.com/software/confluence/download-archives  
  
**沙箱绕过**  
  
从 v7.15 系列开始，Confluence 在 OGNL 表达式解析时加入了沙箱限制，采取了黑名单、白名单等方式。  
  
绕过的技巧：白名单（限制为静态方法调用）中，仍然有一些静态方法可绕过沙箱限制或者沙箱本身逻辑上也存在相关缺陷可实现方法调用。  
  
**参考材料**  
  
1. https://www.little2pig.work/archives/cve-2022-26134  
  
2. https://my.atlassian.com/products/index  
  
3. https://attackerkb.com/topics/BH1D56ZEhs/cve-2022-26134/rapid7-analysis  
  
4. https://cve.mitre.org/cgi-bin/cvename.cgi?name=2022-26134  
  
5. https://www.tarlogic.com/blog/cve-2022-26134-zero-day-vulnerability-affecting-atlassian-confluence/  
  
**更多技术干货，欢迎关注“星阑PortalLab”公众号**  
  
  
  
**关于Portal Lab**  
  
  
星阑科技 Portal Lab 致力于前沿安全技术研究及能力工具化。主要研究方向为API 安全、应用安全、攻防对抗等领域。实验室成员研究成果曾发表于BlackHat、HITB、BlueHat、KCon、XCon等国内外知名安全会议，并多次发布开源安全工具。未来，Portal Lab将继续以开放创新的态度积极投入各类安全技术研究，持续为安全社区及企业级客户提供高质量技术输出。  
  
  
**往期 · 推荐**  
  
  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492888&idx=1&sn=219ad26c37836f5cdefc5f41dea620c0&chksm=c0074884f770c192f60f651f3e0c6a0f293b38a59d9499a89cd1b9c2e2d8cbc4dd4620783ed1&scene=21#wechat_redirect)  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492771&idx=1&sn=5bc86cbf62a83db69b1b1919ad86273b&chksm=c007493ff770c0290f199daef6b03bd09f9f85e35c5179c3ca8fe062623ecc27522b45850f0a&scene=21#wechat_redirect)  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492691&idx=1&sn=7f4fdf863953280d024c2ae7144badff&chksm=c00749cff770c0d98d9848f5415e2c7b395add84d39e4ab51172549c024d36cfc80af23ad43e&scene=21#wechat_redirect)  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492617&idx=1&sn=103b4a185c02f1435ddcc1778bd038e6&chksm=c0074995f770c08374efe7cda4e53a8991a867e2b1b73fe05f0f4a32335756a56c77483ee75f&scene=21#wechat_redirect)  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOehwcHoxicoOah5mxDjLHMZ9RHUxNeibERphRXOj3AEupxt7JyOt3LF1RmmWQibYmicTv2DxM93iaEJhLxw/640?wx_fmt=gif "")  
