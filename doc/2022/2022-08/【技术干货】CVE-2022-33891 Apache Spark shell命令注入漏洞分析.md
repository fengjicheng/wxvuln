#  【技术干货】CVE-2022-33891 Apache Spark shell命令注入漏洞分析   
 星阑科技   2022-08-02 11:12  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOeiaFHTFtiatmEIxZQcXOHfyr6GOBM88IeMm28ybjSAHEJKicuQxPxN5L5NFZ5mza2NOnuokf9ant2fUQ/640?wx_fmt=gif "")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLKWSxBUmsxRCOqbNibhhXFuhtfXiak5ibYGMcEGD9yzzIy4qVq1Q5a63IQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1NSkNgX8voWSJmuSUlcQtsLgZE9TXJrsxHuabVS0UbocSyplzJJ0pxtQQZpAzIBdZwlByjZ3qUUAQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "好看的图.png")  
  
**xxhzz**  
  
**@PortalLab实验室**  
  
**漏洞描述**  
  
7月18号，Apache发布安全公告，修复了一个Apache Spark中存在的命令注入漏洞。漏洞编号：CVE-2022-33891，漏洞威胁等级：高危。Apache Spark UI提供了通过配置选项Spark .acl .enable启用acl的可能性。使用身份验证过滤器，这将检查用户是否具有查看或修改应用程序的访问权限。如果启用了acl, HttpSecurityFilter中的代码路径可以允许某人通过提供任意用户名来执行模拟。 恶意用户可能能够访问权限检查功能，该功能最终将根据他们的输入构建一个 Unix shell 命令并执行它。这将导致任意 shell 命令执行。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8b5At1tJUxr1mh3vbG9rOvuHMXoRXictrYfcwe1QMYkqs8f1ibrGicwkOPA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
**相关介绍**  
  
Apache Spark是美国阿帕奇（Apache）软件基金会的一款支持非循环数据流和内存计算的大规模数据处理引擎。Spark优点在于能更好地适用于数据挖掘与机器学习等需要迭代的MapReduce的算法。  
  
**利用范围**  
  
Spark Core - Apache  <=3.0.3  
  
3.1.1 <= Spark Core - Apache <=3.1.2  
  
3.2.0 <= Spark Core - Apache <=3.2.1  
  
**漏洞分析**  
  
**环境搭建**  
  
在官网（https://archive.apache.org/dist/spark）下载Apache Spark 3.2.1版本进行漏洞复现分析。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bvclRWRKhsUOlgFO66d8tXsiaaopq2tXYwLSgh4XxHqLUt5AhtwXVFqg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
漏洞触发的关键在于是否启用ACL，使用身份验证过滤器。  
  
启用ACL的两种方式：  
  
1、通过设置选项 spark.acls.enable 启用 。  
  
2、运行spark-shell时，通过-c参数启动。  
  
为更好分析漏洞，在运行spark-shell前，需在其中进行远程调试配置  
  
export SPARK_SUBMIT_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bKHIRXWaW4OFxVicnFAIRWtT1CeEicNqKrzme56X3Pg9Cm9ibP3f7Eic6gw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
配置完成后运行spark-shell，并开启ACL  
  
./spark-shell --conf spark.acls.enable=true  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bBI8uzF2lsm5794atCkhkROuibKVIrqnjPn7K6oSrapwhToU3QWomakg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
## 漏洞原理  
  
根据diff（https://github.com/apache/spark/pull/36315/files）分析。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bKn4RKktTEZPic9sEfpicOicLOSTPzib4RhtpGSmaI4WqN6DMBibGhvCGN4A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
如上所示，使用命令拼接且没有做任何处理，而在修复的版本中直接删除了ShellBasedGroupsMappingProvider函数中对bash的调用。  
## 动态分析  
  
了解漏洞原理之后，就该考虑如何触发漏洞。  
  
在Apache  spark启用ACL后，会通过HttpSecurityFilter这个filter进行权限的校验。  
  
首先将断点打在org.apache.spark.ui.HttpSecurityFilter#doFilter函数处。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bG6CqYogn80GtypXLiaiaIEVRrt2K28bic0RwbYP3YYEicC7Cql755lGTaw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
在进入doFilter函数之后，首先会提取参数“doAs”的值，然后赋值给effectiveUser，进入org.apache.spark.SecurityManager#checkUIViewPermissions函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bT4HaSB62t8QMdvFUvRNC2ksnz5X3DhdKzfJnIS3CsTAA5QRsLKpvcA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
后续跟进一系列函数进行处理。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bkrhRmW11PeMt7iaRyeSpB3grqsj4e60gOBzcqnFiccic5hR4drncpzwrQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
进入org.apache.spark.security.ShellBasedGroupsMappingProvider#getGroups函数时，username为传入参数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bFF5sChtlEBnlb1jKTpnAWB71SNdNFFUzPqqsm2kOQaiaQ1BbcrMy4Iw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
随后进入org.apache.spark.security.ShellBasedGroupsMappingProvider#getUnixGroups函数。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bS3C0TskcQzKaVCaV8pPNxDvGVzUPVqYyuzp8hfoZibAmRVPdQa9qSHw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
在这里username进行了拼接处理，因为我们传入的username参数可控，便形成了命令注入。  
  
后续将通过executeAndGetOutput函数直接触发传入的命令，造成命令执行。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bQYq2H7L9ASiaYxnZVdC3hBgWKWibgrTgQTOXkJH8NfIV54aSPz9iaSfuw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
## 漏洞复现  
  
通过反单引号和参数“doAs”成功命令注入。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/wfFYMXc5G1MLKAeOwWmCuefpdCQ0qD8bQjdpia11J6sGrpp393rb7bpibPxbF8XZ44y5OyqAxvrXYLzm8Dbp3t7w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
**修复建议**  
  
建议受影响的用户升级到安全版本：Apache Spark 3.1.3、3.2.2 或 3.3.0 或更高版本。  
  
**参考材料**  
  
1.https://lists.apache.org/thread/p847l3kopoo5bjtmxrcwk21xp6tjxqlc  
  
2.https://archive.apache.org/dist/spark/  
  
3.https://github.com/apache/spark/pull/36315/files  
  
**更多技术干货，欢迎关注“星阑PortalLab”公众号**  
  
****  
  
  
**关于Portal Lab**  
  
星阑科技 Portal Lab 致力于前沿安全技术研究及能力工具化。主要研究方向为API 安全、应用安全、攻防对抗等领域。实验室成员研究成果曾发表于BlackHat、HITB、BlueHat、KCon、XCon等国内外知名安全会议，并多次发布开源安全工具。未来，Portal Lab将继续以开放创新的态度积极投入各类安全技术研究，持续为安全社区及企业级客户提供高质量技术输出。  
  
  
**往期 · 推荐**  
  
  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492888&idx=1&sn=219ad26c37836f5cdefc5f41dea620c0&chksm=c0074884f770c192f60f651f3e0c6a0f293b38a59d9499a89cd1b9c2e2d8cbc4dd4620783ed1&scene=21#wechat_redirect)  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492771&idx=1&sn=5bc86cbf62a83db69b1b1919ad86273b&chksm=c007493ff770c0290f199daef6b03bd09f9f85e35c5179c3ca8fe062623ecc27522b45850f0a&scene=21#wechat_redirect)  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492691&idx=1&sn=7f4fdf863953280d024c2ae7144badff&chksm=c00749cff770c0d98d9848f5415e2c7b395add84d39e4ab51172549c024d36cfc80af23ad43e&scene=21#wechat_redirect)  
  
[](http://mp.weixin.qq.com/s?__biz=Mzg5NjEyMjA5OQ==&mid=2247492617&idx=1&sn=103b4a185c02f1435ddcc1778bd038e6&chksm=c0074995f770c08374efe7cda4e53a8991a867e2b1b73fe05f0f4a32335756a56c77483ee75f&scene=21#wechat_redirect)  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Cc8QqLUKOehwcHoxicoOah5mxDjLHMZ9RHUxNeibERphRXOj3AEupxt7JyOt3LF1RmmWQibYmicTv2DxM93iaEJhLxw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1 "")  
