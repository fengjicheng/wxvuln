#  Windows UAF 漏洞CVE-2021-34486分析   
原创 信创安全实验室  山石网科安全技术研究院   2022-06-30 10:48  
  
Windows事件跟踪 (ETW) 机制允许记录内核或应用程序定义的事件以进行调试。开发人员能够启动和停止事件跟踪会话，检测应用程序以提供跟踪事件，并通过调用 ETW 用户模式 Windows API 集来使用跟踪事件。最终的请求部分都是在内核 (ntoskrnl.exe) 模块中完成。由于该功能存在于ntoskrnl.exe，部分功能可以在沙箱中访问到，尤其受攻击者关注。  
  
  
在  
﻿EtwpUpdatePeriodicCaptureState 函数中，存在UAF漏洞，攻击者能够可控地分配一个 0x30 字节的缓冲区，释放它并随后重用该内存来执行任意代码。  
  
  
我们可以通过  
NtTraceControl  
 系统调用来触发  
﻿ ﻿EtwpUpdatePeriodicCaptureState   
函数，输入的buffer结构如下：  
  
<table><tbody><tr><td width="414" valign="top" style="border: 1pt solid windowtext;padding: 0cm 5.4pt;"><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-size: 10.5pt;font-family: 宋体;letter-spacing: 1px;">typedef struct _ETW_UPDATE_PERIODIC_CAPTURE_STATE</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-size: 10.5pt;font-family: 宋体;letter-spacing: 1px;">{</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-size: 10.5pt;font-family: 宋体;letter-spacing: 1px;">  ULONG     LoggerId;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-size: 10.5pt;font-family: 宋体;letter-spacing: 1px;">  ULONG     DueTime;    //system time units (100-nanosecond intervals)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-size: 10.5pt;font-family: 宋体;letter-spacing: 1px;">  ULONG     NumOfGuids;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-size: 10.5pt;font-family: 宋体;letter-spacing: 1px;">  GUID Guids[ANYSIZE_ARRAY];</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-size: 10.5pt;font-family: 宋体;letter-spacing: 1px;">} ETW_UPDATE_PERIODIC_CAPTURE_STATE, * PETW_UPDATE_PERIODIC_CAPTURE_STATE;</span></p></td></tr></tbody></table>  
  
触发UAF需要3个步骤，下面我们具体来分析：  
  
  
第一个请求中，ntoskrnl执行了这些操作，首先通过用户传入的id来获取相应的  
﻿  
EtwpLoggerContext  
对象，同时回去验证用户传入的Guid数组是否具有  
﻿  
0x80 访问权限。随后调用   
﻿  
ExAllocateTimer  
函数创建一个定时器，定时器超时的回调函数是  
﻿  
PeriodicCaptureStateTimerCallback  
，回调函数的参数类型是  
﻿  
_WORK_QUEUE_ITEM  
，你可以在msdn中找到具体定义，随后定时器被激活，等待超时时间到达后触发回调函数。  
  
<table><tbody><tr><td width="414" valign="top" style="border: 1pt solid windowtext;padding: 0cm 5.4pt;word-break: break-all;"><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">__int64 __fastcall EtwpUpdatePeriodicCaptureState(unsigned int LoggerId, unsigned int DueTime, unsigned __int16 NumOfGuids, GUID *Guids)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">{</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">      // 如果没有定时器存在则直接创建定时器</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      if ( !LoggerContext_-&gt;ExTimerObject )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">         TimerContextInfo = (CONTEXTINFO *)ExAllocatePoolWithTag(NonPagedPoolNx, 0x30ui64, &#39;UwtE&#39;); // 创建回调函数参数，类型为_WORK_QUEUE_ITEM</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         TimerContextInfo_ = TimerContextInfo;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         if ( !TimerContextInfo )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            goto RETURN_ERROR_C0000017;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         TimerContextInfo-&gt;LoggerId = LoggerId;//InBuff1.LoggerId</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         TimerContextInfo-&gt;Unknown = v22;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">         TimerContextInfo-&gt;WorkItem.WorkerRoutine = SendCaptureStateNotificationsWorker;   // worker的回调函数</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">         TimerContextInfo-&gt;WorkItem.Parameter = TimerContextInfo;         // worker回调函数的参数，也就是SendCaptureStateNotificationsWorker的参数</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         TimerContextInfo-&gt;WorkItem.List.Flink = 0i64;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">         LoggerContext_-&gt;ExTimerObject = ExAllocateTimer((PEXT_CALLBACK)PeriodicCaptureStateTimerCallback, TimerContextInfo, 8u); // 保存定时器</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      ExTimerObject = (PEX_TIMER)LoggerContext_-&gt;ExTimerObject;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      LoggerContext_-&gt;DueTime = 0xFFFFFFFFFF676980ui64 * DueTime;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">      ExSetTimer((ULONG_PTR)ExTimerObject);     // 超时时间以秒计算，为负数</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      LODWORD(LoggerContext_-&gt;ExTimerState) = 1;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      goto RETURN_1;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">RETURN_1:</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   if ( (_InterlockedExchangeAdd64(pLock, 0xFFFFFFFFFFFFFFFFui64) &amp; 6) == 2 )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      ExfTryToWakePushLock(pLock);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   KeAbPostRelease((ULONG_PTR)pLock);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">RETURN_2:</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   EtwpReleaseLoggerContext(LoggerContext_, 0i64);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   return (unsigned int)res_EtwpCheckNotificationAccess;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">}</span></p></td></tr></tbody></table>  
最终在  
PeriodicCaptureStateTimerCallback  
函数中会去调用  
﻿  
ExQueueWorkItem  
函数将  
_WORK_QUEUE_ITEM  
放入系统队列中，然后最后调用  
﻿  
SendCaptureStateNotificationsWorker  
函数。  
  
  
在第二个请求中，我们可以传入一些当前用户没有权限访问的Guid，这样就会触发如下流程：  
<table><tbody><tr><td width="414" valign="top" style="border: 1pt solid windowtext;padding: 0cm 5.4pt;"><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">__int64 __fastcall EtwpUpdatePeriodicCaptureState(unsigned int LoggerId, unsigned int DueTime, unsigned __int16 NumOfGuids, GUID *Guids)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"> {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"> FREE_POOLS_AND_RESET:</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        GuidsPool = (void *)LoggerContext_-&gt;GuidsPool;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        if ( GuidsPool )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            ExFreePoolWithTag(GuidsPool, 0);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            LoggerContext-&gt;GuidsPool = 0i64;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            LOWORD(LoggerContext-&gt;NumOfGuids) = 0;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     if ( (_DWORD)NumOfGuids_ )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">        while ( 1 )  // 循环判断用户传入的guid是否具有访问权限，如果有一个不满足就进入FREE_POOLS_AND_RESET分支</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            res_EtwpCheckNotificationAccess = EtwpCheckNotificationAccess(</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                                                &amp;Guids[v4].Data1,</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                                                (__int64)&amp;LoggerContext_-&gt;field_0[0x124]);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            if ( res_EtwpCheckNotificationAccess &lt; 0 )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">               break;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            if ( ++v4 &gt;= (int)NumOfGuids_ )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">               goto ALL_GUIDS_HAVE_NOTIFICATION_ACCESS_OK;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        res_EtwpCheckNotificationAccess = 0xC0000022;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        v8 = 0;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        goto FREE_POOLS_AND_RESET;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"> ALL_GUIDS_HAVE_NOTIFICATION_ACCESS_OK:</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"> }</span></p></td></tr></tbody></table>  
  
<table><tbody><tr><td width="414" valign="top" style="border: 1pt solid windowtext;padding: 0cm 5.4pt;"><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">void __fastcall SendCaptureStateNotificationsWorker(CONTEXTINFO *TimerContextInfo)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">{</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   if ( TimerContextInfo )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     LoggerContext = (LOGGERCONTEXT *)EtwpAcquireLoggerContextByLoggerId(</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                                     TimerContextInfo-&gt;Unknown,</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                                     LOWORD(TimerContextInfo-&gt;LoggerId),</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                                     0);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     if ( LoggerContext )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        pLock = &amp;LoggerContext-&gt;Lock;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        ExAcquirePushLockExclusiveEx((ULONG_PTR)&amp;LoggerContext-&gt;Lock, 0i64);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        LODWORD(LoggerContext__-&gt;ExTimerState) = 0;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        if ( *(_DWORD *)&amp;LoggerContext__-&gt;field_0[336] )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">            // 在第二个请求中我们已经将这个数量设置为空，所以后面会进入LABEL_31分支</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            NumOfGuids = LOWORD(LoggerContext__-&gt;NumOfGuids);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            if ( (_WORD)NumOfGuids )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                if ( (int)EtwpBuildNotificationPacket(v10, v23, v15, &amp;v19) &gt;= 0 )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                     EtwpSendDataBlock(v12, v19);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                     EtwpUnreferenceDataBlock(v19);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                if ( LOWORD(LoggerContext__-&gt;NumOfGuids) &amp;&amp; !LODWORD(LoggerContext__-&gt;ExTimerState) )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                   ExSetTimer(LoggerContext__-&gt;ExTimer);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                   LODWORD(LoggerContext__-&gt;ExTimerState) = 1;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                   v2 = 1;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        if ( (_InterlockedExchangeAdd64(pLock, 0xFFFFFFFFFFFFFFFFui64) &amp; 6) == 2 )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            ExfTryToWakePushLock(pLock);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        KeAbPostRelease((ULONG_PTR)pLock);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        EtwpReleaseLoggerContext(LoggerContext__, 0i64);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">        if ( v2 )          // 这里没有进入上面分支所以不会设置为0</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            return;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        goto LABEL_31;     // </span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">     }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">   // 最终释放了之前的WORK_QUEUE_ITEM参数</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">LABEL_31:</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   ExFreePoolWithTag(TimerContextInfo, 0);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">}</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p></td></tr></tbody></table>  
  
在我们第一步的syscall创建的定时器超时前，在第二个syscall调用操作中我们将  
LoggerContext->NumOfGuids   
设置为0，导致回调函数超时的时候释放了  
WORK_QUEUE_ITEM   
。  
  
  
在第三步的操作中，我们还需要再次重复第一步的操作，由于定时器已经存在，在判断  
LoggerContext_->ExTimerObject   
不为空后，不会再创建  
WORK_QUEUE_ITEM  
对象了，所以之前第一步创建的参数仍然还会被再次使用，而这个时候其实回调函数的参数已经是一个被释放的内存了，不应该被再次引用，后面的一系列操作就会导致UAF的发生。  
  
  
- ## 漏洞修复  
  
这个漏洞可以认为是设计不当而导致的，一开始以为是定时器使用不当导致的，但是看过分析后发现没有那么简单，大概率是开发人员对定时器的操作编程理解不够透彻，在传入定时器超时的参数中不应该使用一个生命周期不明确的对象，必须对此类对象的使用格外的小心，猜测修复的逻辑中也要对这里的逻辑进行重新设计，后来看了修复的代码也差不多能验证自己的猜想，看看修复后的代码，我们可以看到传入定时器回调函数的参数都发生了变化，变成了  
LoggerContext  
，没有传递  
CallbackContext  
，这样这个对象就不会存在释放后重用了，同时也没有再对  
LoggerContext->NumOfGuids  
进行操作：  
  
<table><tbody><tr><td width="414" valign="top" style="border: 1pt solid windowtext;padding: 0cm 5.4pt;word-break: break-all;"><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">__int64 __fastcall EtwpUpdatePeriodicCaptureState(unsigned int LoggerId, unsigned int DueTime, unsigned __int16 NumOfGuids, GUID *Guids)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">{</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   ExAcquirePushLockExclusiveEx(EtwpLoggerContext1 + 688, 0i64);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">   CallbackContext1 = *(_QWORD *)(EtwpLoggerContext1 + 1080);        // 取出之前创建的Context</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">   if ( CallbackContext1 )                                           // 如果存在了CallbackContext则进入</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      goto LABEL_31;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   if ( !(_WORD)v4 )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      LABEL_24:</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      if ( (_InterlockedExchangeAdd64((volatile signed __int64 *)(EtwpLoggerContext1 + 688), 0xFFFFFFFFFFFFFFFFui64) &amp; 6) == 2)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">        ExfTryToWakePushLock(EtwpLoggerContext1 + 688);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      KeAbPostRelease(EtwpLoggerContext1 + 688);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      goto LABEL_27;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   CallbackContext = ExAllocatePool2(64i64, 72i64, 0x55777445i64);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">   // 设置LoggerContext+1080位置为创建的CallbackContext</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   *(_QWORD *)(EtwpLoggerContext1 + 1080) = CallbackContext;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   CallbackContext1 = CallbackContext;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   Pool2 = (void *)ExAllocatePool2(256i64, 16 * v4, 0x55777445i64);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   *(_QWORD *)(CallbackContext1 + 24) = Pool2;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   if ( Pool2 )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      *(_WORD *)(CallbackContext1 + 16) = v4;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      memmove(Pool2, (const void *)InputBuffer_kernel_C, 16 * v4);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      if ( !*(_QWORD *)(CallbackContext1 + 8) )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">         // 回调函数的参数变成了LoggerContext</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         Timer = ExAllocateTimer((__int64)PeriodicCaptureStateTimerCallback, EtwpLoggerContext1, 8u);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         *(_QWORD *)(CallbackContext1 + 8) = Timer;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         if ( !Timer )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            ExFreePoolWithTag(*(PVOID *)(CallbackContext1 + 24), 0);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            *(_QWORD *)(CallbackContext1 + 24) = 0i64;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            *(_WORD *)(CallbackContext1 + 16) = 0;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">            goto LABEL_11;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         *(_QWORD *)(CallbackContext1 + 56) = EtwpLoggerContext1;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         *(_QWORD *)(CallbackContext1 + 48) = SendCaptureStateNotificationsWorker;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">         *(_QWORD *)(CallbackContext1 + 32) = 0i64;         // WORK_QUEUE_ITEM 的开始位置</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      *((_QWORD *)&amp;v21 + 1) = 0xFFFFFFFFFFFFFFFFui64;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      v17 = *(_QWORD *)(CallbackContext1 + 8);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      v18 = 0xFFFFFFFFFF676980ui64 * a2;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      *(_QWORD *)CallbackContext1 = v18;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      ExSetTimer(v17, v18, 0i64, (__int64)&amp;v21);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      *(_DWORD *)(CallbackContext1 + 64) = 1;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">      goto LABEL_24;</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">   ...</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">}</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;"><o:p> </o:p></span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">void __fastcall PeriodicCaptureStateTimerCallback(__int64 Timer, __int64 EtwpLoggerContext)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">{</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">  if ( ExAcquireRundownProtectionCacheAwareEx(</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         *(PEX_RUNDOWN_REF_CACHE_AWARE *)(*(_QWORD *)(*(_QWORD *)(EtwpLoggerContext + 1096) + 448i64)</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">                                        + 8i64 * *(unsigned int *)EtwpLoggerContext),</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">         1u) )</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">  {</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="letter-spacing: 1px;font-family: 宋体;">    // EtwpLoggerContext + 1080 就是CallbackContext，+32位置就是WORK_QUEUE_ITEM 的开始位置</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">    ExQueueWorkItem((PWORK_QUEUE_ITEM)(*(_QWORD *)(EtwpLoggerContext + 1080) + 32i64), NormalWorkQueue);</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">  }</span></p><p style="text-align: left;margin: 0cm 8px;font-size: 12pt;font-family: DengXian;line-height: 1.75em;"><span style="font-family: 宋体;letter-spacing: 1px;">}</span></p></td></tr></tbody></table>  
- ## 参考链接  
  
https://www.pixiepointsecurity.com/blog/advisory-cve-2021-34486.html  
  
  
